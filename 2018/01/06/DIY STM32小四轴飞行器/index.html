<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>DIY STM32小四轴飞行器 | Tangle</title><meta name="keywords" content="STM32"><meta name="author" content="Tangle"><meta name="copyright" content="Tangle"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="飞机部分  硬件设计  电源设计   STM32主控   MPU6050   电机控制   蓝牙、2.4G   其他模块   BOM表    Comment Description Designator Footprint Quantity Value     CAP 0603电容 C1, C2, C3, C4, C5,  C9, C10, C11, C16, C17, C18, C19 C_0">
<meta property="og:type" content="article">
<meta property="og:title" content="DIY STM32小四轴飞行器">
<meta property="og:url" content="https://letanga.github.io/2018/01/06/DIY%20STM32%E5%B0%8F%E5%9B%9B%E8%BD%B4%E9%A3%9E%E8%A1%8C%E5%99%A8/index.html">
<meta property="og:site_name" content="Tangle">
<meta property="og:description" content="飞机部分  硬件设计  电源设计   STM32主控   MPU6050   电机控制   蓝牙、2.4G   其他模块   BOM表    Comment Description Designator Footprint Quantity Value     CAP 0603电容 C1, C2, C3, C4, C5,  C9, C10, C11, C16, C17, C18, C19 C_0">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/08/6ltOC8.jpg">
<meta property="article:published_time" content="2018-01-06T08:26:19.000Z">
<meta property="article:modified_time" content="2021-03-10T03:41:55.571Z">
<meta property="article:author" content="Tangle">
<meta property="article:tag" content="STM32">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.ax1x.com/2021/03/08/6ltOC8.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://letanga.github.io/2018/01/06/DIY%20STM32%E5%B0%8F%E5%9B%9B%E8%BD%B4%E9%A3%9E%E8%A1%8C%E5%99%A8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'DIY STM32小四轴飞行器',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-10 11:41:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><style type="text/css">#toggle-sidebar {bottom: 80px}</style><meta name="generator" content="Hexo 5.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://s1.ax1x.com/2020/05/01/Jje1fS.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Tangle</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">DIY STM32小四轴飞行器</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2018-01-06T08:26:19.000Z" title="undefined 2018-01-06 16:26:19">2018-01-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/STM32/">STM32</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">19.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>97分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="DIY STM32小四轴飞行器"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="飞机部分"><a class="markdownIt-Anchor" href="#飞机部分"></a> 飞机部分</h2>
<h3 id="硬件设计"><a class="markdownIt-Anchor" href="#硬件设计"></a> 硬件设计</h3>
<h4 id="电源设计"><a class="markdownIt-Anchor" href="#电源设计"></a> 电源设计</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6GUBtA"><img src="https://s3.ax1x.com/2021/03/10/6GUBtA.jpg" alt="6GUBtA.jpg" /></a></p>
<h4 id="stm32主控"><a class="markdownIt-Anchor" href="#stm32主控"></a> STM32主控</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6GNHdH"><img src="https://s3.ax1x.com/2021/03/10/6GNHdH.jpg" alt="6GNHdH.jpg" /></a></p>
<h4 id="mpu6050"><a class="markdownIt-Anchor" href="#mpu6050"></a> MPU6050</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6GUW7Q"><img src="https://s3.ax1x.com/2021/03/10/6GUW7Q.jpg" alt="6GUW7Q.jpg" /></a></p>
<h4 id="电机控制"><a class="markdownIt-Anchor" href="#电机控制"></a> 电机控制</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6GaZ4A"><img src="https://s3.ax1x.com/2021/03/10/6GaZ4A.jpg" alt="6GaZ4A.jpg" /></a></p>
<h4 id="蓝牙-24g"><a class="markdownIt-Anchor" href="#蓝牙-24g"></a> 蓝牙、2.4G</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6GaJ4s"><img src="https://s3.ax1x.com/2021/03/10/6GaJ4s.jpg" alt="6GaJ4s.jpg" /></a></p>
<h4 id="其他模块"><a class="markdownIt-Anchor" href="#其他模块"></a> 其他模块</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6GarE4"><img src="https://s3.ax1x.com/2021/03/10/6GarE4.jpg" alt="6GarE4.jpg" /></a></p>
<h4 id="bom表"><a class="markdownIt-Anchor" href="#bom表"></a> BOM表</h4>
<table>
<thead>
<tr>
<th>Comment</th>
<th>Description</th>
<th>Designator</th>
<th>Footprint</th>
<th>Quantity</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>CAP</td>
<td>0603电容</td>
<td>C1, C2, C3, C4, C5,  C9, C10, C11, C16, C17, C18, C19</td>
<td>C_0603</td>
<td>12</td>
<td>100nF</td>
</tr>
<tr>
<td>CAP</td>
<td>0603电容</td>
<td>C6, C7</td>
<td>C_0603</td>
<td>2</td>
<td>22pF</td>
</tr>
<tr>
<td>Cap</td>
<td>0603电容</td>
<td>C8</td>
<td>C_0603</td>
<td>1</td>
<td>2.2nF</td>
</tr>
<tr>
<td>47uF</td>
<td>1206钽电容</td>
<td>C12, C13, C20</td>
<td>C_1206</td>
<td>3</td>
<td>100pF</td>
</tr>
<tr>
<td>CAP</td>
<td>0603电容</td>
<td>C14, C15, C21</td>
<td>C_0603</td>
<td>3</td>
<td>100nF</td>
</tr>
<tr>
<td>S4</td>
<td>二极管</td>
<td>D1, D2</td>
<td>SOD-123</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>DC4.2V</td>
<td>2p排针</td>
<td>JP1</td>
<td>SIP2</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>MSS22D18</td>
<td>6p贴片拨动开关</td>
<td>KG1</td>
<td>MSS22D18</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>Inductor Chip</td>
<td>CD32电感</td>
<td>L1</td>
<td>47UH_3*3 150MA</td>
<td>1</td>
<td>33UH</td>
</tr>
<tr>
<td>蓝灯</td>
<td>发光二极管</td>
<td>LED1, LED3</td>
<td>0603_LED_S1</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>红灯</td>
<td>发光二极管</td>
<td>LED2, LED4</td>
<td>0603_LED_S1</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Header 2</td>
<td>焊接电机用，不用器件</td>
<td>MOTO1, MOTO2, MOTO3,  MOTO4</td>
<td>SIP2D - duplicate</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>NRF24L01</td>
<td>2.4G模块</td>
<td>NRF1</td>
<td>24L01</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>串口</td>
<td>4p排针</td>
<td>P1</td>
<td>SIP4 - duplicate</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>IIC</td>
<td>4p排针</td>
<td>P2</td>
<td>SIP4 - duplicate</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>SW下载</td>
<td>4p排针</td>
<td>P3</td>
<td>SIP4 - duplicate</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>Header 4</td>
<td>4p排针</td>
<td>P4</td>
<td>SIP4 - duplicate</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>SI2302</td>
<td>SI2302场效应管</td>
<td>Q1, Q2, Q3, Q4</td>
<td>SOT-23(SOT-23-3)</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>Res2</td>
<td>0603电阻</td>
<td>R1</td>
<td>R0603</td>
<td>1</td>
<td>10K</td>
</tr>
<tr>
<td>Res2</td>
<td>0603电阻</td>
<td>R2, R3, R7, R9, R11,  R13</td>
<td>R0603</td>
<td>6</td>
<td>10K</td>
</tr>
<tr>
<td>Res2</td>
<td>0603电阻</td>
<td>R4, R5, R6, R8, R10,  R12, R14, R15</td>
<td>R0603</td>
<td>8</td>
<td>1K</td>
</tr>
<tr>
<td>STM32F103C8T6_LQFP48</td>
<td>STM32F103C8T6_LQFP48</td>
<td>U1</td>
<td>LQFP48_STM32</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>MPU6050</td>
<td>MPU6050</td>
<td>U2</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>BL8530</td>
<td>电源芯片</td>
<td>U3</td>
<td>SOT-89(SOT-89-3)</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>662K</td>
<td>LDO</td>
<td>U4</td>
<td>SOT-23-3L</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>BAT54A</td>
<td>BAT54A肖特基二极管</td>
<td>U5, U6, U7, U8</td>
<td>SOT-23(SOT-23-3)</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>XTAL</td>
<td>贴片晶振CSTCE8M00G55</td>
<td>Y1</td>
<td>CSTCE8M00G55</td>
<td>1</td>
<td>8M</td>
</tr>
</tbody>
</table>
<h3 id="软件设计"><a class="markdownIt-Anchor" href="#软件设计"></a> 软件设计</h3>
<p>main.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DEFINE.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;init.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2); <span class="comment">//2个bit的抢占优先级，2个bit的子优先级</span></span><br><span class="line">	ALL_Init();<span class="comment">//系统初始化</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ANTO_polling(); 	<span class="comment">//匿名上位机</span></span><br><span class="line">		LEDRefresh(); 			<span class="comment">//LED刷新</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>delay.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;misc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DATA.h&quot;</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">uint32_t</span> usTicks = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cycleCounterInit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RCC_ClocksTypeDef clocks;</span><br><span class="line">    RCC_GetClocksFreq(&amp;clocks);</span><br><span class="line">    usTicks = clocks.SYSCLK_Frequency / <span class="number">1000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">GetSysTime_us</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">register</span> <span class="keyword">uint32_t</span> ms, cycle_cnt;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ms = SysTick_count;</span><br><span class="line">        cycle_cnt = SysTick-&gt;VAL;</span><br><span class="line">    	&#125; <span class="keyword">while</span> (ms != SysTick_count);</span><br><span class="line">    <span class="keyword">return</span> (ms * <span class="number">1000</span>) + (usTicks * <span class="number">1000</span> - cycle_cnt) / usTicks;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    毫秒级延时函数	 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay_ms</span><span class="params">(<span class="keyword">uint16_t</span> nms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> t0=GetSysTime_us();</span><br><span class="line">	<span class="keyword">while</span>(GetSysTime_us() - t0 &lt; nms * <span class="number">1000</span>);	  	  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay_us</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"> </span>&#123;  </span><br><span class="line">	<span class="keyword">char</span> x=<span class="number">0</span>;   </span><br><span class="line">    <span class="keyword">while</span>( i--)</span><br><span class="line">    &#123;	</span><br><span class="line">       <span class="keyword">for</span>(x=<span class="number">1</span>;x&gt;<span class="number">0</span>;x--);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;		  </span><br></pre></td></tr></table></figure>
<p>Init.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DEFINE.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">uint32_t</span> SysTick_count; <span class="comment">//系统时间计数</span></span><br><span class="line">_st_Mpu MPU6050;   <span class="comment">//MPU6050原始数据</span></span><br><span class="line">_st_Mag AK8975;</span><br><span class="line">_st_AngE Angle;    <span class="comment">//当前角度姿态值</span></span><br><span class="line">_st_Remote Remote; <span class="comment">//遥控通道值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_st_ALL_flag ALL_flag; <span class="comment">//系统标志位，包含解锁标志位等</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PidObject pidRateX; <span class="comment">//内环PID数据</span></span><br><span class="line">PidObject pidRateY;</span><br><span class="line">PidObject pidRateZ;</span><br><span class="line"></span><br><span class="line">PidObject pidPitch; <span class="comment">//外环PID数据</span></span><br><span class="line">PidObject pidRoll;</span><br><span class="line">PidObject pidYaw;</span><br><span class="line"></span><br><span class="line">PidObject pidHeightRate;</span><br><span class="line">PidObject pidHeightHigh;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pid_param_Init</span><span class="params">(<span class="keyword">void</span>)</span></span>; <span class="comment">//PID控制参数初始化，改写PID并不会保存数据，请调试完成后直接在程序里更改 再烧录到飞控</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ALL_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cycleCounterInit();  <span class="comment">//得到系统每个us的系统CLK个数，为以后延时函数，和得到精准的当前执行时间使用</span></span><br><span class="line">	SysTick_Config(SystemCoreClock / <span class="number">1000</span>);	<span class="comment">//系统滴答时钟</span></span><br><span class="line">	IIC_Init();             <span class="comment">//I2C初始化</span></span><br><span class="line">	pid_param_Init();       <span class="comment">//PID参数初始化	 </span></span><br><span class="line">	LEDInit();              <span class="comment">//LED闪灯初始化</span></span><br><span class="line">	MpuInit();              <span class="comment">//MPU6050初始化	</span></span><br><span class="line">	USART3_Config();        <span class="comment">//上位机串口初始化</span></span><br><span class="line">	NRF24L01_init();				<span class="comment">//2.4G遥控通信初始化	</span></span><br><span class="line">	TIM2_PWM_Config();			<span class="comment">//4路PWM初始化	</span></span><br><span class="line">	TIM3_Config();					<span class="comment">//系统工作周期初始化 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pid_param_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pidRateX.kp = <span class="number">2.0f</span>;</span><br><span class="line">	pidRateY.kp = <span class="number">2.0f</span>;</span><br><span class="line">	pidRateZ.kp = <span class="number">4.0f</span>;</span><br><span class="line">	</span><br><span class="line">	pidRateX.ki = <span class="number">0.0f</span>;</span><br><span class="line">	pidRateY.ki = <span class="number">0.0f</span>;</span><br><span class="line">	pidRateZ.ki = <span class="number">0.0f</span>;	</span><br><span class="line">	</span><br><span class="line">	pidRateX.kd = <span class="number">0.08f</span>;</span><br><span class="line">	pidRateY.kd = <span class="number">0.08f</span>;</span><br><span class="line">	pidRateZ.kd = <span class="number">0.5f</span>;	</span><br><span class="line">	</span><br><span class="line">	pidPitch.kp = <span class="number">7.0f</span>;</span><br><span class="line">	pidRoll.kp = <span class="number">7.0f</span>;</span><br><span class="line">	pidYaw.kp = <span class="number">7.0f</span>;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IIC.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;i2c.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DEFINE.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> SUCCESS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUCCESS 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> FAILED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAILED  1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_delay</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c 延时函数</span></span><br><span class="line"><span class="comment"> * 入口参数: 无</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">I2c_delay</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> i = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (i)</span><br><span class="line">	i--;\</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_Init</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c  GPIO初始化</span></span><br><span class="line"><span class="comment"> * 入口参数: 无</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">IIC_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStrucSUCCESS;</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB  , ENABLE);</span><br><span class="line">		</span><br><span class="line">	GPIO_InitStrucSUCCESS.GPIO_Pin = SCL_PIN | SDA_PIN;</span><br><span class="line">	GPIO_InitStrucSUCCESS.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_InitStrucSUCCESS.GPIO_Mode = GPIO_Mode_Out_OD;</span><br><span class="line">	GPIO_Init(IIC_GPIO, &amp;GPIO_InitStrucSUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_Start</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c  起始信号</span></span><br><span class="line"><span class="comment"> * 入口参数: 无</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint8_t</span> <span class="title">I2c_Start</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SDA_H;</span><br><span class="line">	SCL_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	<span class="keyword">if</span> (!SDA_read)</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	SDA_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	<span class="keyword">if</span> (SDA_read)</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	SCL_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_Stop</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c  停止信号</span></span><br><span class="line"><span class="comment"> * 入口参数: 无</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">I2c_Stop</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SCL_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SDA_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SCL_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SDA_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_Ack</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c  产生应答信号</span></span><br><span class="line"><span class="comment"> * 入口参数: 无</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">I2c_Ack</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SCL_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SDA_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SCL_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SCL_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_NoAck</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c  产生NAck</span></span><br><span class="line"><span class="comment"> * 入口参数: 无</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">I2c_NoAck</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SCL_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SDA_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SCL_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SCL_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> *函数名称:	I2c_WaitAck</span></span><br><span class="line"><span class="comment"> *函数功能:	等待应答信号到来</span></span><br><span class="line"><span class="comment"> *返回值：   1，接收应答失败</span></span><br><span class="line"><span class="comment"> *           0，接收应答成功</span></span><br><span class="line"><span class="comment"> *******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint8_t</span> <span class="title">I2c_WaitAck</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SCL_L;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SDA_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	SCL_H;</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	I2c_delay();</span><br><span class="line">	<span class="keyword">if</span> (SDA_read) </span><br><span class="line">	&#123;</span><br><span class="line">		SCL_L;</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_SendByte</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c  发送一个字节数据</span></span><br><span class="line"><span class="comment"> * 入口参数: byte  发送的数据</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">I2c_SendByte</span><span class="params">(<span class="keyword">uint8_t</span> byte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint8_t</span> i = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">while</span> (i--) </span><br><span class="line">	&#123;</span><br><span class="line">		SCL_L;</span><br><span class="line">		I2c_delay();</span><br><span class="line">		<span class="keyword">if</span> (byte &amp; <span class="number">0x80</span>)</span><br><span class="line">			SDA_H;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			SDA_L;</span><br><span class="line">		byte &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">		I2c_delay();</span><br><span class="line">		SCL_H;</span><br><span class="line">		I2c_delay();</span><br><span class="line">		I2c_delay();</span><br><span class="line">		I2c_delay();</span><br><span class="line">	&#125;</span><br><span class="line">	SCL_L;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: I2c_ReadByte</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c  读取一个字节数据</span></span><br><span class="line"><span class="comment"> * 入口参数: 无</span></span><br><span class="line"><span class="comment"> * 返回值	 读取的数据</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint8_t</span> <span class="title">I2c_ReadByte</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint8_t</span> i = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">uint8_t</span> byte = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	SDA_H;</span><br><span class="line">	<span class="keyword">while</span> (i--) </span><br><span class="line">	&#123;</span><br><span class="line">		byte &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">		SCL_L;</span><br><span class="line">		I2c_delay();</span><br><span class="line">		I2c_delay();</span><br><span class="line">		SCL_H;</span><br><span class="line">		I2c_delay();</span><br><span class="line">		I2c_delay();</span><br><span class="line">		I2c_delay();</span><br><span class="line">		<span class="keyword">if</span> (SDA_read) </span><br><span class="line">		&#123;</span><br><span class="line">			byte |= <span class="number">0x01</span>;</span><br><span class="line">		&#125;</span><br><span class="line">   &#125;</span><br><span class="line">	SCL_L;</span><br><span class="line">	<span class="keyword">return</span> byte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称: i2cWriteBuffer</span></span><br><span class="line"><span class="comment"> * 函数功能: I2c       向设备的某一个地址写入固定长度的数据</span></span><br><span class="line"><span class="comment"> * 入口参数: addr,     设备地址</span></span><br><span class="line"><span class="comment"> *           reg，     寄存器地址</span></span><br><span class="line"><span class="comment"> *			 len，     数据长度</span></span><br><span class="line"><span class="comment"> *			 *data	   数据指针</span></span><br><span class="line"><span class="comment"> * 返回值	 1</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int8_t</span> <span class="title">IIC_Write_Bytes</span><span class="params">(<span class="keyword">uint8_t</span> addr,<span class="keyword">uint8_t</span> reg,<span class="keyword">uint8_t</span> *data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span> (I2c_Start() == FAILED)</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	I2c_SendByte(addr);</span><br><span class="line">	<span class="keyword">if</span> (I2c_WaitAck() == FAILED) </span><br><span class="line">	&#123;</span><br><span class="line">			I2c_Stop();</span><br><span class="line">			<span class="keyword">return</span> FAILED;</span><br><span class="line">	&#125;</span><br><span class="line">	I2c_SendByte(reg);</span><br><span class="line">	I2c_WaitAck();</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) </span><br><span class="line">	&#123;</span><br><span class="line">		I2c_SendByte(data[i]);</span><br><span class="line">		<span class="keyword">if</span> (I2c_WaitAck() == FAILED) </span><br><span class="line">		&#123;</span><br><span class="line">				I2c_Stop();</span><br><span class="line">				<span class="keyword">return</span> FAILED;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	I2c_Stop();</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int8_t</span> <span class="title">IIC_Read_One_Byte</span><span class="params">(<span class="keyword">uint8_t</span> addr,<span class="keyword">uint8_t</span> reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint8_t</span> recive = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (I2c_Start() == FAILED)</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	I2c_SendByte(addr);</span><br><span class="line">	<span class="keyword">if</span> (I2c_WaitAck() == FAILED) </span><br><span class="line">	&#123;</span><br><span class="line">		I2c_Stop();</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	&#125;</span><br><span class="line">	I2c_SendByte(reg);</span><br><span class="line">	I2c_WaitAck();</span><br><span class="line">	I2c_Stop();</span><br><span class="line">	I2c_Start();</span><br><span class="line">	I2c_SendByte(addr+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (I2c_WaitAck() == FAILED) </span><br><span class="line">	&#123;</span><br><span class="line">		I2c_Stop();</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	&#125;</span><br><span class="line">	recive = I2c_ReadByte();</span><br><span class="line">	I2c_NoAck();</span><br><span class="line">	I2c_Stop();</span><br><span class="line">	<span class="keyword">return</span> recive;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment"> *函数名称:	i2cWrite</span></span><br><span class="line"><span class="comment"> *函数功能:	写入指定设备 指定寄存器一个字节</span></span><br><span class="line"><span class="comment"> *入口参数： addr 目标设备地址</span></span><br><span class="line"><span class="comment"> *		     reg   寄存器地址</span></span><br><span class="line"><span class="comment"> *		     data 读出的数据将要存放的地址</span></span><br><span class="line"><span class="comment"> *******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int8_t</span> <span class="title">IIC_Write_One_Byte</span><span class="params">(<span class="keyword">uint8_t</span> addr,<span class="keyword">uint8_t</span> reg,<span class="keyword">uint8_t</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (I2c_Start() == FAILED)</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	I2c_SendByte(addr);</span><br><span class="line">	<span class="keyword">if</span> (I2c_WaitAck() == FAILED) </span><br><span class="line">	&#123;</span><br><span class="line">		I2c_Stop();</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	&#125;</span><br><span class="line">	I2c_SendByte(reg);</span><br><span class="line">	I2c_WaitAck();</span><br><span class="line">	I2c_SendByte(data);</span><br><span class="line">	I2c_WaitAck();</span><br><span class="line">	I2c_Stop();</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int8_t</span> <span class="title">IIC_read_Bytes</span><span class="params">(<span class="keyword">uint8_t</span> addr,<span class="keyword">uint8_t</span> reg,<span class="keyword">uint8_t</span> *data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (I2c_Start() == FAILED)</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	I2c_SendByte(addr);</span><br><span class="line">	<span class="keyword">if</span> (I2c_WaitAck() == FAILED) </span><br><span class="line">	&#123;</span><br><span class="line">		I2c_Stop();</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	&#125;</span><br><span class="line">	I2c_SendByte(reg);</span><br><span class="line">	I2c_WaitAck();</span><br><span class="line">	I2c_Stop();</span><br><span class="line">	I2c_Start();</span><br><span class="line">	I2c_SendByte(addr+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (I2c_WaitAck() == FAILED) </span><br><span class="line">	&#123;</span><br><span class="line">		I2c_Stop();</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (len) </span><br><span class="line">	&#123;</span><br><span class="line">		*data = I2c_ReadByte();</span><br><span class="line">		<span class="keyword">if</span> (len == <span class="number">1</span>)</span><br><span class="line">				I2c_NoAck();</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">				I2c_Ack();</span><br><span class="line">		data++;</span><br><span class="line">		len--;</span><br><span class="line">	&#125;</span><br><span class="line">	I2c_Stop();</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Usart.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;usart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;misc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 函数名：USART1_Config</span></span><br><span class="line"><span class="comment"> * 描述  ：USART1 GPIO 配置,工作模式配置。</span></span><br><span class="line"><span class="comment"> * 输入  ：无</span></span><br><span class="line"><span class="comment"> * 输出  : 无</span></span><br><span class="line"><span class="comment"> * 调用  ：外部调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART3_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line">	NVIC_InitTypeDef NVIC_InitStructure; </span><br><span class="line">	<span class="comment">/* 配置串口1 （USART1） 时钟*/</span></span><br><span class="line">	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART3 | RCC_APB2Periph_GPIOB, ENABLE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 使能串口1中断 */</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannel = USART3_IRQn;	<span class="comment">//USART1  串口1全局中断 </span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = <span class="number">0</span>;<span class="comment">//抢占优先级1</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = <span class="number">0</span>; <span class="comment">//子优先级1</span></span><br><span class="line">	<span class="comment">/*IRQ通道使能*/</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;</span><br><span class="line">	<span class="comment">/*根据NVIC_InitStruct中指定的参数初始化外设NVIC寄存器USART1*/</span></span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*串口GPIO端口配置*/</span></span><br><span class="line">  <span class="comment">/* 配置串口1 （USART1 Tx (PA.09)）*/</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">  </span><br><span class="line">	<span class="comment">/* 配置串口1 USART1 Rx (PA.10)*/</span></span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11;</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//USART 初始化设置</span></span><br><span class="line">	USART_InitStructure.USART_BaudRate =<span class="number">500000</span>;<span class="comment">//串口波特率</span></span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;<span class="comment">//字长为8位数据格式</span></span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;<span class="comment">//一个停止位</span></span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;<span class="comment">//无奇偶校验位</span></span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;<span class="comment">//无硬件数据流控制</span></span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	<span class="comment">//收发模式</span></span><br><span class="line">	USART_Init(USART3, &amp;USART_InitStructure);</span><br><span class="line">	</span><br><span class="line">	USART_ITConfig(USART3, USART_IT_RXNE, ENABLE);<span class="comment">//开启中断</span></span><br><span class="line">	</span><br><span class="line">	USART_Cmd(USART3, ENABLE); <span class="comment">//使能串口 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART1_SendByte</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int8_t</span> *Data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="keyword">uint8_t</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (!(USART1-&gt;SR &amp; USART_FLAG_TXE));	 <span class="comment">// while(USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET)</span></span><br><span class="line">		USART_SendData(USART1,*(Data+i));	 </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART3_SendByte</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int8_t</span> *Data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="keyword">uint8_t</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (!(USART3-&gt;SR &amp; USART_FLAG_TXE));	 <span class="comment">// while(USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET)</span></span><br><span class="line">		USART_SendData(USART3,*(Data+i));	 </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int8_t</span> CheckSend[<span class="number">7</span>]=&#123;<span class="number">0xAA</span>,<span class="number">0XAA</span>,<span class="number">0xEF</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART1_setBaudRate</span><span class="params">(<span class="keyword">uint32_t</span> baudRate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line">	USART_InitStructure.USART_BaudRate =  baudRate;</span><br><span class="line">	USART_Init(USART1, &amp;USART_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 函数名：fputc</span></span><br><span class="line"><span class="comment"> * 描述  ：重定向c库函数printf到USART1</span></span><br><span class="line"><span class="comment"> * 输入  ：无</span></span><br><span class="line"><span class="comment"> * 输出  ：无</span></span><br><span class="line"><span class="comment"> * 调用  ：由printf调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fputc</span><span class="params">(<span class="keyword">int</span> ch, FILE *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* 将Printf内容发往串口 */</span></span><br><span class="line">	USART_SendData(USART1, (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch);</span><br><span class="line">	<span class="keyword">while</span>( USART_GetFlagStatus(USART1,USART_FLAG_TC)!= SET);	</span><br><span class="line">	<span class="keyword">return</span> (ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TIM.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TIM.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DEFINE.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM2_PWM_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure;</span><br><span class="line">  TIM_OCInitTypeDef TIM_OCInitStructure;</span><br><span class="line">  GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">  <span class="comment">/* 使能GPIOA时钟时钟 */</span></span><br><span class="line">  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);</span><br><span class="line"></span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2 |</span><br><span class="line">    GPIO_Pin_3;</span><br><span class="line">  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;</span><br><span class="line">  GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">  <span class="comment">/* 使能定时器2时钟 */</span></span><br><span class="line">  RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);</span><br><span class="line">  <span class="comment">/* Time base configuration */</span></span><br><span class="line">  TIM_TimeBaseStructure.TIM_Period = <span class="number">999</span>; <span class="comment">//定时器计数周期 0-999  1000	</span></span><br><span class="line">  TIM_TimeBaseStructure.TIM_Prescaler = <span class="number">8</span>; <span class="comment">//设置预分频：8+1分频   8K PWM频率</span></span><br><span class="line">  TIM_TimeBaseStructure.TIM_ClockDivision = <span class="number">0</span>; <span class="comment">//设置时钟分频系数：不分频</span></span><br><span class="line">  TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up; <span class="comment">//向上计数模式</span></span><br><span class="line"></span><br><span class="line">  TIM_TimeBaseInit(TIM2, &amp;TIM_TimeBaseStructure);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* PWM1 Mode configuration: Channel */</span></span><br><span class="line">  TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1; <span class="comment">//配置为PWM模式1</span></span><br><span class="line">  TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;</span><br><span class="line">  TIM_OCInitStructure.TIM_Pulse = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//设置跳变值，当计数器计数到这个值时，电平发生跳变(即占空比) 初始值0</span></span><br><span class="line">  TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;</span><br><span class="line">    <span class="comment">//当定时器计数值小于定时设定值时为高电平</span></span><br><span class="line">  <span class="comment">/* 使能通道1 */</span></span><br><span class="line">  TIM_OC1Init(TIM2, &amp;TIM_OCInitStructure);</span><br><span class="line">  TIM_OC1PreloadConfig(TIM2, TIM_OCPreload_Enable);</span><br><span class="line">  <span class="comment">/* 使能通道2 */</span></span><br><span class="line">  TIM_OC2Init(TIM2, &amp;TIM_OCInitStructure);</span><br><span class="line">  TIM_OC2PreloadConfig(TIM2, TIM_OCPreload_Enable);</span><br><span class="line">  <span class="comment">/* 使能通道3 */</span></span><br><span class="line">  TIM_OC3Init(TIM2, &amp;TIM_OCInitStructure);</span><br><span class="line">  TIM_OC3PreloadConfig(TIM2, TIM_OCPreload_Enable);</span><br><span class="line">  <span class="comment">/* 使能通道4 */</span></span><br><span class="line">  TIM_OC4Init(TIM2, &amp;TIM_OCInitStructure);</span><br><span class="line">  TIM_OC4PreloadConfig(TIM2, TIM_OCPreload_Enable);</span><br><span class="line"></span><br><span class="line">  TIM_ARRPreloadConfig(TIM2, ENABLE); <span class="comment">// 使能TIM2重载寄存器ARR</span></span><br><span class="line">  TIM_Cmd(TIM2, ENABLE); <span class="comment">//使能定时器2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//通用定时器中断初始化</span></span><br><span class="line"><span class="comment">//这里时钟选择为APB1的2倍，而APB1为36M</span></span><br><span class="line"><span class="comment">//arr：自动重装值。</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="comment">//这里使用的是定时器3!</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;</span><br><span class="line">	NVIC_InitTypeDef NVIC_InitStructure; </span><br><span class="line">	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3, ENABLE); <span class="comment">//时钟使能</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannel = TIM3_IRQn;  <span class="comment">//TIM3中断</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = <span class="number">1</span>;  <span class="comment">//先占优先级1级</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = <span class="number">3</span>;  <span class="comment">//从优先级3级</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; <span class="comment">//IRQ通道被使能</span></span><br><span class="line">	</span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);  <span class="comment">//根据NVIC_InitStruct中指定的参数初始化外设NVIC寄存器</span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_Period = <span class="number">299</span>; <span class="comment">//设置在下一个更新事件装入活动的自动重装载寄存器周期的值	 计数到300为3ms</span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_Prescaler =<span class="number">719</span>; <span class="comment">//设置用来作为TIMx时钟频率除数的预分频值  100Khz的计数频率  </span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_ClockDivision = <span class="number">0</span>; <span class="comment">//设置时钟分割:TDTS = Tck_tim</span></span><br><span class="line">	TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  <span class="comment">//TIM向上计数模式</span></span><br><span class="line">	TIM_TimeBaseInit(TIM3, &amp;TIM_TimeBaseStructure); <span class="comment">//根据TIM_TimeBaseInitStruct中指定的参数初始化TIMx的时间基数单位</span></span><br><span class="line"> </span><br><span class="line">	TIM_ITConfig(TIM3,TIM_IT_Update,ENABLE);</span><br><span class="line"></span><br><span class="line">	TIM_Cmd(TIM3, ENABLE);  <span class="comment">//使能TIMx外设						 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span>   <span class="comment">//TIM3中断 3ms</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET) <span class="comment">//检查指定的TIM中断发生与否:TIM 中断源 </span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">static</span> <span class="keyword">uint8_t</span> cnt_3ms = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">static</span> <span class="keyword">uint8_t</span> cnt_6ms = <span class="number">0</span>;	 </span><br><span class="line">		SysTick_count++;</span><br><span class="line">		cnt_3ms++;</span><br><span class="line">		cnt_6ms++;		</span><br><span class="line">		<span class="keyword">if</span>(cnt_3ms == <span class="number">1</span>)  <span class="comment">//1ms更新一次</span></span><br><span class="line">		&#123;</span><br><span class="line">			cnt_3ms = <span class="number">0</span>;</span><br><span class="line">			MpuGetData();</span><br><span class="line">			RC_Analy();			</span><br><span class="line">			FlightPidControl(<span class="number">0.003f</span>);</span><br><span class="line">			MotorControl();</span><br><span class="line">		&#125;		</span><br><span class="line">		<span class="keyword">if</span>(cnt_6ms == <span class="number">2</span>) <span class="comment">//6ms更新一次</span></span><br><span class="line">		&#123;</span><br><span class="line">			cnt_6ms = <span class="number">0</span>;</span><br><span class="line">			GetAngle(&amp;MPU6050,&amp;Angle,<span class="number">0.00626f</span>);</span><br><span class="line">		&#125;		</span><br><span class="line">		TIM_ClearITPendingBit(TIM3, TIM_IT_Update );  <span class="comment">//清除TIMx的中断待处理位:TIM 中断源 </span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SPI.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spi.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SPI_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      SPI_InitTypeDef  SPI_InitStructure;</span><br><span class="line">   	  GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line"></span><br><span class="line">		RCC_APB1PeriphClockCmd(RCC_APB1Periph_SPI2,ENABLE);  </span><br><span class="line">		RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB | RCC_APB2Periph_AFIO  , ENABLE);</span><br><span class="line">		GPIO_SetBits(GPIOB, GPIO_Pin_12); <span class="comment">//NRF_CS预置为高 </span></span><br><span class="line">		</span><br><span class="line">	  	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_13 | GPIO_Pin_14 | GPIO_Pin_15; </span><br><span class="line">	  	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; </span><br><span class="line">	  	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP; </span><br><span class="line">	  	GPIO_Init(GPIOB, &amp;GPIO_InitStructure); </span><br><span class="line"></span><br><span class="line">        <span class="comment">/* SPI2 configuration */</span></span><br><span class="line">        SPI_Cmd(SPI2, DISABLE);             <span class="comment">//必须先禁能,才能改变MODE</span></span><br><span class="line">        SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;</span><br><span class="line">        SPI_InitStructure.SPI_Mode = SPI_Mode_Master;</span><br><span class="line">        SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b;</span><br><span class="line">        SPI_InitStructure.SPI_CPOL = SPI_CPOL_Low;</span><br><span class="line">        SPI_InitStructure.SPI_CPHA = SPI_CPHA_1Edge;</span><br><span class="line">        SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;</span><br><span class="line">        SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_8;</span><br><span class="line">        SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;</span><br><span class="line">        SPI_InitStructure.SPI_CRCPolynomial = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">        SPI_Init(SPI2, &amp;SPI_InitStructure);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* SPI2 enable */</span></span><br><span class="line">        SPI_Cmd(SPI2, ENABLE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">u8 <span class="title">SPI_RW</span><span class="params">(u8 dat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="comment">/* Loop while DR register in not emplty */</span></span><br><span class="line">        <span class="keyword">while</span>(SPI_I2S_GetFlagStatus(SPI2, SPI_I2S_FLAG_TXE) == RESET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Send byte through the SPI2 peripheral */</span></span><br><span class="line">        SPI_I2S_SendData(SPI2, dat);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Wait to receive a byte */</span></span><br><span class="line">        <span class="keyword">while</span>(SPI_I2S_GetFlagStatus(SPI2, SPI_I2S_FLAG_RXNE) == RESET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Return the byte read from the SPI bus */</span></span><br><span class="line">        <span class="keyword">return</span> SPI_I2S_ReceiveData(SPI2);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LED.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DATA.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">sLED LED = &#123;<span class="number">300</span>,AllFlashLight&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LEDInit</span><span class="params">(<span class="keyword">void</span>)</span>	</span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB  , ENABLE);</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO,ENABLE);</span><br><span class="line">	GPIO_PinRemapConfig(GPIO_Remap_SWJ_Disable,ENABLE);</span><br><span class="line">	GPIO_PinRemapConfig(GPIO_Remap_SWJ_JTAGDisable,ENABLE);</span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_1 | GPIO_Pin_2|GPIO_Pin_8 | GPIO_Pin_9;		     <span class="comment">//LED12</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LEDRefresh</span><span class="params">()</span> <span class="comment">//flash 300MS interval</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">uint32_t</span> LastTime = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(SysTick_count - LastTime &lt; LED.FlashTime)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		LastTime = SysTick_count;</span><br><span class="line">	<span class="keyword">switch</span>(LED.status)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> AlwaysOff:      <span class="comment">//常暗   </span></span><br><span class="line">			bLED_H();</span><br><span class="line">			fLED_H();</span><br><span class="line">			bLED_H();</span><br><span class="line">			hLED_H();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> AllFlashLight:				  <span class="comment">//全部同时闪烁</span></span><br><span class="line">			fLED_Toggle();			</span><br><span class="line">			bLED_Toggle();</span><br><span class="line">			hLED_Toggle();			</span><br><span class="line">			aLED_Toggle();		</span><br><span class="line">		  <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> AlwaysOn:  <span class="comment">//常亮</span></span><br><span class="line">		  bLED_L();</span><br><span class="line">			fLED_L();</span><br><span class="line">			aLED_L();</span><br><span class="line">			hLED_L();</span><br><span class="line">		  <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> AlternateFlash: <span class="comment">//交替闪烁</span></span><br><span class="line">			bLED_H();</span><br><span class="line">			fLED_L();</span><br><span class="line">			aLED_H();</span><br><span class="line">			hLED_L();</span><br><span class="line">			LED.status = AllFlashLight;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WARNING:</span><br><span class="line">			fLED_L();</span><br><span class="line">			hLED_L();</span><br><span class="line">			bLED_Toggle();</span><br><span class="line">			LED.FlashTime = <span class="number">100</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> DANGEROURS:</span><br><span class="line">			bLED_L();</span><br><span class="line">		  aLED_L();</span><br><span class="line">			fLED_Toggle();</span><br><span class="line">		  hLED_Toggle();</span><br><span class="line">			LED.FlashTime = <span class="number">70</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			LED.status = AlwaysOff;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NRF24L01.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nrf24l01.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;SPI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> SUCCESS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUCCESS 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> FAILED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAILED  1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_TX  		0x10  <span class="comment">//达到最大发送次数中断</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TX_OK   		0x20  <span class="comment">//TX发送完成中断</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RX_OK   		0x40  <span class="comment">//接收到数据中断</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//24L01操作线   </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_CSN_H    (GPIOB-&gt;BSRR = GPIO_Pin_12) <span class="comment">// PB12</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPI_CSN_L     (GPIOB-&gt;BRR = GPIO_Pin_12)    <span class="comment">// PB12</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NRF24L01_CE_H (GPIOA-&gt;BSRR = GPIO_Pin_11)    <span class="comment">// PB1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NRF24L01_CE_L  (GPIOA-&gt;BRR = GPIO_Pin_11)    <span class="comment">// PB1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NRF24L01_IRQ   (GPIOB-&gt;IDR&amp;GPIO_Pin_0)<span class="comment">//IRQ主机数据输入 PB0</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nrf24l01.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;SPI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> SUCCESS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUCCESS 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> FAILED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAILED  1</span></span><br><span class="line"><span class="comment">//配对密码</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> TX_ADDRESS[]= &#123;<span class="number">0x11</span>,<span class="number">0x22</span>,<span class="number">0x33</span>,<span class="number">0x44</span>,<span class="number">0x55</span>&#125;;	<span class="comment">//本地地址</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> RX_ADDRESS[]= &#123;<span class="number">0x11</span>,<span class="number">0x22</span>,<span class="number">0x33</span>,<span class="number">0x44</span>,<span class="number">0x55</span>&#125;;	<span class="comment">//接收地址RX_ADDR_P0 == RX_ADDR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//24L01操作线   </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Set_NRF24L01_CSN    (GPIOB-&gt;BSRR = GPIO_Pin_12) <span class="comment">// PB12</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Clr_NRF24L01_CSN     (GPIOB-&gt;BRR = GPIO_Pin_12)    <span class="comment">// PB12</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Set_NRF24L01_CE (GPIOA-&gt;BSRR = GPIO_Pin_11)    <span class="comment">// PB1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Clr_NRF24L01_CE  (GPIOA-&gt;BRR = GPIO_Pin_11)    <span class="comment">// PB1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_NRF24L01_IRQ   (GPIOA-&gt;IDR&amp;GPIO_Pin_8)<span class="comment">//IRQ主机数据输入 PB0</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化24L01的IO口</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NRF24L01_Configuration</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);    <span class="comment">//使能GPIO的时钟  CE</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11;          <span class="comment">//NRF24L01  </span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;    <span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line"></span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);   <span class="comment">//使能GPIO的时钟 CSN</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12;      </span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;    <span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	Set_NRF24L01_CE;                                    <span class="comment">//初始化时先拉高</span></span><br><span class="line">	Set_NRF24L01_CSN;                                   <span class="comment">//初始化时先拉高</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置NRF2401的IRQ</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8;</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU  ;     <span class="comment">//上拉输入</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">	GPIO_SetBits(GPIOA,GPIO_Pin_8);</span><br><span class="line"></span><br><span class="line">	SPI_Config();                                <span class="comment">//初始化SPI</span></span><br><span class="line">	Clr_NRF24L01_CE; 	                                <span class="comment">//使能24L01</span></span><br><span class="line">	Set_NRF24L01_CSN;                                   <span class="comment">//SPI片选取消</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上电检测NRF24L01是否在位</span></span><br><span class="line"><span class="comment">//写5个数据然后再读回来进行比较，</span></span><br><span class="line"><span class="comment">//相同时返回值:0，表示在位;否则返回1，表示不在位	</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Check</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 buf[<span class="number">5</span>]=&#123;<span class="number">0XA5</span>,<span class="number">0XA5</span>,<span class="number">0XA5</span>,<span class="number">0XA5</span>,<span class="number">0XA5</span>&#125;;</span><br><span class="line">	u8 buf1[<span class="number">5</span>];</span><br><span class="line">	u8 i;   	 </span><br><span class="line">	NRF24L01_Write_Buf(SPI_WRITE_REG+TX_ADDR,buf,<span class="number">5</span>);<span class="comment">//写入5个字节的地址.	</span></span><br><span class="line">	NRF24L01_Read_Buf(TX_ADDR,buf1,<span class="number">5</span>);              <span class="comment">//读出写入的地址  	</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)<span class="keyword">if</span>(buf1[i]!=<span class="number">0XA5</span>)<span class="keyword">break</span>;					   </span><br><span class="line">	<span class="keyword">if</span>(i!=<span class="number">5</span>)<span class="keyword">return</span> <span class="number">1</span>;                               <span class="comment">//NRF24L01不在位	</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;		                                <span class="comment">//NRF24L01在位</span></span><br><span class="line">&#125;	 	 </span><br><span class="line"><span class="comment">//通过SPI写寄存器</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Write_Reg</span><span class="params">(u8 regaddr,u8 data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 status;	</span><br><span class="line">    Clr_NRF24L01_CSN;                    <span class="comment">//使能SPI传输</span></span><br><span class="line">  	status =SPI_RW(regaddr); <span class="comment">//发送寄存器号 </span></span><br><span class="line">  	SPI_RW(data);            <span class="comment">//写入寄存器的值</span></span><br><span class="line">  	Set_NRF24L01_CSN;                    <span class="comment">//禁止SPI传输	   </span></span><br><span class="line">  	<span class="keyword">return</span>(status);       		         <span class="comment">//返回状态值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//读取SPI寄存器值 ，regaddr:要读的寄存器</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Read_Reg</span><span class="params">(u8 regaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 reg_val;	    </span><br><span class="line">	Clr_NRF24L01_CSN;                <span class="comment">//使能SPI传输		</span></span><br><span class="line">  	SPI_RW(regaddr);     <span class="comment">//发送寄存器号</span></span><br><span class="line">  	reg_val=SPI_RW(<span class="number">0XFF</span>);<span class="comment">//读取寄存器内容</span></span><br><span class="line">  	Set_NRF24L01_CSN;                <span class="comment">//禁止SPI传输		    </span></span><br><span class="line">  	<span class="keyword">return</span>(reg_val);                 <span class="comment">//返回状态值</span></span><br><span class="line">&#125;	</span><br><span class="line"><span class="comment">//在指定位置读出指定长度的数据</span></span><br><span class="line"><span class="comment">//*pBuf:数据指针</span></span><br><span class="line"><span class="comment">//返回值,此次读到的状态寄存器值 </span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Read_Buf</span><span class="params">(u8 regaddr,u8 *pBuf,u8 datalen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 status,u8_ctr;	       </span><br><span class="line">  	Clr_NRF24L01_CSN;                     <span class="comment">//使能SPI传输</span></span><br><span class="line">  	status=SPI_RW(regaddr);   <span class="comment">//发送寄存器值(位置),并读取状态值   	   </span></span><br><span class="line">	<span class="keyword">for</span>(u8_ctr=<span class="number">0</span>;u8_ctr&lt;datalen;u8_ctr++)pBuf[u8_ctr]=SPI_RW(<span class="number">0XFF</span>);<span class="comment">//读出数据</span></span><br><span class="line">  	Set_NRF24L01_CSN;                     <span class="comment">//关闭SPI传输</span></span><br><span class="line">  	<span class="keyword">return</span> status;                        <span class="comment">//返回读到的状态值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在指定位置写指定长度的数据</span></span><br><span class="line"><span class="comment">//*pBuf:数据指针</span></span><br><span class="line"><span class="comment">//返回值,此次读到的状态寄存器值</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Write_Buf</span><span class="params">(u8 regaddr, u8 *pBuf, u8 datalen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 status,u8_ctr;	    </span><br><span class="line">	Clr_NRF24L01_CSN;                                    <span class="comment">//使能SPI传输</span></span><br><span class="line">  	status = SPI_RW(regaddr);                <span class="comment">//发送寄存器值(位置),并读取状态值</span></span><br><span class="line">  	<span class="keyword">for</span>(u8_ctr=<span class="number">0</span>; u8_ctr&lt;datalen; u8_ctr++)SPI_RW(*pBuf++); <span class="comment">//写入数据	 </span></span><br><span class="line">  	Set_NRF24L01_CSN;                                    <span class="comment">//关闭SPI传输</span></span><br><span class="line">  	<span class="keyword">return</span> status;                                       <span class="comment">//返回读到的状态值</span></span><br><span class="line">&#125;				   </span><br><span class="line"><span class="comment">//启动NRF24L01发送一次数据</span></span><br><span class="line"><span class="comment">//txbuf:待发送数据首地址</span></span><br><span class="line"><span class="comment">//返回值:发送完成状况</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_TxPacket</span><span class="params">(u8 *txbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 state;   </span><br><span class="line">	Clr_NRF24L01_CE;</span><br><span class="line">	NRF24L01_Write_Buf(WR_TX_PLOAD,txbuf,TX_PLOAD_WIDTH);<span class="comment">//写数据到TX BUF  32个字节</span></span><br><span class="line">	Set_NRF24L01_CE;                                     <span class="comment">//启动发送	   </span></span><br><span class="line">	<span class="keyword">while</span>(READ_NRF24L01_IRQ!=<span class="number">0</span>);                         <span class="comment">//等待发送完成</span></span><br><span class="line">	state=NRF24L01_Read_Reg(STATUS);                     <span class="comment">//读取状态寄存器的值	   </span></span><br><span class="line">	NRF24L01_Write_Reg(SPI_WRITE_REG+STATUS,state);      <span class="comment">//清除TX_DS或MAX_RT中断标志</span></span><br><span class="line">	<span class="keyword">if</span>(state&amp;MAX_TX)                                     <span class="comment">//达到最大重发次数</span></span><br><span class="line">	&#123;</span><br><span class="line">		NRF24L01_Write_Reg(FLUSH_TX,<span class="number">0xff</span>);               <span class="comment">//清除TX FIFO寄存器 </span></span><br><span class="line">		<span class="keyword">return</span> MAX_TX; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(state&amp;TX_OK)                                      <span class="comment">//发送完成</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> FAILED;                                         <span class="comment">//其他原因发送失败</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动NRF24L01发送一次数据</span></span><br><span class="line"><span class="comment">//txbuf:待发送数据首地址</span></span><br><span class="line"><span class="comment">//返回值:0，接收完成；其他，错误代码</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_RxPacket</span><span class="params">(u8 *rxbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 state;		    							      </span><br><span class="line">	state=NRF24L01_Read_Reg(STATUS);                <span class="comment">//读取状态寄存器的值    	 </span></span><br><span class="line">	NRF24L01_Write_Reg(SPI_WRITE_REG+STATUS,state); <span class="comment">//清除TX_DS或MAX_RT中断标志</span></span><br><span class="line">	<span class="keyword">if</span>(state&amp;RX_OK)                                 <span class="comment">//接收到数据</span></span><br><span class="line">	&#123;</span><br><span class="line">		NRF24L01_Read_Buf(RD_RX_PLOAD,rxbuf,RX_PLOAD_WIDTH);<span class="comment">//读取数据</span></span><br><span class="line">		NRF24L01_Write_Reg(FLUSH_RX,<span class="number">0xff</span>);          <span class="comment">//清除RX FIFO寄存器 </span></span><br><span class="line">		<span class="keyword">return</span> SUCCESS; </span><br><span class="line">	&#125;	   </span><br><span class="line">	<span class="keyword">return</span> FAILED;                                      <span class="comment">//没收到任何数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//该函数初始化NRF24L01到RX模式</span></span><br><span class="line"><span class="comment">//设置RX地址,写RX数据宽度,选择RF频道,波特率和LNA HCURR</span></span><br><span class="line"><span class="comment">//当CE变高后,即进入RX模式,并可以接收数据了		   </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RX_Mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Clr_NRF24L01_CE;	  </span><br><span class="line">    <span class="comment">//写RX节点地址</span></span><br><span class="line">  	NRF24L01_Write_Buf(SPI_WRITE_REG+RX_ADDR_P0,(u8*)RX_ADDRESS,RX_ADR_WIDTH);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使能通道0的自动应答    </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_AA,<span class="number">0x01</span>);    </span><br><span class="line">    <span class="comment">//使能通道0的接收地址  	 </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_RXADDR,<span class="number">0x01</span>); </span><br><span class="line">	  <span class="comment">//设置RF通信频率		  </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_CH,<span class="number">45</span>);	  <span class="comment">//(要改单机控制，就把45改成跟遥控器单独一样的。就可以单机控制了)</span></span><br><span class="line">    <span class="comment">//选择通道0的有效数据宽度 	    </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RX_PW_P0,RX_PLOAD_WIDTH);</span><br><span class="line">    <span class="comment">//设置TX发射参数,0db增益,2Mbps,低噪声增益开启   </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_SETUP,<span class="number">0x0f</span>);</span><br><span class="line">    <span class="comment">//配置基本工作模式的参数;PWR_UP,EN_CRC,16BIT_CRC,PRIM_RX接收模式 </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+NCONFIG, <span class="number">0x0f</span>); </span><br><span class="line">    <span class="comment">//CE为高,进入接收模式 </span></span><br><span class="line">  	Set_NRF24L01_CE;                                </span><br><span class="line">&#125;			</span><br><span class="line"></span><br><span class="line"><span class="comment">//该函数初始化NRF24L01到TX模式</span></span><br><span class="line"><span class="comment">//设置TX地址,写TX数据宽度,设置RX自动应答的地址,填充TX发送数据,</span></span><br><span class="line"><span class="comment">//选择RF频道,波特率和LNA HCURR PWR_UP,CRC使能</span></span><br><span class="line"><span class="comment">//当CE变高后,即进入RX模式,并可以接收数据了		   </span></span><br><span class="line"><span class="comment">//CE为高大于10us,则启动发送.	 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TX_Mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;														 </span><br><span class="line">	Clr_NRF24L01_CE;	    </span><br><span class="line">    <span class="comment">//写TX节点地址 </span></span><br><span class="line">  	NRF24L01_Write_Buf(SPI_WRITE_REG+TX_ADDR,(u8*)TX_ADDRESS,TX_ADR_WIDTH);    </span><br><span class="line">    <span class="comment">//设置TX节点地址,主要为了使能ACK	  </span></span><br><span class="line">  	NRF24L01_Write_Buf(SPI_WRITE_REG+RX_ADDR_P0,(u8*)RX_ADDRESS,RX_ADR_WIDTH); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//使能通道0的自动应答    </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_AA,<span class="number">0x01</span>);     </span><br><span class="line">    <span class="comment">//使能通道0的接收地址  </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_RXADDR,<span class="number">0x01</span>); </span><br><span class="line">    <span class="comment">//设置自动重发间隔时间:500us + 86us;最大自动重发次数:10次</span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+SETUP_RETR,<span class="number">0x1a</span>);</span><br><span class="line">    <span class="comment">//设置RF通道为40</span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_CH,<span class="number">45</span>);       <span class="comment">//(要改单机控制，就把45改成跟遥控器单独一样的。就可以单机控制了)</span></span><br><span class="line">    <span class="comment">//设置TX发射参数,0db增益,2Mbps,低噪声增益开启   </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_SETUP,<span class="number">0x0f</span>);  <span class="comment">//0x27  250K   0x07 1M</span></span><br><span class="line">    <span class="comment">//配置基本工作模式的参数;PWR_UP,EN_CRC,16BIT_CRC,PRIM_RX发送模式,开启所有中断</span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+NCONFIG,<span class="number">0x0e</span>);    </span><br><span class="line">    <span class="comment">// CE为高,10us后启动发送</span></span><br><span class="line">	Set_NRF24L01_CE;                                  </span><br><span class="line">&#125;		  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NRF24L01_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NRF24L01_Configuration();</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">    RX_Mode();</span><br><span class="line">	&#125;<span class="keyword">while</span>(NRF24L01_Check() == FAILED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MPU6050.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DATA.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mpu6050.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;I2C.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;filter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;myMath.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kalman.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	SMPLRT_DIV		0x19	<span class="comment">//陀螺仪采样率，典型值：0x07(125Hz)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	CONFIGL			0x1A	<span class="comment">//低通滤波频率，典型值：0x06(5Hz)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	GYRO_CONFIG		0x1B	<span class="comment">//陀螺仪自检及测量范围，典型值：0x18(不自检，2000deg/s)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_CONFIG	0x1C	<span class="comment">//加速计自检、测量范围及高通滤波频率，典型值：0x01(不自检，2G，5Hz)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_ADDRESS	0x3B</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_XOUT_H	0x3B</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_XOUT_L	0x3C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_YOUT_H	0x3D</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_YOUT_L	0x3E</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_ZOUT_H	0x3F</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ACCEL_ZOUT_L	0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	TEMP_OUT_H		0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	TEMP_OUT_L		0x42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	GYRO_XOUT_H		0x43</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GYRO_ADDRESS  0x43</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	GYRO_XOUT_L		0x44	</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	GYRO_YOUT_H		0x45</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	GYRO_YOUT_L		0x46</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	GYRO_ZOUT_H		0x47</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	GYRO_ZOUT_L		0x48</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	PWR_MGMT_1		0x6B	<span class="comment">//电源管理，典型值：0x00(正常启用)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	WHO_AM_I		  0x75	<span class="comment">//IIC地址寄存器(默认数值0x68，只读)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MPU6050_PRODUCT_ID 0x68</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MPU6052C_PRODUCT_ID 0x72</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define   MPU6050_is_DRY()      GPIO_ReadOutBit(HT_GPIOC, GPIO_PIN_0)//IRQ主机数据输入</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span>  	USE_I2C_HARDWARE</span></span><br><span class="line">		</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">define</span> MPU6050_ADDRESS 0xD0<span class="comment">//0x68</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">define</span>  MPU6050_ADDRESS 0xD0   <span class="comment">//IIC写入时的地址字节数据，+1为读取</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int16_t</span> MpuOffset[<span class="number">6</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int16_t</span> *pMpu = (<span class="keyword">int16_t</span> *)&amp;MPU6050;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int8_t</span> <span class="title">mpu6050_rest</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(IIC_Write_One_Byte(MPU6050_ADDRESS, PWR_MGMT_1, <span class="number">0x80</span>) == FAILED)</span><br><span class="line">		<span class="keyword">return</span> FAILED;	<span class="comment">//复位</span></span><br><span class="line">	delay_ms(<span class="number">20</span>);</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/****************************************************************************************</span></span><br><span class="line"><span class="comment">*@brief   </span></span><br><span class="line"><span class="comment">*@brief  </span></span><br><span class="line"><span class="comment">*@param[in]</span></span><br><span class="line"><span class="comment">*****************************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int8_t</span> <span class="title">MpuInit</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">//初始化</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint8_t</span> date = SUCCESS;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">	date = IIC_Write_One_Byte(MPU6050_ADDRESS, PWR_MGMT_1, <span class="number">0x80</span>);	<span class="comment">//复位</span></span><br><span class="line">	delay_ms(<span class="number">30</span>);</span><br><span class="line">	date += IIC_Write_One_Byte(MPU6050_ADDRESS, SMPLRT_DIV, <span class="number">0x02</span>); <span class="comment">//陀螺仪采样率，0x00(500Hz)</span></span><br><span class="line">	date += IIC_Write_One_Byte(MPU6050_ADDRESS, PWR_MGMT_1, <span class="number">0x03</span>);	<span class="comment">//设置设备时钟源，陀螺仪Z轴</span></span><br><span class="line">	date += IIC_Write_One_Byte(MPU6050_ADDRESS, CONFIGL, <span class="number">0x03</span>);   <span class="comment">//低通滤波频率，0x03(42Hz)</span></span><br><span class="line">	date += IIC_Write_One_Byte(MPU6050_ADDRESS, GYRO_CONFIG, <span class="number">0x18</span>);<span class="comment">//+-2000deg/s</span></span><br><span class="line">	date += IIC_Write_One_Byte(MPU6050_ADDRESS, ACCEL_CONFIG, <span class="number">0x09</span>);<span class="comment">//+-4G</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(date != SUCCESS);</span><br><span class="line">	date = IIC_Read_One_Byte(MPU6050_ADDRESS, <span class="number">0x75</span>);</span><br><span class="line">	<span class="keyword">if</span>(date!= MPU6050_PRODUCT_ID)</span><br><span class="line">		<span class="keyword">return</span> FAILED;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">		MpuGetOffset();</span><br><span class="line">		<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  Gyro_Read() IIC_read_Bytes(MPU6050_ADDRESS, 0X3B,buffer,6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  Acc_Read() IIC_read_Bytes(MPU6050_ADDRESS, 0x43,&amp;buffer[6],6)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MpuGetData</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">//读取陀螺仪数据加滤波</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	  <span class="keyword">uint8_t</span> i;</span><br><span class="line">    <span class="keyword">uint8_t</span> buffer[<span class="number">12</span>];</span><br><span class="line"></span><br><span class="line">		Gyro_Read();</span><br><span class="line">	  Acc_Read();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			pMpu[i] = (((<span class="keyword">int16_t</span>)buffer[i&lt;&lt;<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | buffer[(i&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>])-MpuOffset[i];		</span><br><span class="line">			<span class="keyword">if</span>(i &lt; <span class="number">3</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _1_<span class="title">ekf_filter</span> <span class="title">ekf</span>[3] = &#123;</span>&#123;<span class="number">0.02</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.001</span>,<span class="number">0.543</span>&#125;,&#123;<span class="number">0.02</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.001</span>,<span class="number">0.543</span>&#125;,&#123;<span class="number">0.02</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.001</span>,<span class="number">0.543</span>&#125;&#125;;	</span><br><span class="line">					kalman_1(&amp;ekf[i],(<span class="keyword">float</span>)pMpu[i]);  <span class="comment">//一维卡尔曼</span></span><br><span class="line">					pMpu[i] = (<span class="keyword">int16_t</span>)ekf[i].out;</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(i &gt; <span class="number">2</span>)</span><br><span class="line">		&#123;	</span><br><span class="line">			<span class="keyword">uint8_t</span> k=i<span class="number">-3</span>;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">float</span> factor = <span class="number">0.15f</span>;  <span class="comment">//滤波因素			</span></span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">float</span> tBuff[<span class="number">3</span>];		</span><br><span class="line"></span><br><span class="line">			pMpu[i] = tBuff[k] = tBuff[k] * (<span class="number">1</span> - factor) + pMpu[i] * factor;                </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************************</span></span><br><span class="line"><span class="comment">*@brief   get mpu offset</span></span><br><span class="line"><span class="comment">*@brief   initial and cmd call this</span></span><br><span class="line"><span class="comment">*@param[in]</span></span><br><span class="line"><span class="comment">*****************************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MpuGetOffset</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">//校准</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int32_t</span> buffer[<span class="number">6</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int16_t</span> i;  </span><br><span class="line">	<span class="keyword">uint8_t</span> k=<span class="number">30</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int8_t</span> MAX_GYRO_QUIET = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int8_t</span> MIN_GYRO_QUIET = <span class="number">-5</span>;	</span><br><span class="line"><span class="comment">/*           wait for calm down    	                                                          */</span></span><br><span class="line">	<span class="keyword">int16_t</span> LastGyro[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int16_t</span> ErrorGyro[<span class="number">3</span>];	</span><br><span class="line">	<span class="comment">/*           set offset initial to zero    		*/</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(MpuOffset,<span class="number">0</span>,<span class="number">12</span>);</span><br><span class="line">	MpuOffset[<span class="number">2</span>] = <span class="number">8192</span>;   <span class="comment">//set offset from the 8192  </span></span><br><span class="line">	</span><br><span class="line">	TIM_ITConfig(  <span class="comment">//使能或者失能指定的TIM中断</span></span><br><span class="line">		TIM3, <span class="comment">//TIM2</span></span><br><span class="line">		TIM_IT_Update ,</span><br><span class="line">		DISABLE  <span class="comment">//使能</span></span><br><span class="line">		);	</span><br><span class="line">	<span class="keyword">while</span>(k--)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			delay_ms(<span class="number">10</span>);</span><br><span class="line">			MpuGetData();</span><br><span class="line">			<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">			&#123;</span><br><span class="line">				ErrorGyro[i] = pMpu[i+<span class="number">3</span>] - LastGyro[i];</span><br><span class="line">				LastGyro[i] = pMpu[i+<span class="number">3</span>];	</span><br><span class="line">			&#125;			</span><br><span class="line">		&#125;<span class="keyword">while</span> ((ErrorGyro[<span class="number">0</span>] &gt;  MAX_GYRO_QUIET )|| (ErrorGyro[<span class="number">0</span>] &lt; MIN_GYRO_QUIET)</span><br><span class="line">					||(ErrorGyro[<span class="number">1</span>] &gt; MAX_GYRO_QUIET )|| (ErrorGyro[<span class="number">1</span>] &lt; MIN_GYRO_QUIET)</span><br><span class="line">					||(ErrorGyro[<span class="number">2</span>] &gt; MAX_GYRO_QUIET )|| (ErrorGyro[<span class="number">2</span>] &lt; MIN_GYRO_QUIET)</span><br><span class="line">						);</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line"><span class="comment">/*           throw first 100  group data and make 256 group average as offset                    */</span>	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">356</span>;i++)</span><br><span class="line">	&#123;		</span><br><span class="line">		MpuGetData();</span><br><span class="line">		<span class="keyword">if</span>(<span class="number">100</span> &lt;= i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">uint8_t</span> k;</span><br><span class="line">			<span class="keyword">for</span>(k=<span class="number">0</span>;k&lt;<span class="number">6</span>;k++)</span><br><span class="line">			&#123;</span><br><span class="line">				buffer[k] += pMpu[k];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		MpuOffset[i] = buffer[i]&gt;&gt;<span class="number">8</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	TIM_ITConfig(  <span class="comment">//使能或者失能指定的TIM中断</span></span><br><span class="line">		TIM3, <span class="comment">//TIM2</span></span><br><span class="line">		TIM_IT_Update ,</span><br><span class="line">		ENABLE  <span class="comment">//使能</span></span><br><span class="line">		);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ANTO.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DATA.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ANO_DT.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;USART.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> RatePID[<span class="number">18</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> AnglePID[<span class="number">18</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> HighPID[<span class="number">18</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint8_t</span> PID1 :<span class="number">1</span>; <span class="comment">//接受到上位机PID组1</span></span><br><span class="line">	<span class="keyword">uint8_t</span> PID2 :<span class="number">1</span>; <span class="comment">//接受到上位机PID组2</span></span><br><span class="line">	<span class="keyword">uint8_t</span> PID3 :<span class="number">1</span>; <span class="comment">//接受到上位机PID组3</span></span><br><span class="line">	<span class="keyword">uint8_t</span> PID4 :<span class="number">1</span>; <span class="comment">//接受到上位机PID组4</span></span><br><span class="line">	<span class="keyword">uint8_t</span> PID5 :<span class="number">1</span>; <span class="comment">//接受到上位机PID组5</span></span><br><span class="line">	<span class="keyword">uint8_t</span> PID6 :<span class="number">1</span>; <span class="comment">//接受到上位机PID组6	</span></span><br><span class="line">	<span class="keyword">uint8_t</span> CMD2_READ_PID:<span class="number">1</span>; <span class="comment">//接受到上位机读取PID的请求</span></span><br><span class="line">&#125;ANTO_Recived_flag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span>                                  <span class="comment">//上位请求飞控类型</span></span><br><span class="line">&#123;</span><br><span class="line">	READ_PID = <span class="number">0X01</span>,                    <span class="comment">//读取飞控的PID请求</span></span><br><span class="line">	READ_MODE = <span class="number">0x02</span>,                   <span class="comment">//读取飞行模式</span></span><br><span class="line">	READ_ROUTE = <span class="number">0x21</span>,                  <span class="comment">//读取航点信息</span></span><br><span class="line">	READ_VERSION = <span class="number">0XA0</span>,                <span class="comment">//读取飞控版本</span></span><br><span class="line">	RETURN_DEFAULT_PID = <span class="number">0xA1</span>           <span class="comment">//恢复默认PID</span></span><br><span class="line"> &#125;CMD2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ANO_Recive</span><span class="params">(<span class="keyword">int8_t</span> *pt)</span>                   <span class="comment">//接收到上位机的数据</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span>(pt[<span class="number">2</span>])</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> ANTO_RATE_PID:</span><br><span class="line">			ANTO_Recived_flag.PID1 = <span class="number">1</span>;             <span class="comment">//接收到上位机发来的PID数据</span></span><br><span class="line">			<span class="built_in">memcpy</span>(RatePID,&amp;pt[<span class="number">4</span>],<span class="number">18</span>);              <span class="comment">//先把接收到的数据提出来，防止被下一组PID数据覆盖，这组的PID是给速度环用的</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_ANGLE_PID:                      <span class="comment">//这组的PID是给角度环用的</span></span><br><span class="line">			<span class="built_in">memcpy</span>(AnglePID,&amp;pt[<span class="number">4</span>],<span class="number">18</span>);</span><br><span class="line">			ANTO_Recived_flag.PID2 = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_HEIGHT_PID:                     <span class="comment">//这组的PID是给高度环用的</span></span><br><span class="line">			<span class="built_in">memcpy</span>(HighPID,&amp;pt[<span class="number">4</span>],<span class="number">18</span>);</span><br><span class="line">			ANTO_Recived_flag.PID3 = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_PID4:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_PID5:   </span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_PID6:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x01</span>:                                <span class="comment">//上位机发来的CMD1 包含各种校准</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x02</span>:                                <span class="comment">//上位机发来的CMD2 包含请求读取PID等</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">switch</span>(*(<span class="keyword">uint8_t</span>*)&amp;pt[<span class="number">4</span>])             <span class="comment">//判断上位机发来CMD的内容</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">case</span> READ_PID:                      <span class="comment">//上位机请求读取飞控PID数据</span></span><br><span class="line">						ANTO_Recived_flag.CMD2_READ_PID = <span class="number">1</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> READ_MODE: </span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> READ_ROUTE: </span><br><span class="line">						<span class="keyword">break</span>;					</span><br><span class="line">					<span class="keyword">case</span> READ_VERSION:  </span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> RETURN_DEFAULT_PID:  </span><br><span class="line">						<span class="keyword">break</span>;					</span><br><span class="line">					<span class="keyword">default</span>: </span><br><span class="line">						<span class="keyword">break</span>;					</span><br><span class="line">				&#125;			</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_RCDATA: <span class="comment">//Immediately deal with </span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;			</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ANTO_Send</span><span class="params">(<span class="keyword">const</span> <span class="keyword">enum</span> ANTO_SEND FUNCTION)</span> <span class="comment">//发送数据到上位机</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint8_t</span> i;</span><br><span class="line">	<span class="keyword">uint8_t</span> len=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">int16_t</span> Anto[<span class="number">12</span>];</span><br><span class="line">	<span class="keyword">int8_t</span> *pt = (<span class="keyword">int8_t</span>*)(Anto);</span><br><span class="line">	PidObject *pidX=<span class="number">0</span>;</span><br><span class="line">	PidObject *pidY=<span class="number">0</span>;</span><br><span class="line">	PidObject *pidZ=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(FUNCTION)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> ANTO_RATE_PID:      <span class="comment">//PID1</span></span><br><span class="line">				 pidX = &amp;pidRateX;</span><br><span class="line">				 pidY = &amp;pidRateY;</span><br><span class="line">				 pidZ = &amp;pidRateZ;</span><br><span class="line">         <span class="keyword">goto</span> send_pid;		</span><br><span class="line">		<span class="keyword">case</span> ANTO_ANGLE_PID:      <span class="comment">//PID2</span></span><br><span class="line">				 pidX = &amp;pidRoll;</span><br><span class="line">				 pidY = &amp;pidPitch;</span><br><span class="line">				 pidZ = &amp;pidYaw;</span><br><span class="line">				 <span class="keyword">goto</span> send_pid;				</span><br><span class="line">		<span class="keyword">case</span> ANTO_HEIGHT_PID:     <span class="comment">//PID3</span></span><br><span class="line">				 pidX = &amp;pidHeightRate;</span><br><span class="line">				 pidY = &amp;pidHeightHigh;</span><br><span class="line">				 <span class="keyword">goto</span> send_pid;							</span><br><span class="line">		<span class="keyword">case</span> ANTO_PID4:	  <span class="comment">//PID4</span></span><br><span class="line">		<span class="keyword">case</span> ANTO_PID5:	         <span class="comment">//PID5</span></span><br><span class="line">    <span class="keyword">case</span> ANTO_PID6:</span><br><span class="line">send_pid:</span><br><span class="line">			<span class="keyword">if</span>(pidX!=<span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Anto[<span class="number">2</span>] = (<span class="keyword">int16_t</span>)(pidX-&gt;kp *<span class="number">1000</span>);</span><br><span class="line">				Anto[<span class="number">3</span>] = (<span class="keyword">int16_t</span>)(pidX-&gt;ki *<span class="number">1000</span>);</span><br><span class="line">				Anto[<span class="number">4</span>] = (<span class="keyword">int16_t</span>)(pidX-&gt;kd *<span class="number">1000</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(pidY!=<span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Anto[<span class="number">5</span>] = (<span class="keyword">int16_t</span>)(pidY-&gt;kp *<span class="number">1000</span>);</span><br><span class="line">				Anto[<span class="number">6</span>] = (<span class="keyword">int16_t</span>)(pidY-&gt;ki *<span class="number">1000</span>);</span><br><span class="line">				Anto[<span class="number">7</span>] = (<span class="keyword">int16_t</span>)(pidY-&gt;kd *<span class="number">1000</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(pidZ!=<span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Anto[<span class="number">8</span>] = (<span class="keyword">int16_t</span>)(pidZ-&gt;kp *<span class="number">1000</span>);</span><br><span class="line">				Anto[<span class="number">9</span>] = (<span class="keyword">int16_t</span>)(pidZ-&gt;ki *<span class="number">1000</span>);</span><br><span class="line">				Anto[<span class="number">10</span>] = (<span class="keyword">int16_t</span>)(pidZ-&gt;kd *<span class="number">1000</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			len = <span class="number">18</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_MOTOR:    <span class="comment">//send motor</span></span><br><span class="line"></span><br><span class="line">				len = <span class="number">8</span>;</span><br><span class="line">			<span class="keyword">break</span>;	</span><br><span class="line">		<span class="keyword">case</span> ANTO_RCDATA: <span class="comment">//send RC data</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_MPU_MAGIC:     <span class="comment">//发送MPU6050和磁力计的数据</span></span><br><span class="line">			<span class="built_in">memcpy</span>(&amp;Anto[<span class="number">2</span>],(<span class="keyword">int8_t</span>*)&amp;MPU6050,<span class="keyword">sizeof</span>(_st_Mpu));</span><br><span class="line">			<span class="built_in">memcpy</span>(&amp;Anto[<span class="number">8</span>],(<span class="keyword">int8_t</span>*)&amp;AK8975,<span class="keyword">sizeof</span>(_st_Mag));</span><br><span class="line">			len = <span class="number">18</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_SENSER2:</span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_STATUS:     <span class="comment">//send angle</span></span><br><span class="line">			</span><br><span class="line">				Anto[<span class="number">2</span>] = (<span class="keyword">int16_t</span>)(-Angle.roll*<span class="number">100</span>);</span><br><span class="line">				Anto[<span class="number">3</span>] = (<span class="keyword">int16_t</span>)(Angle.pitch*<span class="number">100</span>);</span><br><span class="line">				Anto[<span class="number">4</span>] = (<span class="keyword">int16_t</span>)(-Angle.yaw*<span class="number">100</span>);</span><br><span class="line">	   </span><br><span class="line">				len = <span class="number">6</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> ANTO_POWER:</span><br><span class="line"></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;			</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	Anto[<span class="number">0</span>] = <span class="number">0XAAAA</span>;</span><br><span class="line">	Anto[<span class="number">1</span>] = len | FUNCTION&lt;&lt;<span class="number">8</span>;</span><br><span class="line">	pt[len+<span class="number">4</span>] = (<span class="keyword">int8_t</span>)(<span class="number">0xAA</span>+<span class="number">0xAA</span>);</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">2</span>;i&lt;len+<span class="number">4</span>;i+=<span class="number">2</span>)    <span class="comment">//a swap with b;</span></span><br><span class="line">	&#123;</span><br><span class="line">		pt[i] ^= pt[i+<span class="number">1</span>];</span><br><span class="line">		pt[i+<span class="number">1</span>] ^= pt[i];</span><br><span class="line">		pt[i] ^= pt[i+<span class="number">1</span>];</span><br><span class="line">		pt[len+<span class="number">4</span>] += pt[i] + pt[i+<span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	USART3_SendByte(pt,len+<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ANTO_polling</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">//轮询扫描上位机端口</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">uint8_t</span> status = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">switch</span>(status)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			</span><br><span class="line">			status = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			ANTO_Send(ANTO_MPU_MAGIC);</span><br><span class="line">			delay_ms(<span class="number">1</span>);</span><br><span class="line">	  	ANTO_Send(ANTO_STATUS);</span><br><span class="line">			delay_ms(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(*(<span class="keyword">uint8_t</span>*)&amp;ANTO_Recived_flag != <span class="number">0</span>) <span class="comment">//一旦接收到上位机的数据，则暂停发送数据到上位机，转而去判断上位机要求飞控做什么。</span></span><br><span class="line">			&#123;</span><br><span class="line">				status = <span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		 	<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="keyword">if</span>(*(<span class="keyword">uint8_t</span>*)&amp;ANTO_Recived_flag == <span class="number">0</span>)<span class="comment">//上位机的发过来的数据都被处理了，则返回专心的发送数据到上位机</span></span><br><span class="line">			&#123;</span><br><span class="line">				status = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	</span><br><span class="line">			<span class="keyword">if</span>(ANTO_Recived_flag.CMD2_READ_PID) <span class="comment">//判断上位机是否请求发发送飞控PID数据到上位机</span></span><br><span class="line">			&#123;		</span><br><span class="line">					ANTO_Send(ANTO_RATE_PID);</span><br><span class="line">					delay_ms(<span class="number">1</span>);</span><br><span class="line">					ANTO_Send(ANTO_ANGLE_PID);</span><br><span class="line">					delay_ms(<span class="number">1</span>);</span><br><span class="line">					ANTO_Send(ANTO_HEIGHT_PID);</span><br><span class="line">					delay_ms(<span class="number">1</span>);</span><br><span class="line">					ANTO_Recived_flag.CMD2_READ_PID = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(*(<span class="keyword">uint8_t</span>*)&amp;ANTO_Recived_flag &amp; <span class="number">0x3f</span>) <span class="comment">//接收到上位机发来的PID数据</span></span><br><span class="line">			&#123;</span><br><span class="line">					PidObject *pidX=<span class="number">0</span>;</span><br><span class="line">					PidObject *pidY=<span class="number">0</span>;</span><br><span class="line">					PidObject *pidZ=<span class="number">0</span>;</span><br><span class="line">				  <span class="keyword">uint8_t</span> *P;</span><br><span class="line">				</span><br><span class="line">					<span class="keyword">if</span>(ANTO_Recived_flag.PID1)</span><br><span class="line">					&#123;</span><br><span class="line">						 pidX = &amp;pidRateX;</span><br><span class="line">						 pidY = &amp;pidRateY;</span><br><span class="line">						 pidZ = &amp;pidRateZ;</span><br><span class="line">						 P = RatePID;</span><br><span class="line">						 ANTO_Recived_flag.PID1 = <span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span>(ANTO_Recived_flag.PID2)</span><br><span class="line">					&#123;</span><br><span class="line">						 pidX = &amp;pidRoll;</span><br><span class="line">						 pidY = &amp;pidPitch;</span><br><span class="line">						 pidZ = &amp;pidYaw;</span><br><span class="line">						 P = AnglePID;	</span><br><span class="line">						 ANTO_Recived_flag.PID2 = <span class="number">0</span>;                             </span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span>(ANTO_Recived_flag.PID3)</span><br><span class="line">					&#123;</span><br><span class="line">						 pidX = &amp;pidHeightRate;</span><br><span class="line">						 pidY = &amp;pidHeightHigh;</span><br><span class="line">						 P = HighPID;	</span><br><span class="line">						 ANTO_Recived_flag.PID3 = <span class="number">0</span>;     						</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					&#123;</span><br><span class="line">							<span class="keyword">union</span> &#123;</span><br><span class="line">								<span class="keyword">uint16_t</span> _16;</span><br><span class="line">								<span class="keyword">uint8_t</span> _u8[<span class="number">2</span>];</span><br><span class="line">							&#125;data;</span><br><span class="line">							</span><br><span class="line">							<span class="keyword">if</span>(pidX!=<span class="literal">NULL</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">0</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">1</span>];</span><br><span class="line">								pidX-&gt;kp =  data._16 /<span class="number">1000.0f</span>;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">2</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">3</span>];</span><br><span class="line">								pidX-&gt;ki =  data._16 /<span class="number">1000.0f</span>;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">4</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">5</span>];</span><br><span class="line">								pidX-&gt;kd =  data._16 /<span class="number">1000.0f</span>;								</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span>(pidY!=<span class="literal">NULL</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">6</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">7</span>];</span><br><span class="line">								pidY-&gt;kp =  data._16 /<span class="number">1000.0f</span>;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">8</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">9</span>];</span><br><span class="line">								pidY-&gt;ki =  data._16 /<span class="number">1000.0f</span>;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">10</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">11</span>];</span><br><span class="line">								pidY-&gt;kd =  data._16 /<span class="number">1000.0f</span>;		</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span>(pidZ!=<span class="literal">NULL</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">12</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">13</span>];</span><br><span class="line">								pidZ-&gt;kp =  data._16 /<span class="number">1000.0f</span>;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">14</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">15</span>];</span><br><span class="line">								pidZ-&gt;ki =  data._16 /<span class="number">1000.0f</span>;</span><br><span class="line">								data._u8[<span class="number">1</span>] = P[<span class="number">16</span>]; </span><br><span class="line">								data._u8[<span class="number">0</span>] = P[<span class="number">17</span>];</span><br><span class="line">								pidZ-&gt;kd =  data._16 /<span class="number">1000.0f</span>;		</span><br><span class="line">							&#125;				</span><br><span class="line">					&#125;				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART3_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">//串口接收</span></span></span><br><span class="line"><span class="function"></span>&#123; 	</span><br><span class="line">  <span class="keyword">static</span>  <span class="keyword">int8_t</span> ReciveBuffer[<span class="number">25</span>];</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">uint8_t</span> count;</span><br><span class="line">	<span class="keyword">if</span> ((USART3-&gt;SR &amp; USART_IT_ORE))<span class="comment">//是否接收寄存器溢出</span></span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;	</span><br><span class="line">  <span class="keyword">if</span>((USART3-&gt;SR &amp; USART_IT_RXNE))</span><br><span class="line">  &#123;</span><br><span class="line">		ReciveBuffer[count] = USART3-&gt;DR;	</span><br><span class="line">		<span class="keyword">switch</span>(count)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">if</span>(ReciveBuffer[<span class="number">0</span>]==(<span class="keyword">int8_t</span>)<span class="number">0xAA</span>)</span><br><span class="line">				count++;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:	</span><br><span class="line">			<span class="keyword">if</span>(ReciveBuffer[<span class="number">1</span>]==(<span class="keyword">int8_t</span>)<span class="number">0xAF</span>)</span><br><span class="line">					count++;</span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line">					count = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">if</span>(count &lt; ReciveBuffer[<span class="number">3</span>]+<span class="number">4</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				count++;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">uint8_t</span> i;</span><br><span class="line">				<span class="keyword">int8_t</span> CheckSum=<span class="number">0</span>;</span><br><span class="line">							</span><br><span class="line">				<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;count;i++)</span><br><span class="line">				&#123;</span><br><span class="line">					CheckSum += ReciveBuffer[i];			</span><br><span class="line">				&#125;		</span><br><span class="line">				<span class="keyword">if</span>(CheckSum == ReciveBuffer[count])  <span class="comment">//if the data calculate sum equal to the  final data from PC.</span></span><br><span class="line">				&#123;</span><br><span class="line">						<span class="keyword">static</span> <span class="keyword">int8_t</span> CheckSend[<span class="number">7</span>]=&#123;<span class="number">0xAA</span>,<span class="number">0XAA</span>,<span class="number">0xEF</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;	</span><br><span class="line">						</span><br><span class="line">						CheckSend[<span class="number">4</span>] = ReciveBuffer[<span class="number">2</span>];</span><br><span class="line">						CheckSend[<span class="number">5</span>] = CheckSum;</span><br><span class="line">						CheckSend[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">						<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)</span><br><span class="line">						&#123;</span><br><span class="line">							CheckSend[<span class="number">6</span>] += CheckSend[i]; 					</span><br><span class="line">						&#125;</span><br><span class="line">						USART3_SendByte(CheckSend,<span class="number">7</span>);</span><br><span class="line">						ANO_Recive(ReciveBuffer);			<span class="comment">//To arrange the data	and give the result to control argument.	</span></span><br><span class="line">				&#125;			</span><br><span class="line">				count = <span class="number">0</span>;                  <span class="comment">//return to the first data point,and retore from the head buffer next time.</span></span><br><span class="line">				ReciveBuffer[<span class="number">0</span>] = <span class="number">0</span>;  <span class="comment">//reset the data buffer.</span></span><br><span class="line">				ReciveBuffer[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;							</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Remote.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DATA.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nrf24l01.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;control.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;myMath.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LED.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Remote.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUCCESS 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> FAILED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAILED  1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************************************</span></span><br><span class="line"><span class="comment"> *  通道数据处理    </span></span><br><span class="line"><span class="comment"> ******************************************************************************************/</span>	</span><br><span class="line"><span class="keyword">uint8_t</span> RC_rxData[<span class="number">32</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remote_unlock</span><span class="params">(<span class="keyword">void</span>)</span></span>;	</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RC_Analy</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">uint16_t</span> cnt;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> roll_pitch_ratio = <span class="number">0.04f</span>;</span><br><span class="line">	<span class="keyword">if</span>(NRF24L01_RxPacket(RC_rxData)==SUCCESS)</span><br><span class="line">	&#123; 	</span><br><span class="line"></span><br><span class="line">		<span class="keyword">uint8_t</span> i;</span><br><span class="line">		<span class="keyword">uint8_t</span> CheckSum=<span class="number">0</span>;</span><br><span class="line">		cnt = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">31</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			CheckSum +=  RC_rxData[i];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(RC_rxData[<span class="number">31</span>]==CheckSum &amp;&amp; RC_rxData[<span class="number">0</span>]==<span class="number">0xAA</span> &amp;&amp; RC_rxData[<span class="number">1</span>]==<span class="number">0xAF</span>)  <span class="comment">//如果接收到的遥控数据正确</span></span><br><span class="line">		&#123;</span><br><span class="line">			Remote.roll = ((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">4</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">5</span>];  <span class="comment">//通道1</span></span><br><span class="line">			Remote.roll =Remote.roll &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.roll &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.roll );<span class="comment">//roll限幅</span></span><br><span class="line">			Remote.pitch = ((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">6</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">7</span>];  <span class="comment">//通道2</span></span><br><span class="line">			Remote.pitch =Remote.pitch &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.pitch &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.pitch );</span><br><span class="line">			Remote.thr = 	((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">8</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">9</span>];   <span class="comment">//通道3</span></span><br><span class="line">			Remote.thr =Remote.thr &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.thr &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.thr );<span class="comment">//油门限幅</span></span><br><span class="line">			Remote.yaw =  ((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">10</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">11</span>];   <span class="comment">//通道4</span></span><br><span class="line">			Remote.yaw =Remote.thr &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.yaw &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.yaw );</span><br><span class="line">			Remote.AUX1 =  ((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">12</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">13</span>];   <span class="comment">//通道5  左上角按键都属于通道5  </span></span><br><span class="line">			Remote.AUX1 =Remote.AUX1 &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.AUX1 &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.AUX1 );</span><br><span class="line">			Remote.AUX2 =  ((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">14</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">15</span>];   <span class="comment">//通道6  右上角按键都属于通道6 </span></span><br><span class="line">			Remote.AUX2 =Remote.AUX2 &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.AUX2 &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.AUX2 );</span><br><span class="line">			Remote.AUX3 =  ((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">16</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">17</span>];   <span class="comment">//通道7  左下边按键都属于通道7 </span></span><br><span class="line">			Remote.AUX3 =Remote.AUX3 &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.AUX3 &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.AUX3 );</span><br><span class="line">			Remote.AUX4 =  ((<span class="keyword">uint16_t</span>)RC_rxData[<span class="number">18</span>]&lt;&lt;<span class="number">8</span>) | RC_rxData[<span class="number">19</span>];   <span class="comment">//通道8  右下边按键都属于通道6  </span></span><br><span class="line">			Remote.AUX4 =Remote.AUX4 &lt; <span class="number">1000</span>  ? <span class="number">1000</span> : ( Remote.AUX4 &gt; <span class="number">2000</span>? <span class="number">2000</span> : Remote.AUX4 );</span><br><span class="line">				</span><br><span class="line">			pidPitch.desired =-(Remote.pitch<span class="number">-1500</span>)*roll_pitch_ratio;	 <span class="comment">//将遥杆值作为飞行角度的期望值</span></span><br><span class="line">			pidRoll.desired = -(Remote.roll<span class="number">-1500</span>)*roll_pitch_ratio;</span><br><span class="line">			<span class="keyword">if</span>(Remote.yaw&gt;<span class="number">1820</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				pidYaw.desired += <span class="number">0.75f</span>;	</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(Remote.yaw &lt;<span class="number">1180</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				pidYaw.desired -= <span class="number">0.75f</span>;	</span><br><span class="line">			&#125;						</span><br><span class="line">			remote_unlock();</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//如果3秒没收到遥控数据，则判断遥控信号丢失，飞控在任何时候停止飞行，避免伤人。</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;		</span><br><span class="line">		cnt++;</span><br><span class="line">		<span class="keyword">if</span>(cnt&gt;<span class="number">800</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cnt = <span class="number">0</span>;</span><br><span class="line">			ALL_flag.unlock = <span class="number">0</span>; </span><br><span class="line">			NRF24L01_init();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************************************</span></span><br><span class="line"><span class="comment"> *  解锁判断</span></span><br><span class="line"><span class="comment"> ******************************************************************************************/</span>	</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remote_unlock</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">uint8_t</span> status=WAITING_1;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">uint16_t</span> cnt=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(Remote.thr&lt;<span class="number">1200</span> &amp;&amp;Remote.yaw&lt;<span class="number">1200</span>)                         <span class="comment">//油门遥杆左下角锁定</span></span><br><span class="line">	&#123;</span><br><span class="line">		status = EXIT_255;</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">switch</span>(status)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> WAITING_1:<span class="comment">//等待解锁</span></span><br><span class="line">			<span class="keyword">if</span>(Remote.thr&lt;<span class="number">1150</span>)           <span class="comment">//解锁三步，油门最低-&gt;油门最高-&gt;油门最低 看到LED灯不闪了 即完成解锁</span></span><br><span class="line">			&#123;			 </span><br><span class="line">				status = WAITING_2;				 </span><br><span class="line">			&#125;		</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WAITING_2:</span><br><span class="line">			<span class="keyword">if</span>(Remote.thr&gt;<span class="number">1800</span>)          </span><br><span class="line">			&#123;		</span><br><span class="line">				<span class="keyword">static</span> <span class="keyword">uint8_t</span> cnt = <span class="number">0</span>;</span><br><span class="line">				cnt++;		</span><br><span class="line">				<span class="keyword">if</span>(cnt&gt;<span class="number">5</span>) <span class="comment">//最高油门需保持200ms以上，防止遥控开机初始化未完成的错误数据</span></span><br><span class="line">				&#123;	</span><br><span class="line">						cnt=<span class="number">0</span>;</span><br><span class="line">						status = WAITING_3;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> WAITING_3:</span><br><span class="line">			<span class="keyword">if</span>(Remote.thr&lt;<span class="number">1150</span>)          </span><br><span class="line">			&#123;			 </span><br><span class="line">				status = WAITING_4;				 </span><br><span class="line">			&#125;			</span><br><span class="line">			<span class="keyword">break</span>;			</span><br><span class="line">		<span class="keyword">case</span> WAITING_4:	<span class="comment">//解锁前准备	               </span></span><br><span class="line">			ALL_flag.unlock = <span class="number">1</span>;</span><br><span class="line">			status = PROCESS_31;</span><br><span class="line">			LED.status = AlwaysOn;									</span><br><span class="line">			<span class="keyword">break</span>;		</span><br><span class="line">		<span class="keyword">case</span> PROCESS_31:	<span class="comment">//进入解锁状态</span></span><br><span class="line">			<span class="keyword">if</span>(Remote.thr&lt;<span class="number">1020</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(cnt++ &gt; <span class="number">2000</span>)                                     <span class="comment">// 油门遥杆处于最低6S自动上锁</span></span><br><span class="line">				&#123;								</span><br><span class="line">					status = EXIT_255;								</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(!ALL_flag.unlock)                           <span class="comment">//Other conditions lock </span></span><br><span class="line">			&#123;</span><br><span class="line">				status = EXIT_255;				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>					</span><br><span class="line">				cnt = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EXIT_255: <span class="comment">//进入锁定</span></span><br><span class="line">			LED.status = AllFlashLight;	                                 <span class="comment">//exit</span></span><br><span class="line">			cnt = <span class="number">0</span>;</span><br><span class="line">			LED.FlashTime = <span class="number">300</span>; <span class="comment">//100*3ms		</span></span><br><span class="line">			ALL_flag.unlock = <span class="number">0</span>;</span><br><span class="line">			status = WAITING_1;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			status = EXIT_255;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Control.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DATA.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ALL_DEFINE.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;control.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pid.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> NULL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NULL 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> DISABLE </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISABLE 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> ENABLE </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENABLE 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> REST</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REST 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> SET </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SET 1 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> EMERGENT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EMERGENT 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOTOR1 motor[0] </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOTOR2 motor[1] </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOTOR3 motor[2] </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOTOR4 motor[3] </span></span><br><span class="line"></span><br><span class="line">PidObject *(pPidObject[])=&#123;&amp;pidRateX,&amp;pidRateY,&amp;pidRateZ,&amp;pidRoll,&amp;pidPitch,&amp;pidYaw   <span class="comment">//结构体数组，将每一个数组放一个pid结构体，这样就可以批量操作各个PID的数据了  比如解锁时批量复位pid控制数据，新手明白这句话的作用就可以了</span></span><br><span class="line">		,&amp;pidHeightRate</span><br><span class="line">		,&amp;pidHeightHigh</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FlightPidControl</span><span class="params">(<span class="keyword">float</span> dt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">uint8_t</span> status=WAITING_1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(status)</span><br><span class="line">	&#123;		</span><br><span class="line">		<span class="keyword">case</span> WAITING_1: <span class="comment">//等待解锁</span></span><br><span class="line">			<span class="keyword">if</span>(ALL_flag.unlock)</span><br><span class="line">			&#123;</span><br><span class="line">				status = READY_11;	</span><br><span class="line">			&#125;			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> READY_11:  <span class="comment">//准备进入控制</span></span><br><span class="line">			pidRest(pPidObject,<span class="number">8</span>); <span class="comment">//批量复位PID数据，防止上次遗留的数据影响本次控制</span></span><br><span class="line"></span><br><span class="line">			Angle.yaw = pidYaw.desired =  pidYaw.measured = <span class="number">0</span>;   <span class="comment">//锁定偏航角</span></span><br><span class="line">		</span><br><span class="line">			status = PROCESS_31;</span><br><span class="line">		</span><br><span class="line">			<span class="keyword">break</span>;			</span><br><span class="line">		<span class="keyword">case</span> PROCESS_31: <span class="comment">//正式进入控制</span></span><br><span class="line">			</span><br><span class="line">      pidRateX.measured = MPU6050.gyroX * Gyro_G; <span class="comment">//内环测量值 角度/秒</span></span><br><span class="line">			pidRateY.measured = MPU6050.gyroY * Gyro_G;</span><br><span class="line">			pidRateZ.measured = MPU6050.gyroZ * Gyro_G;</span><br><span class="line">		</span><br><span class="line">			pidPitch.measured = Angle.pitch; <span class="comment">//外环测量值 单位：角度</span></span><br><span class="line">		  pidRoll.measured = Angle.roll;</span><br><span class="line">			pidYaw.measured = Angle.yaw;</span><br><span class="line">		</span><br><span class="line">		 	pidUpdate(&amp;pidRoll,dt);    <span class="comment">//调用PID处理函数来处理外环	横滚角PID		</span></span><br><span class="line">			pidRateX.desired = pidRoll.out; <span class="comment">//将外环的PID输出作为内环PID的期望值即为串级PID</span></span><br><span class="line">			pidUpdate(&amp;pidRateX,dt);  <span class="comment">//再调用内环</span></span><br><span class="line"></span><br><span class="line">		 	pidUpdate(&amp;pidPitch,dt);    <span class="comment">//调用PID处理函数来处理外环	俯仰角PID	</span></span><br><span class="line">			pidRateY.desired = pidPitch.out;  </span><br><span class="line">			pidUpdate(&amp;pidRateY,dt); <span class="comment">//再调用内环</span></span><br><span class="line"></span><br><span class="line">			CascadePID(&amp;pidRateZ,&amp;pidYaw,dt);	<span class="comment">//也可以直接调用串级PID函数来处理</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EXIT_255:  <span class="comment">//退出控制</span></span><br><span class="line">			pidRest(pPidObject,<span class="number">8</span>);</span><br><span class="line">			status = WAITING_1;<span class="comment">//返回等待解锁</span></span><br><span class="line">		  <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			status = EXIT_255;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(ALL_flag.unlock == EMERGENT) <span class="comment">//意外情况，请使用遥控紧急上锁，飞控就可以在任何情况下紧急中止飞行，锁定飞行器，退出PID控制</span></span><br><span class="line">		status = EXIT_255;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int16_t</span> motor[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MotorControl</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">uint8_t</span> status=WAITING_1;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(ALL_flag.unlock == EMERGENT) <span class="comment">//意外情况，请使用遥控紧急上锁，飞控就可以在任何情况下紧急中止飞行，锁定飞行器，退出PID控制</span></span><br><span class="line">		status = EXIT_255;	</span><br><span class="line">	<span class="keyword">switch</span>(status)</span><br><span class="line">	&#123;		</span><br><span class="line">		<span class="keyword">case</span> WAITING_1: <span class="comment">//等待解锁	</span></span><br><span class="line">			MOTOR1 = MOTOR2 = MOTOR3 = MOTOR4 = <span class="number">0</span>;  <span class="comment">//如果锁定，则电机输出都为0</span></span><br><span class="line">			<span class="keyword">if</span>(ALL_flag.unlock)</span><br><span class="line">			&#123;</span><br><span class="line">				status = WAITING_2;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> WAITING_2: <span class="comment">//解锁完成后判断使用者是否开始拨动遥杆进行飞行控制</span></span><br><span class="line">			<span class="keyword">if</span>(Remote.thr&gt;<span class="number">1100</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				status = PROCESS_31;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> PROCESS_31:</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">int16_t</span> temp;</span><br><span class="line">				temp = Remote.thr <span class="number">-1000</span> + pidHeightRate.out; <span class="comment">//油门+定高输出值</span></span><br><span class="line">				<span class="keyword">if</span>(Remote.thr&lt;<span class="number">1020</span>)		<span class="comment">//油门太低了，则限制输出  不然飞机乱转												</span></span><br><span class="line">				&#123;</span><br><span class="line">					MOTOR1 = MOTOR2 = MOTOR3 = MOTOR4=<span class="number">0</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				MOTOR1 = MOTOR2 = MOTOR3 = MOTOR4 = LIMIT(temp,<span class="number">0</span>,<span class="number">900</span>); <span class="comment">//留100给姿态控制</span></span><br><span class="line"></span><br><span class="line">				MOTOR1 +=    + pidRateX.out - pidRateY.out - pidRateZ.out;<span class="comment">//; 姿态输出分配给各个电机的控制量</span></span><br><span class="line">				MOTOR2 +=    + pidRateX.out + pidRateY.out + pidRateZ.out ;<span class="comment">//;</span></span><br><span class="line">				MOTOR3 +=    - pidRateX.out + pidRateY.out - pidRateZ.out;</span><br><span class="line">				MOTOR4 +=    - pidRateX.out - pidRateY.out + pidRateZ.out;<span class="comment">//;</span></span><br><span class="line">			&#125;	</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> EXIT_255:</span><br><span class="line">			MOTOR1 = MOTOR2 = MOTOR3 = MOTOR4 = <span class="number">0</span>;  <span class="comment">//如果锁定，则电机输出都为0</span></span><br><span class="line">			status = WAITING_1;	</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">	TIM2-&gt;CCR1 = LIMIT(MOTOR1,<span class="number">0</span>,<span class="number">1000</span>);  <span class="comment">//更新PWM</span></span><br><span class="line">	TIM2-&gt;CCR2 = LIMIT(MOTOR2,<span class="number">0</span>,<span class="number">1000</span>);</span><br><span class="line">	TIM2-&gt;CCR3 = LIMIT(MOTOR3,<span class="number">0</span>,<span class="number">1000</span>);</span><br><span class="line">	TIM2-&gt;CCR4 = LIMIT(MOTOR4,<span class="number">0</span>,<span class="number">1000</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>kalman.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kalman.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="comment">/*********************************************************************************************************************</span></span><br><span class="line"><span class="comment">**卡尔曼滤波</span></span><br><span class="line"><span class="comment">**@brief: 线性最优评估滤波</span></span><br><span class="line"><span class="comment">**@param[in]  InputData 滤波前的数据，QR误差</span></span><br><span class="line"><span class="comment">**@param[out] None</span></span><br><span class="line"><span class="comment">**@return 滤波后的数据</span></span><br><span class="line"><span class="comment">**@remark: 通过修改过程噪声和测量噪声R,Q值优化输出值</span></span><br><span class="line"><span class="comment">X(k)=A X(k-1)+B U(k)+W(k)  </span></span><br><span class="line"><span class="comment">Z(k)=H X(k)+V(k)</span></span><br><span class="line"><span class="comment">AB是系统参数</span></span><br><span class="line"><span class="comment">XK时刻的系统状态</span></span><br><span class="line"><span class="comment">H：测量系统的参数</span></span><br><span class="line"><span class="comment">Z：K时刻的测量值</span></span><br><span class="line"><span class="comment">WV：过程和测量噪声</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">X(k|k-1)=X(k-1|k-1) 预测下一状态的系统</span></span><br><span class="line"><span class="comment">P(k|k-1)=P(k-1|k-1) +Q  </span></span><br><span class="line"><span class="comment">Kg(k)= P(k|k-1) / (P(k|k-1) + R)   计算Kg卡尔曼增益</span></span><br><span class="line"><span class="comment">X(k|k)= X(k|k-1)+Kg(k) (Z(k)-X(k|k-1))   根据预测值结合估算值得出当前状态值</span></span><br><span class="line"><span class="comment">P(k|k)=(1-Kg(k))P(k|k-1)  更新协方差</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">(k-1|k-1)上一个状态的最优评估</span></span><br><span class="line"><span class="comment">(k|k-1) 由上一个状态的最优评估预测当前状态的最优评估</span></span><br><span class="line"><span class="comment">(k|k)  由预测本状态的评估具体实现最优评估</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Q:系统过程的协方差</span></span><br><span class="line"><span class="comment">R：测量的协方差</span></span><br><span class="line"><span class="comment">高斯白 = Q+R</span></span><br><span class="line"><span class="comment">Kg：卡尔曼增益</span></span><br><span class="line"><span class="comment">P：协方差</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">注:本卡尔曼滤波器争对单模型，单测量H,I均为1，没有控制量U=0，通常对A,B初始值取1</span></span><br><span class="line"><span class="comment">注：X会逐渐收敛，X(0|0)初始测量值状态根据，测量前的数值而定。</span></span><br><span class="line"><span class="comment">注 :   P (0|0)一般不取0，取0意味在0时候的方差为0，系统认为0时刻的值是最优的。然而在实际系统中往往0时刻不是最优的</span></span><br><span class="line"><span class="comment"> **********************************************************************************************************************/</span></span><br><span class="line"> 		<span class="comment">//		const float Q = 0.018;//0.01; </span></span><br><span class="line">		<span class="comment">//		const float R = 0.543;//0.9;			</span></span><br><span class="line"><span class="comment">//float kalman_1(float InputData,float Q,float R)  //一维卡尔曼</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//	struct Kalman&#123;</span></span><br><span class="line"><span class="comment">//		float K_1_K_1;//(k-1|k-1)</span></span><br><span class="line"><span class="comment">//		float K_K_1;  //(k|k-1)</span></span><br><span class="line"><span class="comment">//		float K_K;    //(k|k)</span></span><br><span class="line"><span class="comment">//	&#125;;</span></span><br><span class="line"><span class="comment">//	static struct Kalman P=&#123;0&#125;;</span></span><br><span class="line"><span class="comment">//	static struct Kalman X=&#123;0&#125;;</span></span><br><span class="line"><span class="comment">//	float Kg;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	X.K_K_1 = X.K_1_K_1;</span></span><br><span class="line"><span class="comment">//	P.K_K_1 = P.K_1_K_1 + Q;</span></span><br><span class="line"><span class="comment">//	Kg = P.K_K_1 / (P.K_K_1 + R);</span></span><br><span class="line"><span class="comment">//	X.K_K = X.K_K_1 + Kg * (InputData - X.K_K_1);</span></span><br><span class="line"><span class="comment">//	P.K_K = (1-Kg) * P.K_K_1 ;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	X.K_1_K_1 = X.K_K;</span></span><br><span class="line"><span class="comment">//	P.K_1_K_1 = P.K_K;</span></span><br><span class="line"><span class="comment">//	return X.K_K;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kalman_1</span><span class="params">(struct _1_ekf_filter *ekf,<span class="keyword">float</span> input)</span>  <span class="comment">//一维卡尔曼</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ekf-&gt;Now_P = ekf-&gt;LastP + ekf-&gt;Q;</span><br><span class="line">	ekf-&gt;Kg = ekf-&gt;Now_P / (ekf-&gt;Now_P + ekf-&gt;R);</span><br><span class="line">	ekf-&gt;out = ekf-&gt;out + ekf-&gt;Kg * (input - ekf-&gt;out);</span><br><span class="line">	ekf-&gt;LastP = (<span class="number">1</span>-ekf-&gt;Kg) * ekf-&gt;Now_P ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************</span></span><br><span class="line"><span class="comment">*多维卡尔曼是一维卡尔曼的多维噪声扩展。</span></span><br><span class="line"><span class="comment">*利用角速度估计角度的预测值，同时角度更新角速度的偏置补偿值。</span></span><br><span class="line"><span class="comment">*http://wapwenku.baidu.com/view/0ac55e8cf01dc281e53af0ff?pn=5&amp;pu=</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">kalman_2_Update</span><span class="params">(<span class="keyword">float</span> InputAngle,<span class="keyword">float</span> InputGyro,<span class="keyword">float</span> dt)</span>  <span class="comment">//二维卡尔曼</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Kalman</span>&#123;</span></span><br><span class="line">		<span class="keyword">float</span> k_1_k_1;<span class="comment">//(k-1|k-1)</span></span><br><span class="line">		<span class="keyword">float</span> k_k_1;  <span class="comment">//(k|k-1)</span></span><br><span class="line">		<span class="keyword">float</span> k_k;    <span class="comment">//(k|k)</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">Kalman</span> <span class="title">X</span>=&#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> R_angle=<span class="number">0.5</span>; <span class="comment">//角度计算的过程噪声		</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> h_0=<span class="number">1</span>; <span class="comment">//二维卡尔曼矩阵系数</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> Q_angle=<span class="number">0.001</span>;  </span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> Q_gyro=<span class="number">0.001</span>;	</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">float</span> P[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">float</span> k_0,k_1;</span><br><span class="line">	<span class="keyword">float</span> t0,t1;</span><br><span class="line">	<span class="keyword">float</span> PHt_0;</span><br><span class="line">	<span class="keyword">float</span> PHt_1;</span><br><span class="line">	<span class="keyword">float</span> Pdot[<span class="number">4</span>];	</span><br><span class="line">	<span class="keyword">float</span> E;</span><br><span class="line"><span class="comment">//矩阵	</span></span><br><span class="line"><span class="comment">//A=[1,dt]</span></span><br><span class="line"><span class="comment">//	[0,1 ];</span></span><br><span class="line"><span class="comment">//B=[dt,0];</span></span><br><span class="line"><span class="comment">//H=[1,0];</span></span><br><span class="line"><span class="comment">//P=[a,b]</span></span><br><span class="line">	<span class="comment">//[c,d];</span></span><br><span class="line"><span class="comment">//事实上X输入的也是二维矩阵X[InputAngle,InputGyro]，而初始值即为X.k_1_k_1和Q_bias，可以取0</span></span><br><span class="line"><span class="comment">//--------------------------------		</span></span><br><span class="line"><span class="comment">//X(k|k-1)=A X(k-1|k-1)+B U(k) 	</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">float</span> Q_bias; <span class="comment">//角速度偏置补偿值</span></span><br><span class="line">	X.k_k_1 = X.k_1_k_1 + (InputGyro - Q_bias) * dt; <span class="comment">//用角速度积分预测角度新值</span></span><br><span class="line"><span class="comment">//---------------------------------		</span></span><br><span class="line"><span class="comment">// P(k|k-1)=A P(k-1|k-1) A&#x27;</span></span><br><span class="line"></span><br><span class="line">	Pdot[<span class="number">0</span>]=Q_angle - P[<span class="number">0</span>][<span class="number">1</span>] - P[<span class="number">1</span>][<span class="number">0</span>]; </span><br><span class="line"></span><br><span class="line">	Pdot[<span class="number">1</span>]= - P[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	Pdot[<span class="number">2</span>]= - P[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	Pdot[<span class="number">3</span>]= Q_gyro;</span><br><span class="line"></span><br><span class="line">	P[<span class="number">0</span>][<span class="number">0</span>] += Pdot[<span class="number">0</span>] * dt;</span><br><span class="line"></span><br><span class="line">	P[<span class="number">0</span>][<span class="number">1</span>] += Pdot[<span class="number">1</span>] * dt;</span><br><span class="line"></span><br><span class="line">	P[<span class="number">1</span>][<span class="number">0</span>] += Pdot[<span class="number">2</span>] * dt;</span><br><span class="line"></span><br><span class="line">	P[<span class="number">1</span>][<span class="number">1</span>] += Pdot[<span class="number">3</span>] * dt;</span><br><span class="line">	<span class="comment">//以上各式由矩阵运算得来</span></span><br><span class="line"><span class="comment">//---------------------------------	</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Update covariance matrix:</span></span><br><span class="line"><span class="comment">* (equation 21-3)</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* P = P - K H P</span></span><br><span class="line"><span class="comment">* Let</span></span><br><span class="line"><span class="comment">* Y = H P</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//Kg(k)= P(k|k-1) H&#x27;/ (H P(k|k-1) H&#x27; + R) </span></span><br><span class="line">	PHt_0 = h_0 * P[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	PHt_1 = h_0 * P[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	E = R_angle + h_0 * PHt_0;</span><br><span class="line"></span><br><span class="line">	k_0 = PHt_0 / E;</span><br><span class="line"></span><br><span class="line">	k_1 = PHt_1 / E;</span><br><span class="line"><span class="comment">//---------------------------------	</span></span><br><span class="line"><span class="comment">//P(k|k)=(I-Kg(k) H)P(k|k-1)	</span></span><br><span class="line"></span><br><span class="line">	t0 = PHt_0;</span><br><span class="line"></span><br><span class="line">	t1 = h_0 * P[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	P[<span class="number">0</span>][<span class="number">0</span>] -= k_0 * t0;</span><br><span class="line"></span><br><span class="line">	P[<span class="number">0</span>][<span class="number">1</span>] -= k_0 * t1;</span><br><span class="line"></span><br><span class="line">	P[<span class="number">1</span>][<span class="number">0</span>] -= k_1 * t0;</span><br><span class="line"></span><br><span class="line">	P[<span class="number">1</span>][<span class="number">1</span>] -= k_1 * t1;</span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------	</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Update our state estimate: *</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* Xnew = X + K * error</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* X(k|k)= X(k|k-1)+Kg(k) (Z(k)-X(k|k-1)) </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">	X.k_k = X.k_k_1 + k_0 * (InputAngle - X.k_k_1);</span><br><span class="line"></span><br><span class="line">	Q_bias = Q_bias + k_1 * (InputAngle - X.k_k_1);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	X.k_1_k_1 = X.k_k; <span class="comment">//为下一次计算做准备</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> X.k_k;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对比一维二维的性质，可以扩展N维卡尔曼</span></span><br><span class="line"><span class="comment">/*********************************************END OF FILE ***********************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*******************************二维卡尔曼范例************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">//http://blog.csdn.net/xiahouzuoxin/article/details/39582483</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">	<span class="keyword">float</span> x;</span><br><span class="line">	<span class="keyword">float</span> p;</span><br><span class="line">	<span class="keyword">float</span> A;</span><br><span class="line">	<span class="keyword">float</span> H;</span><br><span class="line">	<span class="keyword">float</span> q;</span><br><span class="line">	<span class="keyword">float</span> r;</span><br><span class="line">	<span class="keyword">float</span> gain;</span><br><span class="line">&#125;kalman1_state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">	<span class="keyword">float</span> x[<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">float</span> p[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">float</span> A[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">float</span> H[<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">float</span> q[<span class="number">2</span>];</span><br><span class="line">	<span class="keyword">float</span> r;</span><br><span class="line">	<span class="keyword">float</span> gain[<span class="number">2</span>];</span><br><span class="line">&#125;kalman2_state;</span><br><span class="line"><span class="comment">/*********************************************************************************************************</span></span><br><span class="line"><span class="comment"> * @brief   </span></span><br><span class="line"><span class="comment"> *   Init fields of structure @kalman1_state.</span></span><br><span class="line"><span class="comment"> *   I make some defaults in this init function:</span></span><br><span class="line"><span class="comment"> *     A = 1;</span></span><br><span class="line"><span class="comment"> *     H = 1; </span></span><br><span class="line"><span class="comment"> *   and @q,@r are valued after prior tests.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   NOTES: Please change A,H,q,r according to your application.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @inputs  </span></span><br><span class="line"><span class="comment"> *   state - Klaman filter structure</span></span><br><span class="line"><span class="comment"> *   init_x - initial x state value   </span></span><br><span class="line"><span class="comment"> *   init_p - initial estimated error convariance</span></span><br><span class="line"><span class="comment"> * @outputs </span></span><br><span class="line"><span class="comment"> * @retval  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kalman1_init</span><span class="params">(kalman1_state *state, <span class="keyword">float</span> init_x, <span class="keyword">float</span> init_p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    state-&gt;x = init_x;</span><br><span class="line">    state-&gt;p = init_p;</span><br><span class="line">    state-&gt;A = <span class="number">1</span>;</span><br><span class="line">    state-&gt;H = <span class="number">1</span>;</span><br><span class="line">    state-&gt;q = <span class="number">2e2</span>;<span class="comment">//10e-6;  /* predict noise convariance */</span></span><br><span class="line">    state-&gt;r = <span class="number">5e2</span>;<span class="comment">//10e-5;  /* measure error convariance */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*********************************************************************************************************</span></span><br><span class="line"><span class="comment"> * @brief   </span></span><br><span class="line"><span class="comment"> *   1 Dimension Kalman filter</span></span><br><span class="line"><span class="comment"> * @inputs  </span></span><br><span class="line"><span class="comment"> *   state - Klaman filter structure</span></span><br><span class="line"><span class="comment"> *   z_measure - Measure value</span></span><br><span class="line"><span class="comment"> * @outputs </span></span><br><span class="line"><span class="comment"> * @retval  </span></span><br><span class="line"><span class="comment"> *   Estimated result</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">kalman1_filter</span><span class="params">(kalman1_state *state, <span class="keyword">float</span> z_measure)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Predict */</span></span><br><span class="line">    state-&gt;x = state-&gt;A * state-&gt;x;</span><br><span class="line">    state-&gt;p = state-&gt;A * state-&gt;A * state-&gt;p + state-&gt;q;  <span class="comment">/* p(n|n-1)=A^2*p(n-1|n-1)+q */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Measurement */</span></span><br><span class="line">    state-&gt;gain = state-&gt;p * state-&gt;H / (state-&gt;p * state-&gt;H * state-&gt;H + state-&gt;r);</span><br><span class="line">    state-&gt;x = state-&gt;x + state-&gt;gain * (z_measure - state-&gt;H * state-&gt;x);</span><br><span class="line">    state-&gt;p = (<span class="number">1</span> - state-&gt;gain * state-&gt;H) * state-&gt;p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state-&gt;x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************************************************************************************************</span></span><br><span class="line"><span class="comment"> * @brief   </span></span><br><span class="line"><span class="comment"> *   Init fields of structure @kalman1_state.</span></span><br><span class="line"><span class="comment"> *   I make some defaults in this init function:</span></span><br><span class="line"><span class="comment"> *     A = &#123;&#123;1, 0.1&#125;, &#123;0, 1&#125;&#125;;</span></span><br><span class="line"><span class="comment"> *     H = &#123;1,0&#125;; </span></span><br><span class="line"><span class="comment"> *   and @q,@r are valued after prior tests. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   NOTES: Please change A,H,q,r according to your application.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @inputs  </span></span><br><span class="line"><span class="comment"> * @outputs </span></span><br><span class="line"><span class="comment"> * @retval  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kalman2_init</span><span class="params">(kalman2_state *state, <span class="keyword">float</span> *init_x, <span class="keyword">float</span> (*init_p)[<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    state-&gt;x[<span class="number">0</span>]    = init_x[<span class="number">0</span>];</span><br><span class="line">    state-&gt;x[<span class="number">1</span>]    = init_x[<span class="number">1</span>];</span><br><span class="line">    state-&gt;p[<span class="number">0</span>][<span class="number">0</span>] = init_p[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    state-&gt;p[<span class="number">0</span>][<span class="number">1</span>] = init_p[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">    state-&gt;p[<span class="number">1</span>][<span class="number">0</span>] = init_p[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">    state-&gt;p[<span class="number">1</span>][<span class="number">1</span>] = init_p[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">    <span class="comment">//state-&gt;A       = &#123;&#123;1, 0.1&#125;, &#123;0, 1&#125;&#125;;</span></span><br><span class="line">    state-&gt;A[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    state-&gt;A[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">0.1</span>;</span><br><span class="line">    state-&gt;A[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    state-&gt;A[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//state-&gt;H       = &#123;1,0&#125;;</span></span><br><span class="line">    state-&gt;H[<span class="number">0</span>]    = <span class="number">1</span>;</span><br><span class="line">    state-&gt;H[<span class="number">1</span>]    = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//state-&gt;q       = &#123;&#123;10e-6,0&#125;, &#123;0,10e-6&#125;&#125;;  /* measure noise convariance */</span></span><br><span class="line">    state-&gt;q[<span class="number">0</span>]    = <span class="number">10e-7</span>;</span><br><span class="line">    state-&gt;q[<span class="number">1</span>]    = <span class="number">10e-7</span>;</span><br><span class="line">    state-&gt;r       = <span class="number">10e-7</span>;  <span class="comment">/* estimated error convariance */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************************************************************************************************</span></span><br><span class="line"><span class="comment"> * @brief   </span></span><br><span class="line"><span class="comment"> *   2 Dimension kalman filter</span></span><br><span class="line"><span class="comment"> * @inputs  </span></span><br><span class="line"><span class="comment"> *   state - Klaman filter structure</span></span><br><span class="line"><span class="comment"> *   z_measure - Measure value</span></span><br><span class="line"><span class="comment"> * @outputs </span></span><br><span class="line"><span class="comment"> *   state-&gt;x[0] - Updated state value, Such as angle,velocity</span></span><br><span class="line"><span class="comment"> *   state-&gt;x[1] - Updated state value, Such as diffrence angle, acceleration</span></span><br><span class="line"><span class="comment"> *   state-&gt;p    - Updated estimated error convatiance matrix</span></span><br><span class="line"><span class="comment"> * @retval  </span></span><br><span class="line"><span class="comment"> *   Return value is equals to state-&gt;x[0], so maybe angle or velocity.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">kalman2_filter</span><span class="params">(kalman2_state *state, <span class="keyword">float</span> z_measure)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">float</span> temp0;</span><br><span class="line">    <span class="keyword">float</span> temp1;</span><br><span class="line">    <span class="keyword">float</span> temp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step1: Predict */</span></span><br><span class="line">    state-&gt;x[<span class="number">0</span>] = state-&gt;A[<span class="number">0</span>][<span class="number">0</span>] * state-&gt;x[<span class="number">0</span>] + state-&gt;A[<span class="number">0</span>][<span class="number">1</span>] * state-&gt;x[<span class="number">1</span>];</span><br><span class="line">    state-&gt;x[<span class="number">1</span>] = state-&gt;A[<span class="number">1</span>][<span class="number">0</span>] * state-&gt;x[<span class="number">0</span>] + state-&gt;A[<span class="number">1</span>][<span class="number">1</span>] * state-&gt;x[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">/* p(n|n-1)=A^2*p(n-1|n-1)+q */</span></span><br><span class="line">    state-&gt;p[<span class="number">0</span>][<span class="number">0</span>] = state-&gt;A[<span class="number">0</span>][<span class="number">0</span>] * state-&gt;p[<span class="number">0</span>][<span class="number">0</span>] + state-&gt;A[<span class="number">0</span>][<span class="number">1</span>] * state-&gt;p[<span class="number">1</span>][<span class="number">0</span>] + state-&gt;q[<span class="number">0</span>];</span><br><span class="line">    state-&gt;p[<span class="number">0</span>][<span class="number">1</span>] = state-&gt;A[<span class="number">0</span>][<span class="number">0</span>] * state-&gt;p[<span class="number">0</span>][<span class="number">1</span>] + state-&gt;A[<span class="number">1</span>][<span class="number">1</span>] * state-&gt;p[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">    state-&gt;p[<span class="number">1</span>][<span class="number">0</span>] = state-&gt;A[<span class="number">1</span>][<span class="number">0</span>] * state-&gt;p[<span class="number">0</span>][<span class="number">0</span>] + state-&gt;A[<span class="number">0</span>][<span class="number">1</span>] * state-&gt;p[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">    state-&gt;p[<span class="number">1</span>][<span class="number">1</span>] = state-&gt;A[<span class="number">1</span>][<span class="number">0</span>] * state-&gt;p[<span class="number">0</span>][<span class="number">1</span>] + state-&gt;A[<span class="number">1</span>][<span class="number">1</span>] * state-&gt;p[<span class="number">1</span>][<span class="number">1</span>] + state-&gt;q[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Step2: Measurement */</span></span><br><span class="line">    <span class="comment">/* gain = p * H^T * [r + H * p * H^T]^(-1), H^T means transpose. */</span></span><br><span class="line">    temp0 = state-&gt;p[<span class="number">0</span>][<span class="number">0</span>] * state-&gt;H[<span class="number">0</span>] + state-&gt;p[<span class="number">0</span>][<span class="number">1</span>] * state-&gt;H[<span class="number">1</span>];</span><br><span class="line">    temp1 = state-&gt;p[<span class="number">1</span>][<span class="number">0</span>] * state-&gt;H[<span class="number">0</span>] + state-&gt;p[<span class="number">1</span>][<span class="number">1</span>] * state-&gt;H[<span class="number">1</span>];</span><br><span class="line">    temp  = state-&gt;r + state-&gt;H[<span class="number">0</span>] * temp0 + state-&gt;H[<span class="number">1</span>] * temp1;</span><br><span class="line">    state-&gt;gain[<span class="number">0</span>] = temp0 / temp;</span><br><span class="line">    state-&gt;gain[<span class="number">1</span>] = temp1 / temp;</span><br><span class="line">    <span class="comment">/* x(n|n) = x(n|n-1) + gain(n) * [z_measure - H(n)*x(n|n-1)]*/</span></span><br><span class="line">    temp = state-&gt;H[<span class="number">0</span>] * state-&gt;x[<span class="number">0</span>] + state-&gt;H[<span class="number">1</span>] * state-&gt;x[<span class="number">1</span>];</span><br><span class="line">    state-&gt;x[<span class="number">0</span>] = state-&gt;x[<span class="number">0</span>] + state-&gt;gain[<span class="number">0</span>] * (z_measure - temp); </span><br><span class="line">    state-&gt;x[<span class="number">1</span>] = state-&gt;x[<span class="number">1</span>] + state-&gt;gain[<span class="number">1</span>] * (z_measure - temp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Update @p: p(n|n) = [I - gain * H] * p(n|n-1) */</span></span><br><span class="line">    state-&gt;p[<span class="number">0</span>][<span class="number">0</span>] = (<span class="number">1</span> - state-&gt;gain[<span class="number">0</span>] * state-&gt;H[<span class="number">0</span>]) * state-&gt;p[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    state-&gt;p[<span class="number">0</span>][<span class="number">1</span>] = (<span class="number">1</span> - state-&gt;gain[<span class="number">0</span>] * state-&gt;H[<span class="number">1</span>]) * state-&gt;p[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">    state-&gt;p[<span class="number">1</span>][<span class="number">0</span>] = (<span class="number">1</span> - state-&gt;gain[<span class="number">1</span>] * state-&gt;H[<span class="number">0</span>]) * state-&gt;p[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">    state-&gt;p[<span class="number">1</span>][<span class="number">1</span>] = (<span class="number">1</span> - state-&gt;gain[<span class="number">1</span>] * state-&gt;H[<span class="number">1</span>]) * state-&gt;p[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state-&gt;x[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*******************************三维卡尔曼范例************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">/*********************************************************************************************************/</span></span><br><span class="line"><span class="comment">//https://www.embbnux.com/2015/01/30/9_dof_imu_with_kalman_filter_on_avr/</span></span><br><span class="line"><span class="comment">//算法实现</span></span><br><span class="line"><span class="comment">//kalman.c</span></span><br><span class="line"><span class="keyword">float</span> dtTimer   = <span class="number">0.008</span>;</span><br><span class="line"><span class="keyword">float</span> xk[<span class="number">9</span>] = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">float</span> pk[<span class="number">9</span>] = &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">float</span> I[<span class="number">9</span>]  = &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">float</span> R[<span class="number">9</span>]  = &#123;<span class="number">0.5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.01</span>&#125;;</span><br><span class="line"><span class="keyword">float</span> Q[<span class="number">9</span>] = &#123;<span class="number">0.005</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.005</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.001</span>&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">matrix_add</span><span class="params">(<span class="keyword">float</span>* mata,<span class="keyword">float</span>* matb,<span class="keyword">float</span>* matc)</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> i,j;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++)&#123;</span><br><span class="line">       <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;<span class="number">3</span>; j++)&#123;</span><br><span class="line">          matc[i*<span class="number">3</span>+j] = mata[i*<span class="number">3</span>+j] + matb[i*<span class="number">3</span>+j];</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">matrix_sub</span><span class="params">(<span class="keyword">float</span>* mata,<span class="keyword">float</span>* matb,<span class="keyword">float</span>* matc)</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> i,j;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++)&#123;</span><br><span class="line">       <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;<span class="number">3</span>; j++)&#123;</span><br><span class="line">          matc[i*<span class="number">3</span>+j] = mata[i*<span class="number">3</span>+j] - matb[i*<span class="number">3</span>+j];</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">matrix_multi</span><span class="params">(<span class="keyword">float</span>* mata,<span class="keyword">float</span>* matb,<span class="keyword">float</span>* matc)</span></span>&#123;</span><br><span class="line">  <span class="keyword">uint8_t</span> i,j,m;</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;<span class="number">3</span>; j++)</span><br><span class="line">   &#123;</span><br><span class="line">      matc[i*<span class="number">3</span>+j]=<span class="number">0.0</span>;</span><br><span class="line">      <span class="keyword">for</span> (m=<span class="number">0</span>; m&lt;<span class="number">3</span>; m++)</span><br><span class="line">     &#123;</span><br><span class="line">        matc[i*<span class="number">3</span>+j] += mata[i*<span class="number">3</span>+m] * matb[m*<span class="number">3</span>+j];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KalmanFilter</span><span class="params">(<span class="keyword">float</span>* am_angle_mat,<span class="keyword">float</span>* gyro_angle_mat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		<span class="keyword">uint8_t</span> i,j;</span><br><span class="line">		<span class="keyword">float</span> yk[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">float</span> pk_new[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">float</span> K[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">float</span> KxYk[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">float</span> I_K[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">float</span> S[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">float</span> S_invert[<span class="number">9</span>];</span><br><span class="line">		<span class="keyword">float</span> sdet;</span><br><span class="line">		 </span><br><span class="line">		<span class="comment">//xk = xk + uk</span></span><br><span class="line">		matrix_add(xk,gyro_angle_mat,xk);</span><br><span class="line">		<span class="comment">//pk = pk + Q</span></span><br><span class="line">		matrix_add(pk,Q,pk);</span><br><span class="line">		<span class="comment">//yk =  xnew - xk</span></span><br><span class="line">		matrix_sub(am_angle_mat,xk,yk);</span><br><span class="line">		<span class="comment">//S=Pk + R</span></span><br><span class="line">		matrix_add(pk,R,S);</span><br><span class="line">		<span class="comment">//S??invert</span></span><br><span class="line">		sdet = S[<span class="number">0</span>] * S[<span class="number">4</span>] * S[<span class="number">8</span>]</span><br><span class="line">							+ S[<span class="number">1</span>] * S[<span class="number">5</span>] * S[<span class="number">6</span>]</span><br><span class="line">							+ S[<span class="number">2</span>] * S[<span class="number">3</span>] * S[<span class="number">7</span>]</span><br><span class="line">							- S[<span class="number">2</span>] * S[<span class="number">4</span>] * S[<span class="number">6</span>]</span><br><span class="line">							- S[<span class="number">5</span>] * S[<span class="number">7</span>] * S[<span class="number">0</span>]</span><br><span class="line">							- S[<span class="number">8</span>] * S[<span class="number">1</span>] * S[<span class="number">3</span>];</span><br><span class="line">		 </span><br><span class="line">		S_invert[<span class="number">0</span>] = (S[<span class="number">4</span>] * S[<span class="number">8</span>] - S[<span class="number">5</span>] * S[<span class="number">7</span>])/sdet;</span><br><span class="line">		S_invert[<span class="number">1</span>] = (S[<span class="number">2</span>] * S[<span class="number">7</span>] - S[<span class="number">1</span>] * S[<span class="number">8</span>])/sdet;</span><br><span class="line">		S_invert[<span class="number">2</span>] = (S[<span class="number">1</span>] * S[<span class="number">7</span>] - S[<span class="number">4</span>] * S[<span class="number">6</span>])/sdet;</span><br><span class="line">		 </span><br><span class="line">		S_invert[<span class="number">3</span>] = (S[<span class="number">5</span>] * S[<span class="number">6</span>] - S[<span class="number">3</span>] * S[<span class="number">8</span>])/sdet;</span><br><span class="line">		S_invert[<span class="number">4</span>] = (S[<span class="number">0</span>] * S[<span class="number">8</span>] - S[<span class="number">2</span>] * S[<span class="number">6</span>])/sdet;</span><br><span class="line">		S_invert[<span class="number">5</span>] = (S[<span class="number">2</span>] * S[<span class="number">3</span>] - S[<span class="number">0</span>] * S[<span class="number">5</span>])/sdet;</span><br><span class="line">		 </span><br><span class="line">		S_invert[<span class="number">6</span>] = (S[<span class="number">3</span>] * S[<span class="number">7</span>] - S[<span class="number">4</span>] * S[<span class="number">6</span>])/sdet;</span><br><span class="line">		S_invert[<span class="number">7</span>] = (S[<span class="number">1</span>] * S[<span class="number">6</span>] - S[<span class="number">0</span>] * S[<span class="number">7</span>])/sdet;</span><br><span class="line">		S_invert[<span class="number">8</span>] = (S[<span class="number">0</span>] * S[<span class="number">4</span>] - S[<span class="number">1</span>] * S[<span class="number">3</span>])/sdet;</span><br><span class="line">		<span class="comment">//K = Pk * S_invert</span></span><br><span class="line">		matrix_multi(pk,S_invert,K);</span><br><span class="line">		<span class="comment">//KxYk = K * Yk</span></span><br><span class="line">		matrix_multi(K,yk,KxYk);</span><br><span class="line">		<span class="comment">//xk = xk + K * yk</span></span><br><span class="line">		matrix_add(xk,KxYk,xk);</span><br><span class="line">		<span class="comment">//pk = (I - K)*(pk)</span></span><br><span class="line">		matrix_sub(I,K,I_K);</span><br><span class="line">		matrix_multi(I_K,pk,pk_new);</span><br><span class="line">		<span class="comment">//update pk</span></span><br><span class="line">		<span class="comment">//pk = pk_new;</span></span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++)</span><br><span class="line">		&#123;</span><br><span class="line">				<span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;<span class="number">3</span>; j++)</span><br><span class="line">				&#123;</span><br><span class="line">						pk[i*<span class="number">3</span>+j] = pk_new[i*<span class="number">3</span>+j];</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PID.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pid.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;myMath.h&quot;</span>	</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************</span></span><br><span class="line"><span class="comment"> *批量复位PID函数</span></span><br><span class="line"><span class="comment"> * @param[in] </span></span><br><span class="line"><span class="comment"> * @param[out] </span></span><br><span class="line"><span class="comment"> * @return     </span></span><br><span class="line"><span class="comment"> ***************************************************************/</span>	</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pidRest</span><span class="params">(PidObject **pid,<span class="keyword">const</span> <span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint8_t</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">	&#123;</span><br><span class="line">	  	pid[i]-&gt;integ = <span class="number">0</span>;</span><br><span class="line">	    pid[i]-&gt;prevError = <span class="number">0</span>;</span><br><span class="line">	    pid[i]-&gt;out = <span class="number">0</span>;</span><br><span class="line">		pid[i]-&gt;offset = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************</span></span><br><span class="line"><span class="comment"> * Update the PID parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param[in] pid         A pointer to the pid object.</span></span><br><span class="line"><span class="comment"> * @param[in] measured    The measured value</span></span><br><span class="line"><span class="comment"> * @param[in] updateError Set to TRUE if error should be calculated.</span></span><br><span class="line"><span class="comment"> *                        Set to False if pidSetError() has been used.</span></span><br><span class="line"><span class="comment"> * @return PID algorithm output</span></span><br><span class="line"><span class="comment"> ***************************************************************/</span>	</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pidUpdate</span><span class="params">(PidObject* pid,<span class="keyword">const</span> <span class="keyword">float</span> dt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	 <span class="keyword">float</span> error;</span><br><span class="line">	 <span class="keyword">float</span> deriv;</span><br><span class="line">	</span><br><span class="line">    error = pid-&gt;desired - pid-&gt;measured; <span class="comment">//当前角度与实际角度的误差</span></span><br><span class="line"></span><br><span class="line">    pid-&gt;integ += error * dt;	 <span class="comment">//误差积分累加值</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//  pid-&gt;integ = LIMIT(pid-&gt;integ,pid-&gt;IntegLimitLow,pid-&gt;IntegLimitHigh); //进行积分限幅</span></span><br><span class="line"></span><br><span class="line">    deriv = (error - pid-&gt;prevError)/dt;  <span class="comment">//前后两次误差做微分</span></span><br><span class="line">	</span><br><span class="line">    pid-&gt;out = pid-&gt;kp * error + pid-&gt;ki * pid-&gt;integ + pid-&gt;kd * deriv;<span class="comment">//PID输出</span></span><br><span class="line">	</span><br><span class="line">		<span class="comment">//pid-&gt;out = LIMIT(pid-&gt;out,pid-&gt;OutLimitLow,pid-&gt;OutLimitHigh); //输出限幅</span></span><br><span class="line">		</span><br><span class="line">    pid-&gt;prevError = error;  <span class="comment">//更新上次的误差</span></span><br><span class="line">		</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************</span></span><br><span class="line"><span class="comment"> *  CascadePID</span></span><br><span class="line"><span class="comment"> * @param[in] </span></span><br><span class="line"><span class="comment"> * @param[out] </span></span><br><span class="line"><span class="comment"> * @return     </span></span><br><span class="line"><span class="comment"> ***************************************************************/</span>	</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CascadePID</span><span class="params">(PidObject* pidRate,PidObject* pidAngE,<span class="keyword">const</span> <span class="keyword">float</span> dt)</span>  <span class="comment">//串级PID</span></span></span><br><span class="line"><span class="function"></span>&#123;	 </span><br><span class="line">	pidUpdate(pidAngE,dt);    <span class="comment">//先计算外环</span></span><br><span class="line">	pidRate-&gt;desired = pidAngE-&gt;out;</span><br><span class="line">	pidUpdate(pidRate,dt);    <span class="comment">//再计算内环	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IMU.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******************************************************************************************************</span></span><br><span class="line"><span class="comment"> * Update the PID parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param[in] pid         A pointer to the pid object.</span></span><br><span class="line"><span class="comment"> * @param[in] measured    The measured value</span></span><br><span class="line"><span class="comment"> * @param[in] updateError Set to TRUE if error should be calculated.</span></span><br><span class="line"><span class="comment"> *                        Set to False if pidSetError() has been used.</span></span><br><span class="line"><span class="comment"> * @return PID algorithm output</span></span><br><span class="line"><span class="comment"> *******************************************************************************************************/</span>	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;imu.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;myMath.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">float</span> NormAcc;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">//float ex_int = 0, ey_int = 0, ez_int = 0;   //X、Y、Z轴的比例误差</span></span><br><span class="line"><span class="comment">//float q0 = 1, q1 = 0, q2 = 0, q3 = 0;    //定义四元素</span></span><br><span class="line"><span class="comment">//float his_q0 = 1, his_q1 = 0, his_q2 = 0, his_q3 = 0; </span></span><br><span class="line"><span class="comment">//float q0_yaw = 1, q1_yaw = 0, q2_yaw = 0, q3_yaw = 0;    //弥补Mahony算法在无地磁情况解算Yaw轴满足不了大扰动要求的现象</span></span><br><span class="line"><span class="comment">//float his_q0_yaw = 1, his_q1_yaw = 0, his_q2_yaw = 0, his_q3_yaw = 0;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//void GetAngle(const stMpu *pMpu,void *pAngE, float dt) </span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//	static const float KpDef = 0.85f ;</span></span><br><span class="line"><span class="comment">//	static const float KiDef = 0.0035f;</span></span><br><span class="line"><span class="comment">//	const float Gyro_Gr = 0.0005326f;     //面计算度每秒,转换弧度每秒则 0.03051756	 * 0.0174533f = 0.0005326</span></span><br><span class="line"><span class="comment">//	float HalfTime = 0.5 * dt;</span></span><br><span class="line"><span class="comment">//	float gx = pMpu-&gt;gyroX	*	Gyro_Gr;</span></span><br><span class="line"><span class="comment">//	float gy = pMpu-&gt;gyroY	*	Gyro_Gr;</span></span><br><span class="line"><span class="comment">//	float gz = pMpu-&gt;gyroZ	*	Gyro_Gr;</span></span><br><span class="line"><span class="comment">//	float ax =  pMpu-&gt;accX;</span></span><br><span class="line"><span class="comment">//	float	ay =  pMpu-&gt;accY;</span></span><br><span class="line"><span class="comment">//	float az =  pMpu-&gt;accZ;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	float vx, vy, vz;</span></span><br><span class="line"><span class="comment">//  float ex, ey, ez;</span></span><br><span class="line"><span class="comment">//		</span></span><br><span class="line"><span class="comment">//	static float his_q0q0;</span></span><br><span class="line"><span class="comment">//  static float his_q0q1;</span></span><br><span class="line"><span class="comment">//  static float his_q0q2;</span></span><br><span class="line"><span class="comment">//  static float his_q1q1;</span></span><br><span class="line"><span class="comment">//  static float his_q1q3;</span></span><br><span class="line"><span class="comment">//  static float his_q2q2;</span></span><br><span class="line"><span class="comment">//  static float his_q2q3;</span></span><br><span class="line"><span class="comment">//  static float his_q3q3;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	float q0q0;</span></span><br><span class="line"><span class="comment">//  float q0q1;</span></span><br><span class="line"><span class="comment">//  float q0q2;</span></span><br><span class="line"><span class="comment">//  float q1q1;</span></span><br><span class="line"><span class="comment">//  float q1q3;</span></span><br><span class="line"><span class="comment">//  float q2q2;</span></span><br><span class="line"><span class="comment">//  float q2q3;</span></span><br><span class="line"><span class="comment">//  float q3q3;		</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	float	q0_yawq0_yaw;</span></span><br><span class="line"><span class="comment">//	float	q1_yawq1_yaw;</span></span><br><span class="line"><span class="comment">//	float	q2_yawq2_yaw;</span></span><br><span class="line"><span class="comment">//	float	q3_yawq3_yaw;</span></span><br><span class="line"><span class="comment">//	float	q1_yawq2_yaw;</span></span><br><span class="line"><span class="comment">//	float	q0_yawq3_yaw;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">////**************************Yaw轴计算******************************</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	//Yaw轴四元素的微分方程</span></span><br><span class="line"><span class="comment">//  q0_yaw = his_q0_yaw + (-his_q1_yaw * gx - his_q2_yaw * gy - his_q3_yaw * gz) * HalfTime;</span></span><br><span class="line"><span class="comment">//  q1_yaw = his_q1_yaw + ( his_q0_yaw * gx + his_q2_yaw * gz - his_q3_yaw * gy) * HalfTime;</span></span><br><span class="line"><span class="comment">//  q2_yaw = his_q2_yaw + ( his_q0_yaw * gy - his_q1_yaw * gz + his_q3_yaw * gx) * HalfTime;</span></span><br><span class="line"><span class="comment">//  q3_yaw = his_q3_yaw + ( his_q0_yaw * gz + his_q1_yaw * gy - his_q2_yaw * gx) * HalfTime;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	q0_yawq0_yaw = q0_yaw * q0_yaw;</span></span><br><span class="line"><span class="comment">//	q1_yawq1_yaw = q1_yaw * q1_yaw;</span></span><br><span class="line"><span class="comment">//	q2_yawq2_yaw = q2_yaw * q2_yaw;</span></span><br><span class="line"><span class="comment">//	q3_yawq3_yaw = q3_yaw * q3_yaw;</span></span><br><span class="line"><span class="comment">//	q1_yawq2_yaw = q1_yaw * q2_yaw;</span></span><br><span class="line"><span class="comment">//	q0_yawq3_yaw = q0_yaw * q3_yaw;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	//规范化Yaw轴四元数</span></span><br><span class="line"><span class="comment">//  norm = Q_rsqrt(q0_yawq0_yaw + q1_yawq1_yaw + q2_yawq2_yaw + q3_yawq3_yaw);</span></span><br><span class="line"><span class="comment">//  q0_yaw = q0_yaw * norm;</span></span><br><span class="line"><span class="comment">//  q1_yaw = q1_yaw * norm;</span></span><br><span class="line"><span class="comment">//  q2_yaw = q2_yaw * norm;</span></span><br><span class="line"><span class="comment">//  q3_yaw = q3_yaw * norm;	</span></span><br><span class="line"><span class="comment">//  </span></span><br><span class="line"><span class="comment">//	//if(ax * ay * az	== 0)</span></span><br><span class="line"><span class="comment">//	//return ;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	//归一化加速度计值</span></span><br><span class="line"><span class="comment">//  norm = Q_rsqrt(ax * ax + ay * ay + az * az); </span></span><br><span class="line"><span class="comment">//  ax = ax * norm;</span></span><br><span class="line"><span class="comment">//  ay = ay * norm;</span></span><br><span class="line"><span class="comment">//  az = az * norm;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	//由姿态阵估计重力方向和流量/变迁</span></span><br><span class="line"><span class="comment">//  vx = 2 * (his_q1q3 - his_q0q2);											</span></span><br><span class="line"><span class="comment">//  vy = 2 * (his_q0q1 + his_q2q3);</span></span><br><span class="line"><span class="comment">//  vz = his_q0q0 - his_q1q1 - his_q2q2 + his_q3q3;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//  //向量外积再相减得到差分就是误差 两个单位向量的差积即为误差向量</span></span><br><span class="line"><span class="comment">//  ex = (ay * vz - az * vy) ;      </span></span><br><span class="line"><span class="comment">//  ey = (az * vx - ax * vz) ;</span></span><br><span class="line"><span class="comment">//  ez = (ax * vy - ay * vx) ;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//	//对误差进行PI计算</span></span><br><span class="line"><span class="comment">//  ex_int = ex_int + ex * KiDef;			</span></span><br><span class="line"><span class="comment">//  ey_int = ey_int + ey * KiDef;</span></span><br><span class="line"><span class="comment">//  ez_int = ez_int + ez * KiDef;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  //校正陀螺仪</span></span><br><span class="line"><span class="comment">//  gx = gx + KpDef * ex + ex_int;					</span></span><br><span class="line"><span class="comment">//  gy = gy + KpDef * ey + ey_int;</span></span><br><span class="line"><span class="comment">//  gz = gz + KpDef * ez + ez_int;			</span></span><br><span class="line"><span class="comment">//			</span></span><br><span class="line"><span class="comment">//	//四元素的微分方程</span></span><br><span class="line"><span class="comment">//  q0 = his_q0 + (-his_q1 * gx - his_q2 * gy - his_q3 *	gz)	*	HalfTime;</span></span><br><span class="line"><span class="comment">//  q1 = his_q1 + ( his_q0 * gx + his_q2 * gz - his_q3 *	gy)	*	HalfTime;</span></span><br><span class="line"><span class="comment">//  q2 = his_q2 + ( his_q0 * gy - his_q1 * gz + his_q3 *	gx)	*	HalfTime;</span></span><br><span class="line"><span class="comment">//  q3 = his_q3 + ( his_q0 * gz + his_q1 * gy - his_q2 *	gx)	*	HalfTime;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//	q0q0 = q0 * q0;</span></span><br><span class="line"><span class="comment">//	q0q1 = q0 * q1;</span></span><br><span class="line"><span class="comment">//	q0q2 = q0 * q2;</span></span><br><span class="line"><span class="comment">//	q1q1 = q1 * q1;</span></span><br><span class="line"><span class="comment">//	q1q3 = q1 * q3;</span></span><br><span class="line"><span class="comment">//	q2q2 = q2	* q2;</span></span><br><span class="line"><span class="comment">//	q2q3 = q2	*	q3;</span></span><br><span class="line"><span class="comment">//	q3q3 = q3	*	q3;	</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  //规范化Pitch、Roll轴四元数</span></span><br><span class="line"><span class="comment">//  norm = Q_rsqrt(q0q0 + q1q1 + q2q2 + q3q3);</span></span><br><span class="line"><span class="comment">//  q0 = q0 * norm;</span></span><br><span class="line"><span class="comment">//  q1 = q1 * norm;</span></span><br><span class="line"><span class="comment">//  q2 = q2 * norm;</span></span><br><span class="line"><span class="comment">//  q3 = q3 * norm;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	//求解欧拉角</span></span><br><span class="line"><span class="comment">//	*((float *)pAngE+2) = atan2f(2 * q2q3 + 2 * q0q1, -2 * q1q1 - 2 * q2q2 + 1) * RtA;  //ROLL</span></span><br><span class="line"><span class="comment">//	*((float *)pAngE+1) = asin(2 * q0q2 -2 * q1q3) * 57.3;  //PITCH</span></span><br><span class="line"><span class="comment">//	*(float *)pAngE = atan2f(2 * q1_yawq2_yaw + 2 * q0_yawq3_yaw, -2 * q2_yawq2_yaw - 2 * q3_yawq3_yaw + 1)	* RtA;  //YAW</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//  //存储更替相应的四元数</span></span><br><span class="line"><span class="comment">//	his_q0_yaw = q0_yaw;</span></span><br><span class="line"><span class="comment">//  his_q1_yaw = q1_yaw;</span></span><br><span class="line"><span class="comment">//  his_q2_yaw = q2_yaw;</span></span><br><span class="line"><span class="comment">//  his_q3_yaw = q3_yaw;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//	his_q0 = q0;</span></span><br><span class="line"><span class="comment">//  his_q1 = q1;</span></span><br><span class="line"><span class="comment">//  his_q2 = q2;</span></span><br><span class="line"><span class="comment">//  his_q3 = q3;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	his_q0q0 = q0q0;</span></span><br><span class="line"><span class="comment">//	his_q0q1 = q0q1;</span></span><br><span class="line"><span class="comment">//	his_q0q2 = q0q2;</span></span><br><span class="line"><span class="comment">//	his_q1q1 = q1q1;</span></span><br><span class="line"><span class="comment">//	his_q1q3 = q1q3;</span></span><br><span class="line"><span class="comment">//	his_q2q2 = q2q2;</span></span><br><span class="line"><span class="comment">//	his_q2q3 = q2q3;</span></span><br><span class="line"><span class="comment">//	his_q3q3 = q3q3;	</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">float</span> q0;</span><br><span class="line">  <span class="keyword">float</span> q1;</span><br><span class="line">  <span class="keyword">float</span> q2;</span><br><span class="line">  <span class="keyword">float</span> q3;</span><br><span class="line">&#125; Quaternion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetAngle</span><span class="params">(<span class="keyword">const</span> _st_Mpu *pMpu,_st_AngE *pAngE, <span class="keyword">float</span> dt)</span> </span></span><br><span class="line"><span class="function"></span>&#123;		</span><br><span class="line">	<span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">V</span>&#123;</span></span><br><span class="line">				<span class="keyword">float</span> x;</span><br><span class="line">				<span class="keyword">float</span> y;</span><br><span class="line">				<span class="keyword">float</span> z;</span><br><span class="line">				&#125; Gravity,Acc,Gyro,AccGravity;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">V</span> <span class="title">GyroIntegError</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">static</span>  <span class="keyword">float</span> KpDef = <span class="number">0.8f</span>;</span><br><span class="line">	<span class="keyword">static</span>  <span class="keyword">float</span> KiDef = <span class="number">0.0003f</span>;</span><br><span class="line">	<span class="keyword">static</span> Quaternion NumQ = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">float</span> <span class="keyword">q0_t</span>,<span class="keyword">q1_t</span>,<span class="keyword">q2_t</span>,<span class="keyword">q3_t</span>;</span><br><span class="line">  <span class="comment">//float NormAcc;	</span></span><br><span class="line">	<span class="keyword">float</span> NormQuat; </span><br><span class="line">	<span class="keyword">float</span> HalfTime = dt * <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 提取等效旋转矩阵中的重力分量 </span></span><br><span class="line">	Gravity.x = <span class="number">2</span>*(NumQ.q1 * NumQ.q3 - NumQ.q0 * NumQ.q2);								</span><br><span class="line">	Gravity.y = <span class="number">2</span>*(NumQ.q0 * NumQ.q1 + NumQ.q2 * NumQ.q3);						  </span><br><span class="line">	Gravity.z = <span class="number">1</span><span class="number">-2</span>*(NumQ.q1 * NumQ.q1 + NumQ.q2 * NumQ.q2);	</span><br><span class="line">	<span class="comment">// 加速度归一化</span></span><br><span class="line"> NormAcc = Q_rsqrt(squa(MPU6050.accX)+ squa(MPU6050.accY) +squa(MPU6050.accZ));</span><br><span class="line">	</span><br><span class="line">    Acc.x = pMpu-&gt;accX * NormAcc;</span><br><span class="line">    Acc.y = pMpu-&gt;accY * NormAcc;</span><br><span class="line">    Acc.z = pMpu-&gt;accZ * NormAcc;	</span><br><span class="line"> 	<span class="comment">//向量差乘得出的值</span></span><br><span class="line">	AccGravity.x = (Acc.y * Gravity.z - Acc.z * Gravity.y);</span><br><span class="line">	AccGravity.y = (Acc.z * Gravity.x - Acc.x * Gravity.z);</span><br><span class="line">	AccGravity.z = (Acc.x * Gravity.y - Acc.y * Gravity.x);</span><br><span class="line">	<span class="comment">//再做加速度积分补偿角速度的补偿值</span></span><br><span class="line">    GyroIntegError.x += AccGravity.x * KiDef;</span><br><span class="line">    GyroIntegError.y += AccGravity.y * KiDef;</span><br><span class="line">    GyroIntegError.z += AccGravity.z * KiDef;</span><br><span class="line">	<span class="comment">//角速度融合加速度积分补偿值</span></span><br><span class="line">    Gyro.x = pMpu-&gt;gyroX * Gyro_Gr + KpDef * AccGravity.x  +  GyroIntegError.x;<span class="comment">//弧度制</span></span><br><span class="line">    Gyro.y = pMpu-&gt;gyroY * Gyro_Gr + KpDef * AccGravity.y  +  GyroIntegError.y;</span><br><span class="line">    Gyro.z = pMpu-&gt;gyroZ * Gyro_Gr + KpDef * AccGravity.z  +  GyroIntegError.z;		</span><br><span class="line">	<span class="comment">// 一阶龙格库塔法, 更新四元数</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">q0_t</span> = (-NumQ.q1*Gyro.x - NumQ.q2*Gyro.y - NumQ.q3*Gyro.z) * HalfTime;</span><br><span class="line">	<span class="keyword">q1_t</span> = ( NumQ.q0*Gyro.x - NumQ.q3*Gyro.y + NumQ.q2*Gyro.z) * HalfTime;</span><br><span class="line">	<span class="keyword">q2_t</span> = ( NumQ.q3*Gyro.x + NumQ.q0*Gyro.y - NumQ.q1*Gyro.z) * HalfTime;</span><br><span class="line">	<span class="keyword">q3_t</span> = (-NumQ.q2*Gyro.x + NumQ.q1*Gyro.y + NumQ.q0*Gyro.z) * HalfTime;</span><br><span class="line">	</span><br><span class="line">	NumQ.q0 += <span class="keyword">q0_t</span>;</span><br><span class="line">	NumQ.q1 += <span class="keyword">q1_t</span>;</span><br><span class="line">	NumQ.q2 += <span class="keyword">q2_t</span>;</span><br><span class="line">	NumQ.q3 += <span class="keyword">q3_t</span>;</span><br><span class="line">	<span class="comment">// 四元数归一化</span></span><br><span class="line">	NormQuat = Q_rsqrt(squa(NumQ.q0) + squa(NumQ.q1) + squa(NumQ.q2) + squa(NumQ.q3));</span><br><span class="line">	NumQ.q0 *= NormQuat;</span><br><span class="line">	NumQ.q1 *= NormQuat;</span><br><span class="line">	NumQ.q2 *= NormQuat;</span><br><span class="line">	NumQ.q3 *= NormQuat;	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 四元数转欧拉角</span></span><br><span class="line">	&#123;</span><br><span class="line">		 </span><br><span class="line">			<span class="meta">#<span class="meta-keyword">ifdef</span>	YAW_GYRO</span></span><br><span class="line">			*(<span class="keyword">float</span> *)pAngE = atan2f(<span class="number">2</span> * NumQ.q1 *NumQ.q2 + <span class="number">2</span> * NumQ.q0 * NumQ.q3, <span class="number">1</span> - <span class="number">2</span> * NumQ.q2 *NumQ.q2 - <span class="number">2</span> * NumQ.q3 * NumQ.q3) * RtA;  <span class="comment">//yaw</span></span><br><span class="line">			<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">				<span class="keyword">float</span> yaw_G = pMpu-&gt;gyroZ * Gyro_G;</span><br><span class="line">				<span class="keyword">if</span>((yaw_G &gt; <span class="number">3.0f</span>) || (yaw_G &lt; <span class="number">-3.0f</span>)) <span class="comment">//数据太小可以认为是干扰，不是偏航动作</span></span><br><span class="line">				&#123;</span><br><span class="line">					pAngE-&gt;yaw  += yaw_G * dt;			</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			pAngE-&gt;pitch  =  <span class="built_in">asin</span>(<span class="number">2</span> * NumQ.q0 *NumQ.q2 - <span class="number">2</span> * NumQ.q1 * NumQ.q3) * RtA;						</span><br><span class="line">		</span><br><span class="line">			pAngE-&gt;roll	= <span class="built_in">atan2</span>(<span class="number">2</span> * NumQ.q2 *NumQ.q3 + <span class="number">2</span> * NumQ.q0 * NumQ.q1, <span class="number">1</span> - <span class="number">2</span> * NumQ.q1 *NumQ.q1 - <span class="number">2</span> * NumQ.q2 * NumQ.q2) * RtA;	<span class="comment">//PITCH 			</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Mymath.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;myMath.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> M_PI = <span class="number">3.1415926535</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> RtA = <span class="number">57.2957795f</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> AtR = <span class="number">0.0174532925f</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> Gyro_G = <span class="number">0.03051756f</span>*<span class="number">2</span>;	  	<span class="comment">//陀螺仪初始化量程+-2000度每秒于1 / (65536 / 4000) = 0.03051756*2		</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> Gyro_Gr = <span class="number">0.0005326f</span>*<span class="number">2</span>;     <span class="comment">//面计算度每秒,转换弧度每秒则 2*0.03051756	 * 0.0174533f = 0.0005326*2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*====================================================================================================*/</span></span><br><span class="line"><span class="comment">/*====================================================================================================*</span></span><br><span class="line"><span class="comment">**函数 : Q_rsqrt</span></span><br><span class="line"><span class="comment">**功能 : 快速计算 三角函数</span></span><br><span class="line"><span class="comment">**输入 : number  </span></span><br><span class="line"><span class="comment">**输出 : 结果</span></span><br><span class="line"><span class="comment">**备注 : None</span></span><br><span class="line"><span class="comment">**====================================================================================================*/</span></span><br><span class="line"><span class="comment">/*====================================================================================================*/</span></span><br><span class="line"><span class="comment">//逼近法；线性拟合</span></span><br><span class="line"><span class="comment">//Q (4/M_PI x - 4/M_PI^2 x^2) + P (4/M_PI x - 4/M_PI^2 x^2)^2 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> TAPYOR</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">sine</span><span class="params">(<span class="keyword">float</span> x)</span>          <span class="comment">// (-M_PI , M_PI) ???? 0.0005</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> Q = <span class="number">0.775</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> P = <span class="number">0.225</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> B =  <span class="number">4</span> / M_PI;  </span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> C = <span class="number">-4</span> /(M_PI*M_PI);</span><br><span class="line">	<span class="keyword">float</span> y = B * x + C * x * <span class="built_in">fabs</span>(x); </span><br><span class="line">	<span class="keyword">return</span> (Q * y + P * y * <span class="built_in">fabs</span>(y));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> </span></span><br><span class="line"><span class="comment">//4级泰勒公式法 在PI出会出现0.7的最大误差</span></span><br><span class="line"><span class="comment">//sinx= x- x^3/3! + x^5/5! - x^7/7!+ x^9/9! . =?(-1)^n x^(2n+1)/(2n+1)!</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">sine</span><span class="params">(<span class="keyword">float</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span> t=x;</span><br><span class="line">	<span class="keyword">float</span> result = x;</span><br><span class="line">	<span class="keyword">float</span> X2 = x*x;</span><br><span class="line">	<span class="keyword">uint8_t</span> cnt = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		t=-t;</span><br><span class="line">		t *= X2;</span><br><span class="line">		result += t/((cnt&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>);</span><br><span class="line">		cnt++;</span><br><span class="line">	&#125;	<span class="keyword">while</span>(cnt&lt;<span class="number">5</span>);<span class="comment">//6阶</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">//http://wenku.baidu.com/link?url=jUswZ3G2z26IUS72IkeZrizc5V9VdR1sTF8xGCOHPFW0P70bGjjm5zhNxvRT36X31TMoFf6S-9lMoIkK4pPwExAaEZGtRpWggdQAzpg3Fsu</span></span><br><span class="line"><span class="comment">//cos(x)=sin(M_PI/2+x)=sin(M_PI/2-x)</span></span><br><span class="line"><span class="comment">//cos(x-M_PI/2)=sin(x)</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">cosine</span><span class="params">(<span class="keyword">float</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> sine(x+M_PI/<span class="number">2</span>);<span class="comment">//奇变偶不变，符号看象限</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//反正切麦克劳林展开式 阶数越高，值越准确   70°以内是准确的</span></span><br><span class="line"><span class="comment">//http://www.zybang.com/question/246f9997776f7d5cc636b10aff27a1cb.html</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">arctan</span><span class="params">(<span class="keyword">float</span> x)</span>  <span class="comment">//  (-1 , +1)    6? ?? 0.002958 </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span> t = x;</span><br><span class="line">	<span class="keyword">float</span> result = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">float</span> X2 = x * x;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> cnt = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		result += t / ((cnt &lt;&lt; <span class="number">1</span>) - <span class="number">1</span>);</span><br><span class="line">		t = -t;</span><br><span class="line">		t *= X2;</span><br><span class="line">		cnt++;</span><br><span class="line">	&#125;<span class="keyword">while</span>(cnt &lt;= <span class="number">6</span>);<span class="comment">//5??</span></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//反正弦麦克劳林展开式 -1&lt;x&lt;+1     42°以内是准确的</span></span><br><span class="line"><span class="comment">//http://xuxzmail.blog.163.com/blog/static/25131916200971794014536/</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> PI_2 = <span class="number">1.570796f</span>;</span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">arcsin</span><span class="params">(<span class="keyword">float</span> x)</span>   <span class="comment">//(-1 , +1)  ? 0 ????  6? ??0.005</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span> d=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">float</span> t=x;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> cnt = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">float</span> result = <span class="number">0</span>;	</span><br><span class="line">	<span class="keyword">float</span> X2 = x*x;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (x &gt;= <span class="number">1.0f</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PI_2;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (x &lt;= <span class="number">-1.0f</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> -PI_2;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		result += t / (d * ((cnt &lt;&lt; <span class="number">1</span>) - <span class="number">1</span>));</span><br><span class="line">		t *= X2 * ((cnt &lt;&lt; <span class="number">1</span>) - <span class="number">1</span>);<span class="comment">//</span></span><br><span class="line">		d *= (cnt &lt;&lt; <span class="number">1</span>);<span class="comment">//2 4 6 8 10 ...</span></span><br><span class="line">		cnt++;</span><br><span class="line">	&#125;<span class="keyword">while</span>(cnt &lt;= <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保证输入值是有效的</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">safe_asin</span><span class="params">(<span class="keyword">float</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isnan(v)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (v &gt;= <span class="number">1.0f</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> M_PI/<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (v &lt;= <span class="number">-1.0f</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -M_PI/<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> asinf(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*====================================================================================================*/</span></span><br><span class="line"><span class="comment">/*====================================================================================================*</span></span><br><span class="line"><span class="comment">**函数 : Q_rsqrt</span></span><br><span class="line"><span class="comment">**功能 : 快速计算 1/Sqrt(x) </span></span><br><span class="line"><span class="comment">**输入 : number  </span></span><br><span class="line"><span class="comment">**输出 : 结果</span></span><br><span class="line"><span class="comment">**备注 : None</span></span><br><span class="line"><span class="comment">**====================================================================================================*/</span></span><br><span class="line"><span class="comment">/*====================================================================================================*/</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">Q_rsqrt</span><span class="params">(<span class="keyword">float</span> number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> i;</span><br><span class="line">	<span class="keyword">float</span> x2, y;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">float</span> threehalfs = <span class="number">1.5F</span>;</span><br><span class="line"> </span><br><span class="line">	x2 = number * <span class="number">0.5F</span>;</span><br><span class="line">	y  = number;</span><br><span class="line">	i  = * ( <span class="keyword">long</span> * ) &amp;y;                      </span><br><span class="line">	i  = <span class="number">0x5f3759df</span> - ( i &gt;&gt; <span class="number">1</span> );               </span><br><span class="line">	y  = * ( <span class="keyword">float</span> * ) &amp;i;</span><br><span class="line">	y  = y * ( threehalfs - ( x2 * y * y ) );   <span class="comment">// 1st iteration （第一次牛顿迭代）</span></span><br><span class="line">	<span class="keyword">return</span> y;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************实现函数********************************************</span></span><br><span class="line"><span class="comment">*函数原型:    array_astrict_lower(int16_t *array,int16_t value)</span></span><br><span class="line"><span class="comment">*功　　能:    对数组下限限制</span></span><br><span class="line"><span class="comment">输入参数：    *array   目标数组指针</span></span><br><span class="line"><span class="comment">*             value      </span></span><br><span class="line"><span class="comment">输出参数：    无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">array_astrict</span><span class="params">(<span class="keyword">int16_t</span> *<span class="built_in">array</span>,<span class="keyword">int16_t</span> lower,<span class="keyword">int16_t</span> upper)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int16_t</span> length = <span class="keyword">sizeof</span>(<span class="built_in">array</span>); </span><br><span class="line">	 <span class="keyword">uint16_t</span> i = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;length;i++)</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span>(*(<span class="built_in">array</span>+i)&lt;lower)  *(<span class="built_in">array</span>+i) = lower;</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span>(*(<span class="built_in">array</span>+i)&gt;upper)  *(<span class="built_in">array</span>+i) = upper;</span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************实现函数********************************************</span></span><br><span class="line"><span class="comment">*函数原型:    array_assign(int16_t *array,int16_t value)</span></span><br><span class="line"><span class="comment">*功　　能:    对数组赋值</span></span><br><span class="line"><span class="comment">输入参数：    *array   目标数组指针 </span></span><br><span class="line"><span class="comment">*             value      </span></span><br><span class="line"><span class="comment">输出参数：    无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">array_assign</span><span class="params">(<span class="keyword">int16_t</span> *<span class="built_in">array</span>,<span class="keyword">int16_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">uint16_t</span> length = <span class="keyword">sizeof</span>(<span class="built_in">array</span>); </span><br><span class="line">	 <span class="keyword">uint16_t</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;length;i++)</span><br><span class="line">   &#123;</span><br><span class="line">     *(<span class="built_in">array</span>+i) = value;</span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************实现函数********************************************</span></span><br><span class="line"><span class="comment">*函数原型:    data_limit(float data,flaot toplimit,float lowerlimit)</span></span><br><span class="line"><span class="comment">*功　　能:    数据限幅</span></span><br><span class="line"><span class="comment">输入参数：    data       要操作的数据 </span></span><br><span class="line"><span class="comment">*             toplimit   上限</span></span><br><span class="line"><span class="comment">*             lowerlimit 下限</span></span><br><span class="line"><span class="comment">输出参数：    无</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">data_limit</span><span class="params">(<span class="keyword">float</span> data,<span class="keyword">float</span> toplimit,<span class="keyword">float</span> lowerlimit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(data &gt; toplimit)  data = toplimit;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(data &lt; lowerlimit) data = lowerlimit;</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************</span></span><br><span class="line"><span class="comment">  * @brief  可变增益自适应参数</span></span><br><span class="line"><span class="comment">  * @param  None</span></span><br><span class="line"><span class="comment">  * @retval None</span></span><br><span class="line"><span class="comment">************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">VariableParameter</span><span class="params">(<span class="keyword">float</span> error)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span>  result = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(error &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	   error = -error;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">if</span>(error &gt;<span class="number">0.6f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	   error = <span class="number">0.6f</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	result = <span class="number">1</span> - <span class="number">1.667f</span> * error;</span><br><span class="line">	<span class="keyword">if</span>(result &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	   result = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">middle_3</span><span class="params">(<span class="keyword">float</span> input)</span> <span class="comment">//3个数取中间的数</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> a,b,c,t; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(a&lt;b)</span><br><span class="line"></span><br><span class="line">  &#123; </span><br><span class="line"></span><br><span class="line">     t=a;a=b;b=t; </span><br><span class="line"></span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(b&lt;c)<span class="comment">//9 8 7 </span></span><br><span class="line"></span><br><span class="line"> &#123; </span><br><span class="line"></span><br><span class="line">  t=b;b=c;c=t;      </span><br><span class="line"></span><br><span class="line"> &#125; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(a&lt;b)<span class="comment">//9 8 7 </span></span><br><span class="line"></span><br><span class="line"> &#123; </span><br><span class="line"></span><br><span class="line">  t=a;a=b;b=t; </span><br><span class="line"></span><br><span class="line"> &#125; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> b; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">my_deathzoom_2</span><span class="params">(<span class="keyword">float</span> x,<span class="keyword">float</span> zoom)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span> t;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>( x&gt; -zoom &amp;&amp; x &lt; zoom )</span><br><span class="line">	&#123;</span><br><span class="line">		t = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		t = x;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">return</span> (t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">my_deathzoom</span><span class="params">(<span class="keyword">float</span> x,<span class="keyword">float</span> zoom)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">float</span> t;</span><br><span class="line">	<span class="keyword">if</span>(x&gt;<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		t = x - zoom;</span><br><span class="line">		<span class="keyword">if</span>(t&lt;<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			t = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		t = x + zoom;</span><br><span class="line">		<span class="keyword">if</span>(t&gt;<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			t = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">return</span> (t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="遥控器部分"><a class="markdownIt-Anchor" href="#遥控器部分"></a> 遥控器部分</h2>
<h3 id="硬件设计-2"><a class="markdownIt-Anchor" href="#硬件设计-2"></a> 硬件设计</h3>
<h4 id="电源设计-2"><a class="markdownIt-Anchor" href="#电源设计-2"></a> 电源设计</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/681Yi8"><img src="https://s3.ax1x.com/2021/03/09/681Yi8.jpg" alt="681Yi8.jpg" /></a></p>
<h4 id="stm32主控设计"><a class="markdownIt-Anchor" href="#stm32主控设计"></a> STM32主控设计</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6815e1"><img src="https://s3.ax1x.com/2021/03/09/6815e1.jpg" alt="6815e1.jpg" /></a></p>
<h4 id="摇杆电路设计"><a class="markdownIt-Anchor" href="#摇杆电路设计"></a> 摇杆电路设计</h4>
<h4 id="681lsejpg"><a class="markdownIt-Anchor" href="#681lsejpg"></a> <a target="_blank" rel="noopener" href="https://imgtu.com/i/681LSe"><img src="https://s3.ax1x.com/2021/03/09/681LSe.jpg" alt="681LSe.jpg" /></a></h4>
<h4 id="24g-oled等其他模块设计"><a class="markdownIt-Anchor" href="#24g-oled等其他模块设计"></a> 2.4G、OLED等其他模块设计</h4>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6GEzrT"><img src="https://s3.ax1x.com/2021/03/10/6GEzrT.jpg" alt="6GEzrT.jpg" /></a></p>
<h4 id="bom表-2"><a class="markdownIt-Anchor" href="#bom表-2"></a> BOM表</h4>
<table>
<thead>
<tr>
<th>Comment</th>
<th>Description</th>
<th>Designator</th>
<th>Footprint</th>
<th>Quantity</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>CAP</td>
<td>0603电容</td>
<td>C1, C3, C4, C5, C8,  C9, C10, C11, C12</td>
<td>C_0603</td>
<td>9</td>
<td>100nF</td>
</tr>
<tr>
<td>CAP</td>
<td>0603电容</td>
<td>C2, C14, C16</td>
<td>C_0603</td>
<td>3</td>
<td>100nF</td>
</tr>
<tr>
<td>CAP</td>
<td>0603电容</td>
<td>C6, C7</td>
<td>C_0603</td>
<td>2</td>
<td>22pF</td>
</tr>
<tr>
<td>CAP</td>
<td>1206钽电容</td>
<td>C13, C15</td>
<td>C_1206</td>
<td>2</td>
<td>100pF</td>
</tr>
<tr>
<td>S4</td>
<td>二极管</td>
<td>D1</td>
<td>SOD-123</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>DC4.2V</td>
<td>2p排针</td>
<td>JP1</td>
<td>SIP2</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>SW-PB</td>
<td>侧按按键开关</td>
<td>KEY1, KEY2</td>
<td>KEY(3<em>6</em>4.3mm)侧脚开关</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>MSS22D18</td>
<td>6p贴片拨动开关</td>
<td>KG1</td>
<td>MSS22D18</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>蓝灯</td>
<td>发光二极管</td>
<td>LED1, LED3</td>
<td>0603_LED_S1</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>红灯</td>
<td>发光二极管</td>
<td>LED2</td>
<td>0603_LED_S1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>NRF24L01</td>
<td>2.4G模块</td>
<td>NRF1</td>
<td>24L01</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>OLED</td>
<td>OLED模块</td>
<td>P1</td>
<td>SIP7</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>Res2</td>
<td>0603电阻</td>
<td>R1</td>
<td>R0603</td>
<td>1</td>
<td>10K</td>
</tr>
<tr>
<td>Res2</td>
<td>0603电阻</td>
<td>R2, R3, R4</td>
<td>R0603</td>
<td>3</td>
<td>1K</td>
</tr>
<tr>
<td>Res2</td>
<td>0603电阻</td>
<td>R5, R6, R7, R8, R9,  R10</td>
<td>R0603</td>
<td>6</td>
<td>10K</td>
</tr>
<tr>
<td>SW1</td>
<td>按键开关</td>
<td>S1, S2, S3, S4</td>
<td>KEY_4(SOP)</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>Header 4</td>
<td>4p排针</td>
<td>SWD1, USART1</td>
<td>HDR1X4</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>STM32F103C8T6_LQFP48</td>
<td>STM32C8T6</td>
<td>U1</td>
<td>LQFP48_STM32</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>662K</td>
<td>LDO</td>
<td>U2</td>
<td>SOT-23-3L</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>XTAL</td>
<td>贴片晶振CSTCE8M00G55</td>
<td>Y1</td>
<td>CSTCE8M00G55</td>
<td>1</td>
<td>8M</td>
</tr>
<tr>
<td>摇杆</td>
<td>摇杆</td>
<td>YG1, YG2</td>
<td>GY</td>
<td>2</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="软件设计-2"><a class="markdownIt-Anchor" href="#软件设计-2"></a> 软件设计</h3>
<p>main.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;systick.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;usart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nrf24l01.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ADC_DMA_Config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;remote.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Beep.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;oled.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;bmp.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	cycleCounterInit();</span><br><span class="line">	<span class="keyword">while</span>(SysTick_Config(SystemCoreClock / <span class="number">1000</span>))		<span class="comment">//系统滴答时钟 1ms发生一次中断</span></span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	BEEP_INIT();</span><br><span class="line">	NRF24L01_INIT();        <span class="comment">//初始化NRF24L01</span></span><br><span class="line">  USART1_Config();        <span class="comment">//初始化串口1	</span></span><br><span class="line">	OLED_Config();					<span class="comment">//OLED配置</span></span><br><span class="line">	delay_ms(<span class="number">100</span>);	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\r\nstm32f103C8t6\r\n&quot;</span>);<span class="comment">//串口1打印单片机型号</span></span><br><span class="line">	ADC1_GPIO_Config();      <span class="comment">//初始化ADC IO	</span></span><br><span class="line">	ADC1_Mode_Config();      <span class="comment">//初始化ADC模式	</span></span><br><span class="line">	RC_INIT();               <span class="comment">//校准摇杆数据初始化</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		OLED_ShowData();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ADC_DMA.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">THR 	- PA0	-	ADC12_IN0</span></span><br><span class="line"><span class="comment">YAW		-	PA1	-	ADC12_IN1</span></span><br><span class="line"><span class="comment">PITCH	-	PA2	-	ADC12_IN2</span></span><br><span class="line"><span class="comment">ROLL	-	PA3	-	ADC12_IN3</span></span><br><span class="line"><span class="comment">POWER	-	PA4	-	ADC12_IN4</span></span><br><span class="line"><span class="comment">KEY_L	-	PB0	-	ADC12_IN8</span></span><br><span class="line"><span class="comment">KEY_R	-	PB1	-	ADC12_IN9</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ADC_DMA_Config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADC1_DR_Address    ((u32)0x40012400+0x4c)</span></span><br><span class="line"></span><br><span class="line">__IO <span class="keyword">uint16_t</span> ADC_ConvertedValue[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 函数名：ADC1_GPIO_Config</span></span><br><span class="line"><span class="comment"> * 描述  ：使能ADC1和DMA1的时钟，初始化PC.01</span></span><br><span class="line"><span class="comment"> * 输入  : 无</span></span><br><span class="line"><span class="comment"> * 输出  ：无</span></span><br><span class="line"><span class="comment"> * 调用  ：内部调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ADC1_GPIO_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Enable DMA clock */</span></span><br><span class="line">	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Enable ADC1 and GPIOC clock */</span></span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_ADC1 | RCC_APB2Periph_GPIOA, ENABLE);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Configure PC.01  as analog input */</span></span><br><span class="line"></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;		</span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1 | GPIO_Pin_2 | GPIO_Pin_3; <span class="comment">//THR,YAW,ROLL,PITCH</span></span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);			</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 函数名：ADC1_Mode_Config</span></span><br><span class="line"><span class="comment"> * 描述  ：配置ADC1的工作模式为MDA模式</span></span><br><span class="line"><span class="comment"> * 输入  : 无</span></span><br><span class="line"><span class="comment"> * 输出  ：无</span></span><br><span class="line"><span class="comment"> * 调用  ：内部调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ADC1_Mode_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DMA_InitTypeDef DMA_InitStructure;</span><br><span class="line">	ADC_InitTypeDef ADC_InitStructure;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* DMA channel1 configuration */</span></span><br><span class="line">	DMA_DeInit(DMA1_Channel1);</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralBaseAddr = ADC1_DR_Address;	 <span class="comment">//ADC地址</span></span><br><span class="line">	DMA_InitStructure.DMA_MemoryBaseAddr = (u32)&amp;ADC_ConvertedValue;<span class="comment">//内存地址</span></span><br><span class="line">	DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC;</span><br><span class="line">	DMA_InitStructure.DMA_BufferSize = <span class="number">4</span>;</span><br><span class="line">	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;<span class="comment">//外设地址固定</span></span><br><span class="line">	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;  <span class="comment">//内存地址固定</span></span><br><span class="line">	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord;	<span class="comment">//半字</span></span><br><span class="line">	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;</span><br><span class="line">	DMA_InitStructure.DMA_Mode = DMA_Mode_Circular;		<span class="comment">//循环传输</span></span><br><span class="line">	DMA_InitStructure.DMA_Priority = DMA_Priority_High;</span><br><span class="line">	DMA_InitStructure.DMA_M2M = DMA_M2M_Disable;</span><br><span class="line">	DMA_Init(DMA1_Channel1, &amp;DMA_InitStructure);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Enable DMA channel1 */</span></span><br><span class="line">	DMA_Cmd(DMA1_Channel1, ENABLE);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* ADC1 configuration */</span></span><br><span class="line">	</span><br><span class="line">	ADC_InitStructure.ADC_Mode = ADC_Mode_Independent;	<span class="comment">//独立ADC模式</span></span><br><span class="line">	ADC_InitStructure.ADC_ScanConvMode = ENABLE ; 	 <span class="comment">//禁止扫描模式，扫描模式用于多通道采集</span></span><br><span class="line">	ADC_InitStructure.ADC_ContinuousConvMode = ENABLE;	<span class="comment">//开启连续转换模式，即不停地进行ADC转换</span></span><br><span class="line">	ADC_InitStructure.ADC_ExternalTrigConv = ADC_ExternalTrigConv_None;	<span class="comment">//不使用外部触发转换</span></span><br><span class="line">	ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right; 	<span class="comment">//采集数据右对齐</span></span><br><span class="line">	ADC_InitStructure.ADC_NbrOfChannel = <span class="number">4</span>;	 	<span class="comment">//要转换的通道数目</span></span><br><span class="line">	ADC_Init(ADC1, &amp;ADC_InitStructure);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*配置ADC时钟，为PCLK2的6分频，即12MHz,ADC频率最高不能超过14MHz*/</span></span><br><span class="line">	RCC_ADCCLKConfig(RCC_PCLK2_Div8); </span><br><span class="line">	<span class="comment">/*配置ADC1的通道11为55.	5个采样周期，序列为1 */</span> </span><br><span class="line"></span><br><span class="line">	ADC_RegularChannelConfig(ADC1, ADC_Channel_0, <span class="number">1</span>, ADC_SampleTime_55Cycles5);</span><br><span class="line">	ADC_RegularChannelConfig(ADC1, ADC_Channel_1, <span class="number">2</span>, ADC_SampleTime_55Cycles5);</span><br><span class="line">	ADC_RegularChannelConfig(ADC1, ADC_Channel_2, <span class="number">3</span>, ADC_SampleTime_55Cycles5);</span><br><span class="line">	ADC_RegularChannelConfig(ADC1, ADC_Channel_3, <span class="number">4</span>, ADC_SampleTime_55Cycles5);</span><br><span class="line"><span class="comment">//	ADC_RegularChannelConfig(ADC1, ADC_Channel_4, 5, ADC_SampleTime_55Cycles5);</span></span><br><span class="line"><span class="comment">//	ADC_RegularChannelConfig(ADC1, ADC_Channel_8, 6, ADC_SampleTime_55Cycles5);</span></span><br><span class="line"><span class="comment">//	ADC_RegularChannelConfig(ADC1, ADC_Channel_9, 7, ADC_SampleTime_55Cycles5);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Enable ADC1 DMA */</span></span><br><span class="line">	ADC_DMACmd(ADC1, ENABLE);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Enable ADC1 */</span></span><br><span class="line">	ADC_Cmd(ADC1, ENABLE);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*复位校准寄存器 */</span>   </span><br><span class="line">	ADC_ResetCalibration(ADC1);</span><br><span class="line">	<span class="comment">/*等待校准寄存器复位完成 */</span></span><br><span class="line">	<span class="keyword">while</span>(ADC_GetResetCalibrationStatus(ADC1));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* ADC校准 */</span></span><br><span class="line">	ADC_StartCalibration(ADC1);</span><br><span class="line">	<span class="comment">/* 等待校准完成*/</span></span><br><span class="line">	<span class="keyword">while</span>(ADC_GetCalibrationStatus(ADC1));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 由于没有采用外部触发，所以使用软件触发ADC转换 */</span> </span><br><span class="line">	ADC_SoftwareStartConvCmd(ADC1, ENABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EEPROM.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EEPROM.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x_flash.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;FAILED = <span class="number">0</span>, PASSED = !FAILED&#125; Status;<span class="comment">//定义要使用的状态枚举变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> EraseCounter = <span class="number">0x00</span>, Address = <span class="number">0x00</span>;</span><br><span class="line"><span class="keyword">uint32_t</span> Data = <span class="number">0x3210ABCD</span>;</span><br><span class="line"><span class="keyword">uint32_t</span> First_Page = <span class="number">0x00</span>;                       <span class="comment">//起始页</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__IO FLASH_Status FLASHStatus = FLASH_COMPLETE;</span><br><span class="line">__IO Status MemoryProgramStatus = PASSED;</span><br><span class="line"><span class="comment">//函数声明</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//=============================================================================</span></span><br><span class="line"><span class="comment">//文件名称：main</span></span><br><span class="line"><span class="comment">//功能概要：主函数</span></span><br><span class="line"><span class="comment">//参数说明：无</span></span><br><span class="line"><span class="comment">//函数返回：int</span></span><br><span class="line"><span class="comment">//=============================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FLASH_write</span><span class="params">(<span class="keyword">int16_t</span> *data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FLASH_Unlock();<span class="comment">//先解锁</span></span><br><span class="line">  FLASH_ClearFlag(FLASH_FLAG_EOP | FLASH_FLAG_PGERR | FLASH_FLAG_WRPRTERR); <span class="comment">//清楚相应的标志位</span></span><br><span class="line">  First_Page = (FLASH_End_Addr - FLASH_Start_Addr+<span class="number">1</span>) / FLASH_Page_Size;<span class="comment">//计算出起始页</span></span><br><span class="line">  <span class="comment">/* 使用前先擦除 */</span></span><br><span class="line">  <span class="keyword">for</span>(EraseCounter = <span class="number">0</span>; (EraseCounter &lt; First_Page) &amp;&amp; (FLASHStatus == FLASH_COMPLETE); EraseCounter++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (FLASH_ErasePage(FLASH_Start_Addr + (FLASH_Page_Size * EraseCounter))!= FLASH_COMPLETE)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">      &#123;			</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">/* 写入FLASH */</span></span><br><span class="line">  Address = FLASH_Start_Addr;</span><br><span class="line">  <span class="keyword">while</span> (len--)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (FLASH_ProgramHalfWord(Address, *data) == FLASH_COMPLETE)</span><br><span class="line">    &#123;</span><br><span class="line">		data++;</span><br><span class="line">		Address = Address + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123; </span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">      &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  FLASH_Lock();</span><br><span class="line">	<span class="comment">/* 上锁 */</span></span><br><span class="line">&#125;	</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FLASH_read</span><span class="params">(<span class="keyword">uint32_t</span> *data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Address = FLASH_Start_Addr;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (len--)</span><br><span class="line">  &#123;</span><br><span class="line">    *data = *(__IO <span class="keyword">uint32_t</span> *)Address;</span><br><span class="line">	data++;</span><br><span class="line">    Address = Address + <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NRF24L01.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nrf24l01.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;SPI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> SUCCESS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUCCESS 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> FAILED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAILED  1</span></span><br><span class="line"><span class="comment">//配对密码</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> TX_ADDRESS[]= &#123;<span class="number">0x11</span>,<span class="number">0x22</span>,<span class="number">0x33</span>,<span class="number">0x44</span>,<span class="number">0x55</span>&#125;;	<span class="comment">//本地地址</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> RX_ADDRESS[]= &#123;<span class="number">0x11</span>,<span class="number">0x22</span>,<span class="number">0x33</span>,<span class="number">0x44</span>,<span class="number">0x55</span>&#125;;	<span class="comment">//接收地址RX_ADDR_P0 == RX_ADDR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//24L01操作线   </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Set_NRF24L01_CSN    (GPIOA-&gt;BSRR = GPIO_Pin_4) <span class="comment">// PB12</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Clr_NRF24L01_CSN     (GPIOA-&gt;BRR = GPIO_Pin_4)    <span class="comment">// PB12</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Set_NRF24L01_CE (GPIOA-&gt;BSRR = GPIO_Pin_15)    <span class="comment">// PB1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Clr_NRF24L01_CE  (GPIOA-&gt;BRR = GPIO_Pin_15)    <span class="comment">// PB1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_NRF24L01_IRQ   (GPIOA-&gt;IDR&amp;GPIO_Pin_11)<span class="comment">//IRQ主机数据输入 PB0</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define GPIO_Remap_SWJ_JTAGDisable  ((uint32_t)0x00300200)  /*!&lt; JTAG-DP Disabled and SW-DP Enabled */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化24L01的IO口</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NRF24L01_Configuration</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);</span><br><span class="line">	GPIO_PinRemapConfig(GPIO_Remap_SWJ_JTAGDisable, ENABLE);      <span class="comment">/*??SWD ??JTAG*/</span></span><br><span class="line">	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);    <span class="comment">//led</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9|GPIO_Pin_10;          <span class="comment">//</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;    <span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);    <span class="comment">//使能GPIO的时钟  CE</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_15;          <span class="comment">//NRF24L01 模块片选信号</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;    <span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line"></span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);   <span class="comment">//使能GPIO的时钟 CSN</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_4;      </span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;    <span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	Set_NRF24L01_CE;                                    <span class="comment">//初始化时先拉高</span></span><br><span class="line">	Set_NRF24L01_CSN;                                   <span class="comment">//初始化时先拉高</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置NRF2401的IRQ</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11;</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU  ;     <span class="comment">//上拉输入</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">	GPIO_SetBits(GPIOA,GPIO_Pin_11);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	SPI_Config();                                <span class="comment">//初始化SPI</span></span><br><span class="line">	Clr_NRF24L01_CE; 	                                <span class="comment">//使能24L01</span></span><br><span class="line">	Set_NRF24L01_CSN;                                   <span class="comment">//SPI片选取消</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上电检测NRF24L01是否在位</span></span><br><span class="line"><span class="comment">//写5个数据然后再读回来进行比较，</span></span><br><span class="line"><span class="comment">//相同时返回值:0，表示在位;否则返回1，表示不在位	</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Check</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 buf[<span class="number">5</span>]=&#123;<span class="number">0XA5</span>,<span class="number">0XA5</span>,<span class="number">0XA5</span>,<span class="number">0XA5</span>,<span class="number">0XA5</span>&#125;;</span><br><span class="line">	u8 buf1[<span class="number">5</span>];</span><br><span class="line">	u8 i;   	 </span><br><span class="line">	NRF24L01_Write_Buf(SPI_WRITE_REG+TX_ADDR,buf,<span class="number">5</span>);<span class="comment">//写入5个字节的地址.	</span></span><br><span class="line">	NRF24L01_Read_Buf(TX_ADDR,buf1,<span class="number">5</span>);              <span class="comment">//读出写入的地址  	</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)<span class="keyword">if</span>(buf1[i]!=<span class="number">0XA5</span>)<span class="keyword">break</span>;					   </span><br><span class="line">	<span class="keyword">if</span>(i!=<span class="number">5</span>)<span class="keyword">return</span> <span class="number">1</span>;                               <span class="comment">//NRF24L01不在位	</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;		                                <span class="comment">//NRF24L01在位</span></span><br><span class="line">&#125;	 	 </span><br><span class="line"><span class="comment">//通过SPI写寄存器</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Write_Reg</span><span class="params">(u8 regaddr,u8 data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 status;	</span><br><span class="line">    Clr_NRF24L01_CSN;                    <span class="comment">//使能SPI传输</span></span><br><span class="line">  	status =SPI_RW(regaddr); <span class="comment">//发送寄存器号 </span></span><br><span class="line">  	SPI_RW(data);            <span class="comment">//写入寄存器的值</span></span><br><span class="line">  	Set_NRF24L01_CSN;                    <span class="comment">//禁止SPI传输	   </span></span><br><span class="line">  	<span class="keyword">return</span>(status);       		         <span class="comment">//返回状态值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//读取SPI寄存器值 ，regaddr:要读的寄存器</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Read_Reg</span><span class="params">(u8 regaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 reg_val;	    </span><br><span class="line">	Clr_NRF24L01_CSN;                <span class="comment">//使能SPI传输		</span></span><br><span class="line">  	SPI_RW(regaddr);     <span class="comment">//发送寄存器号</span></span><br><span class="line">  	reg_val=SPI_RW(<span class="number">0XFF</span>);<span class="comment">//读取寄存器内容</span></span><br><span class="line">  	Set_NRF24L01_CSN;                <span class="comment">//禁止SPI传输		    </span></span><br><span class="line">  	<span class="keyword">return</span>(reg_val);                 <span class="comment">//返回状态值</span></span><br><span class="line">&#125;	</span><br><span class="line"><span class="comment">//在指定位置读出指定长度的数据</span></span><br><span class="line"><span class="comment">//*pBuf:数据指针</span></span><br><span class="line"><span class="comment">//返回值,此次读到的状态寄存器值 </span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Read_Buf</span><span class="params">(u8 regaddr,u8 *pBuf,u8 datalen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 status,u8_ctr;	       </span><br><span class="line">  	Clr_NRF24L01_CSN;                     <span class="comment">//使能SPI传输</span></span><br><span class="line">  	status=SPI_RW(regaddr);   <span class="comment">//发送寄存器值(位置),并读取状态值   	   </span></span><br><span class="line">	<span class="keyword">for</span>(u8_ctr=<span class="number">0</span>;u8_ctr&lt;datalen;u8_ctr++)pBuf[u8_ctr]=SPI_RW(<span class="number">0XFF</span>);<span class="comment">//读出数据</span></span><br><span class="line">  	Set_NRF24L01_CSN;                     <span class="comment">//关闭SPI传输</span></span><br><span class="line">  	<span class="keyword">return</span> status;                        <span class="comment">//返回读到的状态值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在指定位置写指定长度的数据</span></span><br><span class="line"><span class="comment">//*pBuf:数据指针</span></span><br><span class="line"><span class="comment">//返回值,此次读到的状态寄存器值</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_Write_Buf</span><span class="params">(u8 regaddr, u8 *pBuf, u8 datalen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 status,u8_ctr;	    </span><br><span class="line">	Clr_NRF24L01_CSN;                                    <span class="comment">//使能SPI传输</span></span><br><span class="line">  	status = SPI_RW(regaddr);                <span class="comment">//发送寄存器值(位置),并读取状态值</span></span><br><span class="line">  	<span class="keyword">for</span>(u8_ctr=<span class="number">0</span>; u8_ctr&lt;datalen; u8_ctr++)SPI_RW(*pBuf++); <span class="comment">//写入数据	 </span></span><br><span class="line">  	Set_NRF24L01_CSN;                                    <span class="comment">//关闭SPI传输</span></span><br><span class="line">  	<span class="keyword">return</span> status;                                       <span class="comment">//返回读到的状态值</span></span><br><span class="line">&#125;				   </span><br><span class="line"><span class="comment">//启动NRF24L01发送一次数据</span></span><br><span class="line"><span class="comment">//txbuf:待发送数据首地址</span></span><br><span class="line"><span class="comment">//返回值:发送完成状况</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_TxPacket</span><span class="params">(u8 *txbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 state;   </span><br><span class="line">	Clr_NRF24L01_CE;</span><br><span class="line">	NRF24L01_Write_Buf(WR_TX_PLOAD,txbuf,TX_PLOAD_WIDTH);<span class="comment">//写数据到TX BUF  32个字节</span></span><br><span class="line">	Set_NRF24L01_CE;                                     <span class="comment">//启动发送	   </span></span><br><span class="line"><span class="comment">//	while(READ_NRF24L01_IRQ!=0);                         //等待发送完成</span></span><br><span class="line">	state=NRF24L01_Read_Reg(STATUS);                     <span class="comment">//读取状态寄存器的值	   </span></span><br><span class="line">	NRF24L01_Write_Reg(SPI_WRITE_REG+STATUS,state);      <span class="comment">//清除TX_DS或MAX_RT中断标志</span></span><br><span class="line">	<span class="keyword">if</span>(state&amp;MAX_TX)                                     <span class="comment">//达到最大重发次数</span></span><br><span class="line">	&#123;</span><br><span class="line">		NRF24L01_Write_Reg(FLUSH_TX,<span class="number">0xff</span>);               <span class="comment">//清除TX FIFO寄存器 </span></span><br><span class="line">		<span class="keyword">return</span> MAX_TX; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(state&amp;TX_OK)                                      <span class="comment">//发送完成</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> TX_OK;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0xff</span>;                                         <span class="comment">//其他原因发送失败</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动NRF24L01发送一次数据</span></span><br><span class="line"><span class="comment">//txbuf:待发送数据首地址</span></span><br><span class="line"><span class="comment">//返回值:0，接收完成；其他，错误代码</span></span><br><span class="line"><span class="function">u8 <span class="title">NRF24L01_RxPacket</span><span class="params">(u8 *rxbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 state;		    							      </span><br><span class="line">	state=NRF24L01_Read_Reg(STATUS);                <span class="comment">//读取状态寄存器的值    	 </span></span><br><span class="line">	NRF24L01_Write_Reg(SPI_WRITE_REG+STATUS,state); <span class="comment">//清除TX_DS或MAX_RT中断标志</span></span><br><span class="line">	<span class="keyword">if</span>(state&amp;RX_OK)                                 <span class="comment">//接收到数据</span></span><br><span class="line">	&#123;</span><br><span class="line">		NRF24L01_Read_Buf(RD_RX_PLOAD,rxbuf,RX_PLOAD_WIDTH);<span class="comment">//读取数据</span></span><br><span class="line">		NRF24L01_Write_Reg(FLUSH_RX,<span class="number">0xff</span>);          <span class="comment">//清除RX FIFO寄存器 </span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">	&#125;	   </span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;                                      <span class="comment">//没收到任何数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//该函数初始化NRF24L01到RX模式</span></span><br><span class="line"><span class="comment">//设置RX地址,写RX数据宽度,选择RF频道,波特率和LNA HCURR</span></span><br><span class="line"><span class="comment">//当CE变高后,即进入RX模式,并可以接收数据了		   </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RX_Mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Clr_NRF24L01_CE;	  </span><br><span class="line">    <span class="comment">//写RX节点地址</span></span><br><span class="line">  	NRF24L01_Write_Buf(SPI_WRITE_REG+RX_ADDR_P0,(u8*)RX_ADDRESS,RX_ADR_WIDTH);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使能通道0的自动应答    </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_AA,<span class="number">0x01</span>);    </span><br><span class="line">    <span class="comment">//使能通道0的接收地址  	 </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_RXADDR,<span class="number">0x01</span>);</span><br><span class="line">    <span class="comment">//设置RF通信频率		  </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_CH,<span class="number">45</span>);	   <span class="comment">//(要改单机控制，就把45改成跟遥控器单独一样的。就可以单机控制了)</span></span><br><span class="line">    <span class="comment">//选择通道0的有效数据宽度 	    </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RX_PW_P0,RX_PLOAD_WIDTH);</span><br><span class="line">    <span class="comment">//设置TX发射参数,0db增益,2Mbps,低噪声增益开启   </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_SETUP,<span class="number">0x0f</span>);</span><br><span class="line">    <span class="comment">//配置基本工作模式的参数;PWR_UP,EN_CRC,16BIT_CRC,PRIM_RX接收模式 </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+NCONFIG, <span class="number">0x0f</span>); </span><br><span class="line">    <span class="comment">//CE为高,进入接收模式 </span></span><br><span class="line">  	Set_NRF24L01_CE;                                </span><br><span class="line">&#125;			</span><br><span class="line"></span><br><span class="line"><span class="comment">//该函数初始化NRF24L01到TX模式</span></span><br><span class="line"><span class="comment">//设置TX地址,写TX数据宽度,设置RX自动应答的地址,填充TX发送数据,</span></span><br><span class="line"><span class="comment">//选择RF频道,波特率和LNA HCURR PWR_UP,CRC使能</span></span><br><span class="line"><span class="comment">//当CE变高后,即进入RX模式,并可以接收数据了		   </span></span><br><span class="line"><span class="comment">//CE为高大于10us,则启动发送.	 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TX_Mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;														 </span><br><span class="line">	Clr_NRF24L01_CE;	    </span><br><span class="line">    <span class="comment">//写TX节点地址 </span></span><br><span class="line">  	NRF24L01_Write_Buf(SPI_WRITE_REG+TX_ADDR,(u8*)TX_ADDRESS,TX_ADR_WIDTH);    </span><br><span class="line">    <span class="comment">//设置TX节点地址,主要为了使能ACK	  </span></span><br><span class="line">  	NRF24L01_Write_Buf(SPI_WRITE_REG+RX_ADDR_P0,(u8*)RX_ADDRESS,RX_ADR_WIDTH); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//使能通道0的自动应答    </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_AA,<span class="number">0x01</span>);     </span><br><span class="line">    <span class="comment">//使能通道0的接收地址  </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+EN_RXADDR,<span class="number">0x01</span>); </span><br><span class="line">    <span class="comment">//设置自动重发间隔时间:500us + 86us;最大自动重发次数:10次</span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+SETUP_RETR,<span class="number">0x1a</span>);</span><br><span class="line">    <span class="comment">//设置RF通道为40</span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_CH,<span class="number">45</span>);     <span class="comment">//(要改单机控制，就把45改成跟遥控器单独一样的。就可以单机控制了)</span></span><br><span class="line">    <span class="comment">//设置TX发射参数,0db增益,2Mbps,低噪声增益开启   </span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+RF_SETUP,<span class="number">0x0f</span>);  <span class="comment">//0x27  250K   0x07 1M</span></span><br><span class="line">    <span class="comment">//配置基本工作模式的参数;PWR_UP,EN_CRC,16BIT_CRC,PRIM_RX发送模式,开启所有中断</span></span><br><span class="line">  	NRF24L01_Write_Reg(SPI_WRITE_REG+NCONFIG,<span class="number">0x0e</span>);    </span><br><span class="line">    <span class="comment">// CE为高,10us后启动发送</span></span><br><span class="line">	Set_NRF24L01_CE;                                  </span><br><span class="line">&#125;		  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NRF24L01_INIT</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NRF24L01_Configuration();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(NRF24L01_Check())</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	GPIO_SetBits(GPIOB,GPIO_Pin_9);</span><br><span class="line">  TX_Mode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SPI.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spi.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SPI_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      SPI_InitTypeDef  SPI_InitStructure;</span><br><span class="line">   	  GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line"></span><br><span class="line">		RCC_APB2PeriphClockCmd(RCC_APB2Periph_SPI1,ENABLE);  </span><br><span class="line">		RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_AFIO  , ENABLE);</span><br><span class="line">		GPIO_SetBits(GPIOA, GPIO_Pin_4); <span class="comment">//NRF_CS预置为高 </span></span><br><span class="line">		</span><br><span class="line">	  	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_6 | GPIO_Pin_7; </span><br><span class="line">	  	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; </span><br><span class="line">	  	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP; </span><br><span class="line">	  	GPIO_Init(GPIOA, &amp;GPIO_InitStructure); </span><br><span class="line"></span><br><span class="line">        <span class="comment">/* SPI2 configuration */</span></span><br><span class="line">        SPI_Cmd(SPI1, DISABLE);             <span class="comment">//必须先禁能,才能改变MODE</span></span><br><span class="line">        SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;</span><br><span class="line">        SPI_InitStructure.SPI_Mode = SPI_Mode_Master;</span><br><span class="line">        SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b;</span><br><span class="line">        SPI_InitStructure.SPI_CPOL = SPI_CPOL_Low;</span><br><span class="line">        SPI_InitStructure.SPI_CPHA = SPI_CPHA_1Edge;</span><br><span class="line">        SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;</span><br><span class="line">        SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_8;</span><br><span class="line">        SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;</span><br><span class="line">        SPI_InitStructure.SPI_CRCPolynomial = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">        SPI_Init(SPI1, &amp;SPI_InitStructure);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* SPI2 enable */</span></span><br><span class="line">        SPI_Cmd(SPI1, ENABLE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">u8 <span class="title">SPI_RW</span><span class="params">(u8 dat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="comment">/* Loop while DR register in not emplty */</span></span><br><span class="line">        <span class="keyword">while</span>(SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_TXE) == RESET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Send byte through the SPI2 peripheral */</span></span><br><span class="line">        SPI_I2S_SendData(SPI1, dat);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Wait to receive a byte */</span></span><br><span class="line">        <span class="keyword">while</span>(SPI_I2S_GetFlagStatus(SPI1, SPI_I2S_FLAG_RXNE) == RESET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Return the byte read from the SPI bus */</span></span><br><span class="line">        <span class="keyword">return</span> SPI_I2S_ReceiveData(SPI1);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Systick.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;systick.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ADC_DMA_Config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;SPI.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nrf24l01.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;eeprom.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;remote.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;usart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> SysTick_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SysTick_Handler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SysTick_count++;	</span><br><span class="line">	TimeDelay--;</span><br><span class="line">	RC_Analy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BEEP.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Beep.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BEEP_INIT</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);    <span class="comment">//使能GPIO的时钟  </span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12;          <span class="comment">//蜂鸣器</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;    <span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">	BEEP_L;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OLED.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;oled.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;oledfont.h&quot;</span>  	 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;remote.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">u8 OLED_GRAM[<span class="number">144</span>][<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//反显函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ColorTurn</span><span class="params">(u8 i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(i==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			OLED_WR_Byte(<span class="number">0xA6</span>,OLED_CMD);<span class="comment">//正常显示</span></span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">if</span>(i==<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			OLED_WR_Byte(<span class="number">0xA7</span>,OLED_CMD);<span class="comment">//反色显示</span></span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//屏幕旋转180度</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_DisplayTurn</span><span class="params">(u8 i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(i==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			OLED_WR_Byte(<span class="number">0xC8</span>,OLED_CMD);<span class="comment">//正常显示</span></span><br><span class="line">			OLED_WR_Byte(<span class="number">0xA1</span>,OLED_CMD);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">if</span>(i==<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			OLED_WR_Byte(<span class="number">0xC0</span>,OLED_CMD);<span class="comment">//反转显示</span></span><br><span class="line">			OLED_WR_Byte(<span class="number">0xA0</span>,OLED_CMD);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_WR_Byte</span><span class="params">(u8 dat,u8 cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	u8 i;			  </span><br><span class="line">	<span class="keyword">if</span>(cmd)</span><br><span class="line">	  OLED_DC_Set();</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	  OLED_DC_Clr();</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		OLED_SCLK_Clr();</span><br><span class="line">		<span class="keyword">if</span>(dat&amp;<span class="number">0x80</span>)</span><br><span class="line">		   OLED_SDIN_Set();</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">		   OLED_SDIN_Clr();</span><br><span class="line">		OLED_SCLK_Set();</span><br><span class="line">		dat&lt;&lt;=<span class="number">1</span>;   </span><br><span class="line">	&#125;				 		  </span><br><span class="line">	OLED_DC_Set();   	  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启OLED显示 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_DisPlay_On</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	OLED_WR_Byte(<span class="number">0x8D</span>,OLED_CMD);<span class="comment">//电荷泵使能</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x14</span>,OLED_CMD);<span class="comment">//开启电荷泵</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xAF</span>,OLED_CMD);<span class="comment">//点亮屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭OLED显示 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_DisPlay_Off</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	OLED_WR_Byte(<span class="number">0x8D</span>,OLED_CMD);<span class="comment">//电荷泵使能</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x10</span>,OLED_CMD);<span class="comment">//关闭电荷泵</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xAF</span>,OLED_CMD);<span class="comment">//关闭屏幕</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新显存到OLED	</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_Refresh</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,n;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">	   OLED_WR_Byte(<span class="number">0xb0</span>+i,OLED_CMD); <span class="comment">//设置行起始地址</span></span><br><span class="line">	   OLED_WR_Byte(<span class="number">0x00</span>,OLED_CMD);   <span class="comment">//设置低列起始地址</span></span><br><span class="line">	   OLED_WR_Byte(<span class="number">0x10</span>,OLED_CMD);   <span class="comment">//设置高列起始地址</span></span><br><span class="line">	   <span class="keyword">for</span>(n=<span class="number">0</span>;n&lt;<span class="number">128</span>;n++)</span><br><span class="line">		 OLED_WR_Byte(OLED_GRAM[n][i],OLED_DATA);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//清屏函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_Clear</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,n;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">	   <span class="keyword">for</span>(n=<span class="number">0</span>;n&lt;<span class="number">128</span>;n++)</span><br><span class="line">			&#123;</span><br><span class="line">			 OLED_GRAM[n][i]=<span class="number">0</span>;<span class="comment">//清除所有数据</span></span><br><span class="line">			&#125;</span><br><span class="line">  &#125;</span><br><span class="line">	OLED_Refresh();<span class="comment">//更新显示</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//画点 </span></span><br><span class="line"><span class="comment">//x:0~127</span></span><br><span class="line"><span class="comment">//y:0~63</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_DrawPoint</span><span class="params">(u8 x,u8 y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,m,n;</span><br><span class="line">	i=y/<span class="number">8</span>;</span><br><span class="line">	m=y%<span class="number">8</span>;</span><br><span class="line">	n=<span class="number">1</span>&lt;&lt;m;</span><br><span class="line">	OLED_GRAM[x][i]|=n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//清除一个点</span></span><br><span class="line"><span class="comment">//x:0~127</span></span><br><span class="line"><span class="comment">//y:0~63</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ClearPoint</span><span class="params">(u8 x,u8 y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,m,n;</span><br><span class="line">	i=y/<span class="number">8</span>;</span><br><span class="line">	m=y%<span class="number">8</span>;</span><br><span class="line">	n=<span class="number">1</span>&lt;&lt;m;</span><br><span class="line">	OLED_GRAM[x][i]=~OLED_GRAM[x][i];</span><br><span class="line">	OLED_GRAM[x][i]|=n;</span><br><span class="line">	OLED_GRAM[x][i]=~OLED_GRAM[x][i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//画线</span></span><br><span class="line"><span class="comment">//x:0~128</span></span><br><span class="line"><span class="comment">//y:0~64</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_DrawLine</span><span class="params">(u8 x1,u8 y1,u8 x2,u8 y2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,k,k1,k2;</span><br><span class="line">	<span class="keyword">if</span>((x2&gt;<span class="number">128</span>)||(y2&gt;<span class="number">64</span>)||(x1&gt;x2)||(y1&gt;y2))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(x1==x2)    <span class="comment">//画竖线</span></span><br><span class="line">	&#123;</span><br><span class="line">			<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;(y2-y1);i++)</span><br><span class="line">			&#123;</span><br><span class="line">				OLED_DrawPoint(x1,y1+i);</span><br><span class="line">			&#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(y1==y2)   <span class="comment">//画横线</span></span><br><span class="line">	&#123;</span><br><span class="line">			<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;(x2-x1);i++)</span><br><span class="line">			&#123;</span><br><span class="line">				OLED_DrawPoint(x1+i,y1);</span><br><span class="line">			&#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="keyword">else</span>      <span class="comment">//画斜线</span></span><br><span class="line">	&#123;</span><br><span class="line">		k1=y2-y1;</span><br><span class="line">		k2=x2-x1;</span><br><span class="line">		k=k1*<span class="number">10</span>/k2;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;(x2-x1);i++)</span><br><span class="line">			&#123;</span><br><span class="line">			  OLED_DrawPoint(x1+i,y1+i*k/<span class="number">10</span>);</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//x,y:圆心坐标</span></span><br><span class="line"><span class="comment">//r:圆的半径</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_DrawCircle</span><span class="params">(u8 x,u8 y,u8 r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a, b,num;</span><br><span class="line">    a = <span class="number">0</span>;</span><br><span class="line">    b = r;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">2</span> * b * b &gt;= r * r)      </span><br><span class="line">    &#123;</span><br><span class="line">        OLED_DrawPoint(x + a, y - b);</span><br><span class="line">        OLED_DrawPoint(x - a, y - b);</span><br><span class="line">        OLED_DrawPoint(x - a, y + b);</span><br><span class="line">        OLED_DrawPoint(x + a, y + b);</span><br><span class="line"> </span><br><span class="line">        OLED_DrawPoint(x + b, y + a);</span><br><span class="line">        OLED_DrawPoint(x + b, y - a);</span><br><span class="line">        OLED_DrawPoint(x - b, y - a);</span><br><span class="line">        OLED_DrawPoint(x - b, y + a);</span><br><span class="line">        </span><br><span class="line">        a++;</span><br><span class="line">        num = (a * a + b * b) - r*r;<span class="comment">//计算画的点离圆心的距离</span></span><br><span class="line">        <span class="keyword">if</span>(num &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            b--;</span><br><span class="line">            a--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//在指定位置显示一个字符,包括部分字符</span></span><br><span class="line"><span class="comment">//x:0~127</span></span><br><span class="line"><span class="comment">//y:0~63</span></span><br><span class="line"><span class="comment">//size:选择字体 12/16/24</span></span><br><span class="line"><span class="comment">//取模方式 逐列式</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ShowChar</span><span class="params">(u8 x,u8 y,u8 chr,u8 size1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,m,temp,size2,chr1;</span><br><span class="line">	u8 y0=y;</span><br><span class="line">	size2=(size1/<span class="number">8</span>+((size1%<span class="number">8</span>)?<span class="number">1</span>:<span class="number">0</span>))*(size1/<span class="number">2</span>);  <span class="comment">//得到字体一个字符对应点阵集所占的字节数</span></span><br><span class="line">	chr1=chr-<span class="string">&#x27; &#x27;</span>;  <span class="comment">//计算偏移后的值</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;size2;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(size1==<span class="number">12</span>)</span><br><span class="line">        &#123;temp=asc2_1206[chr1][i];&#125; <span class="comment">//调用1206字体</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(size1==<span class="number">16</span>)</span><br><span class="line">        &#123;temp=asc2_1608[chr1][i];&#125; <span class="comment">//调用1608字体</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(size1==<span class="number">24</span>)</span><br><span class="line">        &#123;temp=asc2_2412[chr1][i];&#125; <span class="comment">//调用2412字体</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">				<span class="keyword">for</span>(m=<span class="number">0</span>;m&lt;<span class="number">8</span>;m++)           <span class="comment">//写入数据</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>(temp&amp;<span class="number">0x80</span>)OLED_DrawPoint(x,y);</span><br><span class="line">					<span class="keyword">else</span> OLED_ClearPoint(x,y);</span><br><span class="line">					temp&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">					y++;</span><br><span class="line">					<span class="keyword">if</span>((y-y0)==size1)</span><br><span class="line">					&#123;</span><br><span class="line">						y=y0;</span><br><span class="line">						x++;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">				&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//显示字符串</span></span><br><span class="line"><span class="comment">//x,y:起点坐标  </span></span><br><span class="line"><span class="comment">//size1:字体大小 </span></span><br><span class="line"><span class="comment">//*chr:字符串起始地址 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ShowString</span><span class="params">(u8 x,u8 y,u8 *chr,u8 size1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span>((*chr&gt;=<span class="string">&#x27; &#x27;</span>)&amp;&amp;(*chr&lt;=<span class="string">&#x27;~&#x27;</span>))<span class="comment">//判断是不是非法字符!</span></span><br><span class="line">	&#123;</span><br><span class="line">		OLED_ShowChar(x,y,*chr,size1);</span><br><span class="line">		x+=size1/<span class="number">2</span>;</span><br><span class="line">		<span class="keyword">if</span>(x&gt;<span class="number">128</span>-size1)  <span class="comment">//换行</span></span><br><span class="line">		&#123;</span><br><span class="line">			x=<span class="number">0</span>;</span><br><span class="line">			y+=<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		chr++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//m^n</span></span><br><span class="line"><span class="function">u32 <span class="title">OLED_Pow</span><span class="params">(u8 m,u8 n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u32 result=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span>(n--)</span><br><span class="line">	&#123;</span><br><span class="line">	  result*=m;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////显示2个数字</span></span><br><span class="line"><span class="comment">////x,y :起点坐标	 </span></span><br><span class="line"><span class="comment">////len :数字的位数</span></span><br><span class="line"><span class="comment">////size:字体大小</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ShowNum</span><span class="params">(u8 x,u8 y,u32 num,u8 len,u8 size1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 t,temp;</span><br><span class="line">	<span class="keyword">for</span>(t=<span class="number">0</span>;t&lt;len;t++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp=(num/OLED_Pow(<span class="number">10</span>,len-t<span class="number">-1</span>))%<span class="number">10</span>;</span><br><span class="line">			<span class="keyword">if</span>(temp==<span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				OLED_ShowChar(x+(size1/<span class="number">2</span>)*t,y,<span class="string">&#x27;0&#x27;</span>,size1);</span><br><span class="line">      &#125;</span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line">			&#123;</span><br><span class="line">			  OLED_ShowChar(x+(size1/<span class="number">2</span>)*t,y,temp+<span class="string">&#x27;0&#x27;</span>,size1);</span><br><span class="line">			&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示汉字</span></span><br><span class="line"><span class="comment">//x,y:起点坐标</span></span><br><span class="line"><span class="comment">//num:汉字对应的序号</span></span><br><span class="line"><span class="comment">//取模方式 列行式</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ShowChinese</span><span class="params">(u8 x,u8 y,u8 num,u8 size1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,m,n=<span class="number">0</span>,temp,chr1;</span><br><span class="line">	u8 x0=x,y0=y;</span><br><span class="line">	u8 size3=size1/<span class="number">8</span>;</span><br><span class="line">	<span class="keyword">while</span>(size3--)</span><br><span class="line">	&#123;</span><br><span class="line">		chr1=num*size1/<span class="number">8</span>+n;</span><br><span class="line">		n++;</span><br><span class="line">			<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;size1;i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(size1==<span class="number">16</span>)</span><br><span class="line">						&#123;temp=Hzk1[chr1][i];&#125;<span class="comment">//调用16*16字体</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(size1==<span class="number">24</span>)</span><br><span class="line">						&#123;temp=Hzk2[chr1][i];&#125;<span class="comment">//调用24*24字体</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(size1==<span class="number">32</span>)       </span><br><span class="line">						&#123;temp=Hzk3[chr1][i];&#125;<span class="comment">//调用32*32字体</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(size1==<span class="number">64</span>)</span><br><span class="line">						&#123;temp=Hzk4[chr1][i];&#125;<span class="comment">//调用64*64字体</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">							</span><br><span class="line">						<span class="keyword">for</span>(m=<span class="number">0</span>;m&lt;<span class="number">8</span>;m++)</span><br><span class="line">							&#123;</span><br><span class="line">								<span class="keyword">if</span>(temp&amp;<span class="number">0x01</span>)OLED_DrawPoint(x,y);</span><br><span class="line">								<span class="keyword">else</span> OLED_ClearPoint(x,y);</span><br><span class="line">								temp&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">								y++;</span><br><span class="line">							&#125;</span><br><span class="line">							x++;</span><br><span class="line">							<span class="keyword">if</span>((x-x0)==size1)</span><br><span class="line">							&#123;x=x0;y0=y0+<span class="number">8</span>;&#125;</span><br><span class="line">							y=y0;</span><br><span class="line">			 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//num 显示汉字的个数</span></span><br><span class="line"><span class="comment">//space 每一遍显示的间隔</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ScrollDisplay</span><span class="params">(u8 num,u8 space)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 i,n,t=<span class="number">0</span>,m=<span class="number">0</span>,r;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(m==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">	    OLED_ShowChinese(<span class="number">128</span>,<span class="number">24</span>,t,<span class="number">16</span>); <span class="comment">//写入一个汉字保存在OLED_GRAM[][]数组中</span></span><br><span class="line">			t++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(t==num)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span>(r=<span class="number">0</span>;r&lt;<span class="number">16</span>*space;r++)      <span class="comment">//显示间隔</span></span><br><span class="line">				 &#123;</span><br><span class="line">					<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">144</span>;i++)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">for</span>(n=<span class="number">0</span>;n&lt;<span class="number">8</span>;n++)</span><br><span class="line">							&#123;</span><br><span class="line">								OLED_GRAM[i<span class="number">-1</span>][n]=OLED_GRAM[i][n];</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">           OLED_Refresh();</span><br><span class="line">				 &#125;</span><br><span class="line">        t=<span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">		m++;</span><br><span class="line">		<span class="keyword">if</span>(m==<span class="number">16</span>)&#123;m=<span class="number">0</span>;&#125;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">144</span>;i++)   <span class="comment">//实现左移</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(n=<span class="number">0</span>;n&lt;<span class="number">8</span>;n++)</span><br><span class="line">			&#123;</span><br><span class="line">				OLED_GRAM[i<span class="number">-1</span>][n]=OLED_GRAM[i][n];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		OLED_Refresh();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置写入数据的起始位置</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_WR_BP</span><span class="params">(u8 x,u8 y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	OLED_WR_Byte(<span class="number">0xb0</span>+y,OLED_CMD);<span class="comment">//设置行起始地址</span></span><br><span class="line">	OLED_WR_Byte(((x&amp;<span class="number">0xf0</span>)&gt;&gt;<span class="number">4</span>)|<span class="number">0x10</span>,OLED_CMD);</span><br><span class="line">	OLED_WR_Byte((x&amp;<span class="number">0x0f</span>),OLED_CMD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//x0,y0：起点坐标</span></span><br><span class="line"><span class="comment">//x1,y1：终点坐标</span></span><br><span class="line"><span class="comment">//BMP[]：要写入的图片数组</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ShowPicture</span><span class="params">(u8 x0,u8 y0,u8 x1,u8 y1,u8 BMP[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u32 j=<span class="number">0</span>;</span><br><span class="line">	u8 x=<span class="number">0</span>,y=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(y%<span class="number">8</span>==<span class="number">0</span>)y=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span> y+=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(y=y0;y&lt;y1;y++)</span><br><span class="line">	 &#123;</span><br><span class="line">		 OLED_WR_BP(x0,y);</span><br><span class="line">		 <span class="keyword">for</span>(x=x0;x&lt;x1;x++)</span><br><span class="line">		 &#123;</span><br><span class="line">			 OLED_WR_Byte(BMP[j],OLED_DATA);</span><br><span class="line">			 j++;</span><br><span class="line">     &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//OLED的初始化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef  GPIO_InitStructure;</span><br><span class="line"> 	</span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);	 <span class="comment">//使能A端口时钟</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_12|GPIO_Pin_13|GPIO_Pin_14|GPIO_Pin_15;</span><br><span class="line"> 	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; 		 <span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;<span class="comment">//速度50MHz</span></span><br><span class="line"> 	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);	  <span class="comment">//初始化GPIOD3,6</span></span><br><span class="line"> 	GPIO_SetBits(GPIOB,GPIO_Pin_0|GPIO_Pin_1|GPIO_Pin_8);</span><br><span class="line">	</span><br><span class="line">	OLED_RST_Set();</span><br><span class="line">	delay_ms(<span class="number">100</span>);</span><br><span class="line">	OLED_RST_Clr();<span class="comment">//复位</span></span><br><span class="line">	delay_ms(<span class="number">200</span>);</span><br><span class="line">	OLED_RST_Set();</span><br><span class="line">	</span><br><span class="line">	OLED_WR_Byte(<span class="number">0xAE</span>,OLED_CMD);<span class="comment">//--turn off oled panel</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x00</span>,OLED_CMD);<span class="comment">//---set low column address</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x10</span>,OLED_CMD);<span class="comment">//---set high column address</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x40</span>,OLED_CMD);<span class="comment">//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x81</span>,OLED_CMD);<span class="comment">//--set contrast control register</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xCF</span>,OLED_CMD);<span class="comment">// Set SEG Output Current Brightness</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xA1</span>,OLED_CMD);<span class="comment">//--Set SEG/Column Mapping     0xa0左右反置 0xa1正常</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xC8</span>,OLED_CMD);<span class="comment">//Set COM/Row Scan Direction   0xc0上下反置 0xc8正常</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xA6</span>,OLED_CMD);<span class="comment">//--set normal display</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xA8</span>,OLED_CMD);<span class="comment">//--set multiplex ratio(1 to 64)</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x3f</span>,OLED_CMD);<span class="comment">//--1/64 duty</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xD3</span>,OLED_CMD);<span class="comment">//-set display offset	Shift Mapping RAM Counter (0x00~0x3F)</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x00</span>,OLED_CMD);<span class="comment">//-not offset</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xd5</span>,OLED_CMD);<span class="comment">//--set display clock divide ratio/oscillator frequency</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x80</span>,OLED_CMD);<span class="comment">//--set divide ratio, Set Clock as 100 Frames/Sec</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xD9</span>,OLED_CMD);<span class="comment">//--set pre-charge period</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xF1</span>,OLED_CMD);<span class="comment">//Set Pre-Charge as 15 Clocks &amp; Discharge as 1 Clock</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xDA</span>,OLED_CMD);<span class="comment">//--set com pins hardware configuration</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x12</span>,OLED_CMD);</span><br><span class="line">	OLED_WR_Byte(<span class="number">0xDB</span>,OLED_CMD);<span class="comment">//--set vcomh</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x40</span>,OLED_CMD);<span class="comment">//Set VCOM Deselect Level</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x20</span>,OLED_CMD);<span class="comment">//-Set Page Addressing Mode (0x00/0x01/0x02)</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x02</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x8D</span>,OLED_CMD);<span class="comment">//--set Charge Pump enable/disable</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0x14</span>,OLED_CMD);<span class="comment">//--set(0x10) disable</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xA4</span>,OLED_CMD);<span class="comment">// Disable Entire Display On (0xa4/0xa5)</span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xA6</span>,OLED_CMD);<span class="comment">// Disable Inverse Display On (0xa6/a7) </span></span><br><span class="line">	OLED_WR_Byte(<span class="number">0xAF</span>,OLED_CMD);</span><br><span class="line">	OLED_Clear();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	OLED_Init();</span><br><span class="line">	OLED_ColorTurn(<span class="number">0</span>);<span class="comment">//0正常显示，1 反色显示</span></span><br><span class="line">  OLED_DisplayTurn(<span class="number">0</span>);<span class="comment">//0正常显示 1 屏幕翻转显示</span></span><br><span class="line">	OLED_Refresh();</span><br><span class="line">&#125;</span><br><span class="line">u8 tmpp=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OLED_ShowData</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	OLED_ShowString(<span class="number">0</span>,<span class="number">0</span>,<span class="string">&quot;Thr:&quot;</span>,<span class="number">12</span>);</span><br><span class="line">	OLED_ShowNum(<span class="number">40</span>,<span class="number">0</span>,Remote.thr,<span class="number">4</span>,<span class="number">12</span>);</span><br><span class="line">	OLED_ShowString(<span class="number">0</span>,<span class="number">15</span>,<span class="string">&quot;Yaw:&quot;</span>,<span class="number">12</span>);</span><br><span class="line">	OLED_ShowNum(<span class="number">40</span>,<span class="number">15</span>,Remote.yaw,<span class="number">4</span>,<span class="number">12</span>);</span><br><span class="line">	OLED_ShowString(<span class="number">0</span>,<span class="number">30</span>,<span class="string">&quot;L&amp;R:&quot;</span>,<span class="number">12</span>);</span><br><span class="line">	OLED_ShowNum(<span class="number">40</span>,<span class="number">30</span>,Remote.pitch,<span class="number">4</span>,<span class="number">12</span>);</span><br><span class="line">	OLED_ShowString(<span class="number">0</span>,<span class="number">45</span>,<span class="string">&quot;F&amp;B:&quot;</span>,<span class="number">12</span>);</span><br><span class="line">	OLED_ShowNum(<span class="number">40</span>,<span class="number">45</span>,Remote.roll,<span class="number">4</span>,<span class="number">12</span>);</span><br><span class="line">	</span><br><span class="line">	OLED_Refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Remote.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x.h&quot;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;remote.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ADC_DMA_Config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;systick.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nrf24l01.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;eeprom.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;usart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Beep.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">__align(<span class="number">4</span>) _st_Remote Remote=&#123;<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">key</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">uint16_t</span> styb;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> //校准数据</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int16_t</span> flag;		<span class="comment">//校准标志位</span></span><br><span class="line">	<span class="keyword">int16_t</span> roll;</span><br><span class="line">	<span class="keyword">int16_t</span> pitch;	</span><br><span class="line">	<span class="keyword">int16_t</span> thr;	</span><br><span class="line">	<span class="keyword">int16_t</span> yaw;	</span><br><span class="line">&#125;offset ;</span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">函数原型：</span></span><br><span class="line"><span class="comment">功    能：	按键初始化</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">key_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	</span><br><span class="line">	AFIO-&gt;MAPR = <span class="number">0X02000000</span>;   <span class="comment">//使用四线SWD下载程序</span></span><br><span class="line">	RCC_APB2PeriphClockCmd( RCC_APB2Periph_GPIOB , ENABLE);</span><br><span class="line">	</span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3|GPIO_Pin_4|GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7|GPIO_Pin_8;    </span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;    <span class="comment">//上拉输入</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line"></span><br><span class="line">	GPIO_Init(GPIOB, &amp;GPIO_InitStructure);	</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">函数原型：</span></span><br><span class="line"><span class="comment">功    能：	校准数据初始化</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RC_INIT</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	offset.flag = *(<span class="keyword">int16_t</span>*)FLASH_Start_Addr;   <span class="comment">//读出存储的数据</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(offset.flag != <span class="number">0x0066</span>) <span class="comment">//检查是否有校准数据 改变</span></span><br><span class="line">	&#123;</span><br><span class="line">		delay_ms(<span class="number">1000</span>);</span><br><span class="line">		offset.roll = <span class="number">500</span>- (<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">0</span>]);<span class="comment">//方向;</span></span><br><span class="line">		offset.pitch = (<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">1</span>]) <span class="number">-500</span>;<span class="comment">//方向</span></span><br><span class="line">		</span><br><span class="line">		offset.thr = (<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">3</span>]);<span class="comment">//油门;</span></span><br><span class="line">		offset.yaw = <span class="number">500</span>- (<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">2</span>]);<span class="comment">//偏航</span></span><br><span class="line">		offset.flag = <span class="number">0x0066</span>;</span><br><span class="line">    </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;offset thr: %d   offset pitch: %d   offset yaw: %d   offset roll: %d \r\n&quot;</span>,offset.thr,offset.pitch,offset.yaw,offset.roll);  <span class="comment">//串口1输出2个摇杆数据		</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(offset.thr &lt;= <span class="number">1</span>)  <span class="comment">//判断油门打最低才存储摇杆值  不然存储了就解锁不了飞机</span></span><br><span class="line">	  &#123;</span><br><span class="line">			FLASH_write((<span class="keyword">int16_t</span> *)&amp;offset,<span class="number">5</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">			offset.roll = *((<span class="keyword">int16_t</span>*)FLASH_Start_Addr+<span class="number">1</span>);</span><br><span class="line">			offset.pitch = *((<span class="keyword">int16_t</span>*)FLASH_Start_Addr+<span class="number">2</span>);</span><br><span class="line">			offset.thr = *((<span class="keyword">int16_t</span>*)FLASH_Start_Addr+<span class="number">3</span>);</span><br><span class="line">			offset.yaw = *((<span class="keyword">int16_t</span>*)FLASH_Start_Addr+<span class="number">4</span>);</span><br><span class="line">		</span><br><span class="line">		  </span><br><span class="line">	&#125;</span><br><span class="line">	key_init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">函数原型：</span></span><br><span class="line"><span class="comment">功    能：	10ms发送一次数据，每个通道都是高位在前低位在后</span></span><br><span class="line"><span class="comment">通信协议：</span></span><br><span class="line"><span class="comment">起始帧0XAA,0XAF + 地址帧 0X03 + 数据长度 + 12个遥控数据 + 校验字节</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span> </span><br><span class="line"><span class="keyword">uint8_t</span> tx_data[<span class="number">32</span>] = &#123;<span class="number">0xAA</span>,<span class="number">0xAF</span>,<span class="number">0x03</span>,<span class="number">32</span><span class="number">-5</span>&#125;;<span class="comment">//匿名通信协议</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NRF_SEND</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">uint8_t</span> i=<span class="number">4</span>;i&lt;<span class="number">26</span>;i+=<span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		tx_data[i] = *((<span class="keyword">uint8_t</span>*)&amp;Remote+i<span class="number">-3</span>);	 <span class="comment">//高位在前</span></span><br><span class="line">		tx_data[<span class="number">31</span>] += tx_data[i];</span><br><span class="line">		tx_data[i+<span class="number">1</span>] = *((<span class="keyword">uint8_t</span>*)&amp;Remote+i<span class="number">-4</span>);	</span><br><span class="line">		tx_data[<span class="number">31</span>] += tx_data[i];</span><br><span class="line">	&#125;</span><br><span class="line">	tx_data[<span class="number">31</span>] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">uint8_t</span> i=<span class="number">0</span>;i&lt;<span class="number">31</span>;i++)  <span class="comment">//校验位</span></span><br><span class="line">		&#123;</span><br><span class="line">			tx_data[<span class="number">31</span>] +=  tx_data[i];</span><br><span class="line">		&#125;</span><br><span class="line">	NRF24L01_TxPacket((<span class="keyword">uint8_t</span>*)&amp;tx_data); <span class="comment">//调用NRF发射数据</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">函数原型：</span></span><br><span class="line"><span class="comment">功    能：	遥控数据解析   左油门程序</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RC_Analy</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">//10ms调用一次</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">uint16_t</span> last_thr,last_roll,last_pitch,last_yaw;</span><br><span class="line"></span><br><span class="line">	Remote.thr = (<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">3</span>])+<span class="number">1000</span> + offset.thr;<span class="comment">//油门</span></span><br><span class="line">	last_thr = Remote.thr = Remote.thr*<span class="number">0.25f</span> + <span class="number">0.75f</span>*last_thr;</span><br><span class="line">	Remote.pitch 	= 	<span class="number">1000</span> + (<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">1</span>]) + offset.pitch;<span class="comment">//</span></span><br><span class="line">	last_pitch = Remote.pitch = Remote.pitch*<span class="number">0.25f</span> + <span class="number">0.75f</span>*last_pitch;</span><br><span class="line">	Remote.yaw 		= 	<span class="number">1000</span> + (<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">2</span>]) + offset.yaw;<span class="comment">//方向</span></span><br><span class="line">			<span class="keyword">if</span>(Remote.yaw&gt;<span class="number">1500</span>)		<span class="comment">//把大数转换为小数</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Remote.yaw&gt;<span class="number">1999</span>)</span><br><span class="line">			&#123;</span><br><span class="line">			  Remote.yaw=<span class="number">1005</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line">			&#123;</span><br><span class="line">				Remote.yaw=Remote.yaw<span class="number">-1500</span>;</span><br><span class="line">				Remote.yaw=<span class="number">1500</span>-Remote.yaw;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Remote.yaw&lt;<span class="number">1500</span>)	<span class="comment">//把小数转换为大数</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Remote.yaw&lt;<span class="number">1010</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Remote.yaw=<span class="number">2000</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">			   Remote.yaw=<span class="number">1500</span>-Remote.yaw;</span><br><span class="line">			   Remote.yaw=<span class="number">1500</span>+Remote.yaw;</span><br><span class="line">			&#125;	 </span><br><span class="line">		&#125;</span><br><span class="line">	last_yaw = Remote.yaw = Remote.yaw*<span class="number">0.25f</span> + <span class="number">0.75f</span>*last_yaw;</span><br><span class="line">	Remote.roll 	=	<span class="number">1000</span> +(<span class="keyword">uint16_t</span>)(<span class="number">0.25f</span>*ADC_ConvertedValue[<span class="number">0</span>]) + offset.roll;<span class="comment">//副翼</span></span><br><span class="line">		<span class="keyword">if</span>(Remote.roll&gt;<span class="number">1500</span>)		<span class="comment">//把大数转换为小数</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Remote.roll&gt;<span class="number">1999</span>)</span><br><span class="line">			&#123;</span><br><span class="line">			  Remote.roll=<span class="number">1005</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line">			&#123;</span><br><span class="line">				Remote.roll=Remote.roll<span class="number">-1500</span>;</span><br><span class="line">				Remote.roll=<span class="number">1500</span>-Remote.roll;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Remote.roll&lt;<span class="number">1500</span>)	<span class="comment">//把小数转换为大数</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Remote.roll&lt;<span class="number">1010</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Remote.roll=<span class="number">2000</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">			   Remote.roll=<span class="number">1500</span>-Remote.roll;</span><br><span class="line">			   Remote.roll=<span class="number">1500</span>+Remote.roll;</span><br><span class="line">			&#125;	 </span><br><span class="line">		&#125;</span><br><span class="line">	last_roll = Remote.roll = Remote.roll*<span class="number">0.25f</span> + <span class="number">0.75f</span>*last_roll;</span><br><span class="line">	styb++;</span><br><span class="line">	<span class="keyword">if</span>(styb &gt;= <span class="number">200</span>)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;前后: %d   左右: %d   航向: %d   油门: %d \r\n&quot;</span>,Remote.pitch,Remote.roll,Remote.yaw,Remote.thr);  <span class="comment">//串口1输出2个摇杆数据</span></span><br><span class="line">		styb=<span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	key();<span class="comment">//扫描按键</span></span><br><span class="line">	NRF_SEND();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************</span></span><br><span class="line"><span class="comment">函数原型：</span></span><br><span class="line"><span class="comment">功    能：	按键扫描</span></span><br><span class="line"><span class="comment">*******************************************************************************/</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">key</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> KEY3 GPIO_Pin_3<span class="comment">//GPIOC</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> KEY4 GPIO_Pin_4<span class="comment">//GPIOC</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> KEY5 GPIO_Pin_5 <span class="comment">//GPIOA</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> KEY6 GPIO_Pin_6 <span class="comment">//GPIOA</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> KEY7 GPIO_Pin_7 <span class="comment">//GPIOB</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> KEY8 GPIO_Pin_8 <span class="comment">//GPIOB</span></span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">uint8_t</span> status = <span class="number">0</span>;	</span><br><span class="line"> 	<span class="keyword">static</span> <span class="keyword">uint32_t</span> temp;</span><br><span class="line">	<span class="keyword">switch</span>(status)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">if</span>(SysTick_count - temp &gt;<span class="number">20</span>) <span class="comment">//200ms 按键音</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(</span><br><span class="line">					((GPIOB-&gt;IDR &amp; (GPIO_Pin_3|GPIO_Pin_4|GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7|GPIO_Pin_8)) == (GPIO_Pin_3|GPIO_Pin_4|GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7|GPIO_Pin_8))					</span><br><span class="line">					)</span><br><span class="line">					status = <span class="number">1</span>;</span><br><span class="line">				BEEP_H;</span><br><span class="line">			  <span class="comment">//GPIO_SetBits(GPIOB,GPIO_Pin_10);</span></span><br><span class="line">				GPIO_ResetBits(GPIOB,GPIO_Pin_10);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			  <span class="keyword">if</span>(</span><br><span class="line">					((GPIOB-&gt;IDR &amp; (GPIO_Pin_3|GPIO_Pin_4|GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7|GPIO_Pin_8)) != (GPIO_Pin_3|GPIO_Pin_4|GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7|GPIO_Pin_8))					</span><br><span class="line">					)</span><br><span class="line">				status = <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:	</span><br><span class="line">				<span class="keyword">if</span>(!(GPIOB-&gt;IDR &amp; KEY6))</span><br><span class="line">			&#123;</span><br><span class="line">					offset.roll=offset.roll+<span class="number">5</span>;	</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(!(GPIOB-&gt;IDR &amp; KEY4))</span><br><span class="line">			&#123;</span><br><span class="line">					offset.roll=offset.roll<span class="number">-5</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(!(GPIOB-&gt;IDR &amp; KEY5))</span><br><span class="line">			&#123;</span><br><span class="line">					offset.pitch=offset.pitch<span class="number">-5</span>;	</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(!(GPIOB-&gt;IDR &amp; KEY3))</span><br><span class="line">			&#123;</span><br><span class="line">					offset.pitch=offset.pitch+<span class="number">5</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(!(GPIOB-&gt;IDR &amp; KEY7))</span><br><span class="line">			&#123;</span><br><span class="line">				offset.thr = <span class="number">0</span>;	</span><br><span class="line">				FLASH_write((<span class="keyword">int16_t</span> *)&amp;offset,<span class="number">5</span>);	</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(!(GPIOB-&gt;IDR &amp; KEY8))</span><br><span class="line">			&#123;</span><br><span class="line">					Remote.AUX7 ^= (<span class="number">2000</span>^<span class="number">1000</span>); <span class="comment">//1000和2000之间变化	  可以留来一键空翻</span></span><br><span class="line">			&#125;	</span><br><span class="line">			status = <span class="number">0</span>;			</span><br><span class="line">			BEEP_L;  </span><br><span class="line">			<span class="comment">//GPIO_ResetBits(GPIOB,GPIO_Pin_10);</span></span><br><span class="line">			GPIO_SetBits(GPIOB,GPIO_Pin_10);</span><br><span class="line">			temp = SysTick_count;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;			</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>delay.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32f10x.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;misc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;systick.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">uint32_t</span> usTicks = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> TimeDelay=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cycleCounterInit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RCC_ClocksTypeDef clocks;</span><br><span class="line">    RCC_GetClocksFreq(&amp;clocks);</span><br><span class="line">    usTicks = clocks.SYSCLK_Frequency / <span class="number">1000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay_ms</span><span class="params">(<span class="keyword">uint16_t</span> nTime)</span> <span class="comment">//    毫秒级延时函数	 </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TimeDelay=nTime;</span><br><span class="line">	<span class="keyword">while</span>(TimeDelay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Usart.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;usart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;misc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 函数名：USART1_Config</span></span><br><span class="line"><span class="comment"> * 描述  ：USART1 GPIO 配置,工作模式配置。</span></span><br><span class="line"><span class="comment"> * 输入  ：无</span></span><br><span class="line"><span class="comment"> * 输出  : 无</span></span><br><span class="line"><span class="comment"> * 调用  ：外部调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART1_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line">	NVIC_InitTypeDef NVIC_InitStructure; </span><br><span class="line">	<span class="comment">/* 配置串口1 （USART1） 时钟*/</span></span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1 | RCC_APB2Periph_GPIOA, ENABLE);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Configure the NVIC Preemption Priority Bits */</span>  </span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 使能串口1中断 */</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;	<span class="comment">//USART1  串口1全局中断 </span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = <span class="number">0</span>;<span class="comment">//抢占优先级1</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = <span class="number">0</span>; <span class="comment">//子优先级1</span></span><br><span class="line">	<span class="comment">/*IRQ通道使能*/</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;</span><br><span class="line">	<span class="comment">/*根据NVIC_InitStruct中指定的参数初始化外设NVIC寄存器USART1*/</span></span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*串口GPIO端口配置*/</span></span><br><span class="line">  <span class="comment">/* 配置串口1 （USART1 Tx (PA.09)）*/</span></span><br><span class="line">	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9;</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;</span><br><span class="line">	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">  </span><br><span class="line">	<span class="comment">/* 配置串口1 USART1 Rx (PA.10)*/</span></span><br><span class="line">  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;</span><br><span class="line">	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;</span><br><span class="line">	GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//USART 初始化设置</span></span><br><span class="line">	USART_InitStructure.USART_BaudRate =<span class="number">115200</span>;<span class="comment">//串口波特率</span></span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;<span class="comment">//字长为8位数据格式</span></span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;<span class="comment">//一个停止位</span></span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;<span class="comment">//无奇偶校验位</span></span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;<span class="comment">//无硬件数据流控制</span></span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Tx;<span class="comment">//|USART_Mode_Rx | ;	//发模式</span></span><br><span class="line">	USART_Init(USART1, &amp;USART_InitStructure);</span><br><span class="line">	</span><br><span class="line"><span class="comment">//	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);//开启中断</span></span><br><span class="line">	</span><br><span class="line">	USART_Cmd(USART1, ENABLE); <span class="comment">//使能串口 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART1_SendByte</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int8_t</span> *Data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="keyword">uint8_t</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (!(USART1-&gt;SR &amp; USART_FLAG_TXE));	 <span class="comment">// while(USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET)</span></span><br><span class="line">		USART_SendData(USART1,*(Data+i));	 </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART3_SendByte</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int8_t</span> *Data,<span class="keyword">uint8_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="keyword">uint8_t</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (!(USART3-&gt;SR &amp; USART_FLAG_TXE));	 <span class="comment">// while(USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET)</span></span><br><span class="line">		USART_SendData(USART3,*(Data+i));	 </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int8_t</span> CheckSend[<span class="number">7</span>]=&#123;<span class="number">0xAA</span>,<span class="number">0XAA</span>,<span class="number">0xEF</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART1_setBaudRate</span><span class="params">(<span class="keyword">uint32_t</span> baudRate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line">	USART_InitStructure.USART_BaudRate =  baudRate;</span><br><span class="line">	USART_Init(USART1, &amp;USART_InitStructure);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 函数名：fputc</span></span><br><span class="line"><span class="comment"> * 描述  ：重定向c库函数printf到USART1</span></span><br><span class="line"><span class="comment"> * 输入  ：无</span></span><br><span class="line"><span class="comment"> * 输出  ：无</span></span><br><span class="line"><span class="comment"> * 调用  ：由printf调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fputc</span><span class="params">(<span class="keyword">int</span> ch, FILE *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* 将Printf内容发往串口 */</span></span><br><span class="line">	USART_SendData(USART1, (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch);</span><br><span class="line">	<span class="keyword">while</span>( USART_GetFlagStatus(USART1,USART_FLAG_TC)!= SET);	</span><br><span class="line">	<span class="keyword">return</span> (ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/STM32/">STM32</a></div><div class="post_share"><div class="social-share" data-image="https://s3.ax1x.com/2021/03/08/6ltOC8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2018/02/27/VMware%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85%E9%BB%91%E8%8B%B9%E6%9E%9C/"><img class="prev-cover" src="https://s3.ax1x.com/2020/12/08/rpaaYF.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">VMware虚拟机安装黑苹果</div></div></a></div><div class="next-post pull-right"><a href="/2017/12/20/%E6%A8%A1%E7%94%B5%E5%A4%8D%E4%B9%A02/"><img class="next-cover" src="https://s1.ax1x.com/2020/09/30/0KC8L6.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">模电复习2</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/01/04/DIY STM32F103ZET6开发板/" title="DIY STM32F103ZET6开发板"><img class="cover" src="https://s3.ax1x.com/2021/03/08/6lU0m9.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-04</div><div class="title">DIY STM32F103ZET6开发板</div></div></a></div><div><a href="/2018/03/04/DIY STM32平衡小车/" title="DIY STM32平衡小车"><img class="cover" src="https://s3.ax1x.com/2021/03/08/6lGgN8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-04</div><div class="title">DIY STM32平衡小车</div></div></a></div><div><a href="/2017/09/20/stm32基础（基于正点原子探索者开发板库函数）/" title="STM32基础（基于正点原子探索者开发板库函数）"><img class="cover" src="https://s3.ax1x.com/2021/03/08/6lny7Q.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-09-20</div><div class="title">STM32基础（基于正点原子探索者开发板库函数）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://s1.ax1x.com/2020/05/01/Jje1fS.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Tangle</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/letanga"><i class="fab fa-github"></i><span>关注 Follow</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/letanga" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:247022864@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://blog.csdn.net/lemea" target="_blank" title="CSDN博客"><i class="fas fa-blog"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">这是我的个人博客<br>如果IE或其他浏览器显示混乱需要更换浏览器</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A3%9E%E6%9C%BA%E9%83%A8%E5%88%86"><span class="toc-number">1.</span> <span class="toc-text"> 飞机部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text"> 硬件设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B5%E6%BA%90%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 电源设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stm32%E4%B8%BB%E6%8E%A7"><span class="toc-number">1.1.2.</span> <span class="toc-text"> STM32主控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mpu6050"><span class="toc-number">1.1.3.</span> <span class="toc-text"> MPU6050</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B5%E6%9C%BA%E6%8E%A7%E5%88%B6"><span class="toc-number">1.1.4.</span> <span class="toc-text"> 电机控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%93%9D%E7%89%99-24g"><span class="toc-number">1.1.5.</span> <span class="toc-text"> 蓝牙、2.4G</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97"><span class="toc-number">1.1.6.</span> <span class="toc-text"> 其他模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bom%E8%A1%A8"><span class="toc-number">1.1.7.</span> <span class="toc-text"> BOM表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text"> 软件设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%A5%E6%8E%A7%E5%99%A8%E9%83%A8%E5%88%86"><span class="toc-number">2.</span> <span class="toc-text"> 遥控器部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E8%AE%BE%E8%AE%A1-2"><span class="toc-number">2.1.</span> <span class="toc-text"> 硬件设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%B5%E6%BA%90%E8%AE%BE%E8%AE%A1-2"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 电源设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stm32%E4%B8%BB%E6%8E%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.1.2.</span> <span class="toc-text"> STM32主控设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%91%87%E6%9D%86%E7%94%B5%E8%B7%AF%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.1.3.</span> <span class="toc-text"> 摇杆电路设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#681lsejpg"><span class="toc-number">2.1.4.</span> <span class="toc-text"> </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#24g-oled%E7%AD%89%E5%85%B6%E4%BB%96%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.1.5.</span> <span class="toc-text"> 2.4G、OLED等其他模块设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bom%E8%A1%A8-2"><span class="toc-number">2.1.6.</span> <span class="toc-text"> BOM表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1-2"><span class="toc-number">2.2.</span> <span class="toc-text"> 软件设计</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/01/04/DIY%20STM32F103ZET6%E5%BC%80%E5%8F%91%E6%9D%BF/" title="DIY STM32F103ZET6开发板"><img src="https://s3.ax1x.com/2021/03/08/6lU0m9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DIY STM32F103ZET6开发板"/></a><div class="content"><a class="title" href="/2021/01/04/DIY%20STM32F103ZET6%E5%BC%80%E5%8F%91%E6%9D%BF/" title="DIY STM32F103ZET6开发板">DIY STM32F103ZET6开发板</a><time datetime="2021-01-04T07:33:19.000Z" title="发表于 2021-01-04 15:33:19">2021-01-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/09/03/%E5%8D%8E%E7%A1%95UX433FN%E5%AE%89%E8%A3%85Win%E9%BB%91%E8%8B%B9%E6%9E%9C%E5%8F%8C%E7%B3%BB%E7%BB%9F/" title="华硕UX433FN安装Win黑苹果双系统"><img src="https://s3.ax1x.com/2020/12/08/rpaaYF.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="华硕UX433FN安装Win黑苹果双系统"/></a><div class="content"><a class="title" href="/2020/09/03/%E5%8D%8E%E7%A1%95UX433FN%E5%AE%89%E8%A3%85Win%E9%BB%91%E8%8B%B9%E6%9E%9C%E5%8F%8C%E7%B3%BB%E7%BB%9F/" title="华硕UX433FN安装Win黑苹果双系统">华硕UX433FN安装Win黑苹果双系统</a><time datetime="2020-09-03T06:09:17.000Z" title="发表于 2020-09-03 14:09:17">2020-09-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/05/12/Windows%20to%20go/" title="Windows to go"><img src="https://s1.ax1x.com/2020/10/09/0DpUIK.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows to go"/></a><div class="content"><a class="title" href="/2020/05/12/Windows%20to%20go/" title="Windows to go">Windows to go</a><time datetime="2020-05-12T11:26:13.000Z" title="发表于 2020-05-12 19:26:13">2020-05-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/04/12/Excel%E7%94%9F%E6%88%90CSV%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6/" title="Excel生成CSV格式文件"><img src="https://s1.ax1x.com/2020/10/26/BKSKvF.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Excel生成CSV格式文件"/></a><div class="content"><a class="title" href="/2020/04/12/Excel%E7%94%9F%E6%88%90CSV%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6/" title="Excel生成CSV格式文件">Excel生成CSV格式文件</a><time datetime="2020-04-12T10:36:13.000Z" title="发表于 2020-04-12 18:36:13">2020-04-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2018/11/03/DNS%E6%B1%A1%E6%9F%93%E9%97%AE%E9%A2%98/" title="DNS污染问题"><img src="https://s1.ax1x.com/2020/10/01/0K4kIU.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DNS污染问题"/></a><div class="content"><a class="title" href="/2018/11/03/DNS%E6%B1%A1%E6%9F%93%E9%97%AE%E9%A2%98/" title="DNS污染问题">DNS污染问题</a><time datetime="2018-11-03T10:12:30.000Z" title="发表于 2018-11-03 18:12:30">2018-11-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2021 By Tangle</div><div class="framework-info"><!-- span= _p('footer.framework') + ' '--><!-- a(href='https://hexo.io')= 'Hexo'--><!-- span.footer-separator |--><!-- span= _p('footer.theme') + ' '--><!-- a(href='https://github.com/jerryc127/hexo-theme-butterfly')= 'Butterfly'--></div><div class="footer_custom_text">Hi, welcome to my <a href="https://letanga.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 3000);</script></div><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'naJaIbSuo1stR1TBwyyAUJO0-gzGzoHsz',
      appKey: 'b8K2UcMoMjOg7RqUKXAuENHa',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="2780031324"  data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="auto" data-autoplay="false" muted></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener toc scroll 
  window.removeEventListener('scroll', window.tocScrollFn)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":250,"height":300},"mobile":{"show":true},"log":false});</script></body></html>